# S12 Web UI / API Gateway

## 概述

S12 Web UI / API Gateway 是 Project Chimera 交易系統的 Web 界面和 API 網關，提供統一的用戶界面和系統控制功能，包括資金劃轉、系統控制等關鍵操作。

## 功能

- **Web 界面**：提供交易系統的 Web 用戶界面
- **API 網關**：統一的外部 API 入口
- **系統控制**：Kill Switch 等系統控制功能
- **資金管理**：資金劃轉的對外接口
- **權限管理**：RBAC 權限控制
- **審計日誌**：完整的操作審計記錄

## API 接口

### 健康檢查

- `GET /health` - 服務健康狀態檢查
- `GET /ready` - 服務就緒狀態檢查

### 系統控制

- `POST /kill-switch` - 系統停機開關
- `POST /treasury/transfer` - 資金劃轉

#### Kill Switch

**請求**：
```json
{
  "enable": true
}
```

**回應**：
```json
{
  "enabled": true
}
```

#### Treasury Transfer

**請求**：
```json
{
  "from": "SPOT",
  "to": "FUT",
  "amount_usdt": 1000.0,
  "reason": "Trading capital allocation"
}
```

**回應**：
```json
{
  "transfer_id": "transfer_1640995200",
  "result": "OK",
  "message": "Transfer completed successfully"
}
```

## 服務間交互

### 入向（被呼叫）
- **前端應用** → `GET /health` - 健康檢查
- **管理員** → `POST /kill-switch` - 系統控制
- **用戶** → `POST /treasury/transfer` - 資金劃轉

### 出向（主動呼叫）
- **S10 Config Service** → 配置管理操作
- **S5 Reconciler** → 對帳操作
- **S6 Position Manager** → 持倉管理
- **S4 Order Router** → 訂單取消
- **S11 Metrics** → 指標和告警查詢
- **S1 Exchange** → 內部資金劃轉

## 系統控制功能

### Kill Switch
- **啟用**：設置全域停機旗標
- **禁用**：解除停機狀態
- **廣播**：向所有服務發送停機事件
- **持久化**：在 Redis/DB 中保存狀態

### 權限控制
- **RBAC**：基於角色的訪問控制
- **操作權限**：細粒度的操作權限
- **審計追蹤**：完整的操作記錄

## 資金劃轉功能

### 對外接口
- **參數驗證**：驗證劃轉參數
- **風控檢查**：執行風險控制檢查
- **冪等性**：生成冪等性鍵值
- **分散鎖**：避免併發衝突
- **審計記錄**：完整的操作日誌

### 內部委派
- **S1 Exchange** → 執行實際劃轉
- **幣安 API** → 調用交易所 API
- **重試機制**：處理失敗重試
- **錯誤處理**：統一的錯誤處理

## 審計與合規

### 操作審計
- **用戶追蹤**：記錄操作用戶
- **IP 追蹤**：記錄操作來源 IP
- **時間戳**：精確的操作時間
- **操作詳情**：完整的操作參數

### 合規要求
- **數據保留**：審計數據保留策略
- **隱私保護**：敏感數據保護
- **訪問控制**：審計數據訪問控制

## 前端集成

### Web 界面
- **儀表板**：系統狀態儀表板
- **交易界面**：交易操作界面
- **配置管理**：策略配置管理
- **監控告警**：系統監控告警

### API 文檔
- **Swagger**：自動生成的 API 文檔
- **交互式**：可交互的 API 測試
- **版本管理**：API 版本管理

## 安全特性

### 認證授權
- **JWT Token**：基於 JWT 的認證
- **會話管理**：安全的會話管理
- **權限驗證**：細粒度的權限驗證

### 安全防護
- **CORS**：跨域請求控制
- **Rate Limiting**：請求頻率限制
- **輸入驗證**：嚴格的輸入驗證
- **SQL 注入防護**：數據庫安全防護

## 配置

服務使用以下配置：
- Redis：用於會話管理和分散鎖
- ArangoDB：用於審計日誌存儲
- JWT 配置：認證和授權配置
- 端口：8092（可通過環境變量 PORT 覆蓋）

## 部署

```bash
# 構建
go build -o s12-ui .

# 運行
./s12-ui
```

## 監控

服務提供以下監控指標：
- API 響應時間
- 請求成功率
- 認證失敗率
- 權限檢查延遲
- 審計日誌寫入成功率
