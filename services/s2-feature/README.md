# S2 Feature Generator âŒ **[æœªå¯¦ä½œ]**

Feature Generator - Generate features from market data and signals

## ğŸ“‹ å¯¦ä½œé€²åº¦ï¼š20% (1/5 åŠŸèƒ½å®Œæˆ)

### âœ… å·²å®ŒæˆåŠŸèƒ½
- [x] åŸºç¤æœå‹™æ¶æ§‹
- [x] Health Check API
- [x] ç‰¹å¾µè¨ˆç®—å™¨æ¡†æ¶ï¼ˆATRã€RVã€ç›¸é—œæ€§ã€æ·±åº¦ï¼‰
- [x] ç‰¹å¾µå¿«å–æ©Ÿåˆ¶
- [x] ä»»å‹™ç®¡ç†ç³»çµ±

### âŒ å¾…å¯¦ä½œåŠŸèƒ½

#### 1. æ¶ˆè²» `mkt:events:*`
- [ ] **å¸‚å ´æ•¸æ“šæ¶ˆè²»**
  - [ ] å¾ Redis Stream æ¶ˆè²»å¸‚å ´äº‹ä»¶
  - [ ] æ»‘çª—å¿«å– `feat:{cache}:<symbol>`
  - [ ] è®€å– `config_active.rev`
- [ ] **ç‰¹å¾µè¨ˆç®—**
  - [ ] ATR/RV/Ï/Spread/Depth ç­‰ç‰¹å¾µè¨ˆç®—
  - [ ] DQC æ¨™è¨˜ï¼ˆæ•¸æ“šè³ªé‡æª¢æŸ¥ï¼‰
- [ ] **DB å¯«å…¥**
  - [ ] `signals`ï¼ˆæ–°/è£œå¯« `features`ã€`t0`ã€`config_rev`ï¼‰
- [ ] **äº‹ä»¶ç™¼å¸ƒ**
  - [ ] `feat:events:<symbol>`ï¼ˆå« `signal_id,t0,symbol,features`ï¼‰

#### 2. æ¯æ—¥ Regimeï¼ˆæ’ç¨‹ï¼‰
- [ ] **Regime è¨ˆç®—**
  - [ ] RV ç™¾åˆ†ä½è¨ˆç®—
  - [ ] æ¨™ç±¤ FROZEN/NORMAL/EXTREME
- [ ] **Redis KV å¯«å…¥**
  - [ ] `prod:{regime}:market:state`ï¼ˆå¸¶ `rev` èˆ‡éæœŸæ™‚é–“æˆ³ï¼‰
- [ ] **æŒ‡æ¨™æ”¶é›†**
  - [ ] `metrics:events:s2.regime_latency`

#### 3. POST /features/recompute
- [ ] **æœŸé–“æ•¸æ“šè®€å–**
  - [ ] æœŸé–“ K ç·š/æ·±åº¦ï¼ˆè³‡æ–™æ¹–/äº¤æ˜“æ‰€ï¼‰
- [ ] **ç‰¹å¾µè£œç®—**
  - [ ] è£œç®—ç‰¹å¾µé‚è¼¯
- [ ] **DB å¯«å…¥**
  - [ ] å›è£œ `signals.features`
  - [ ] å¯« `strategy_events(kind=FEATURE_RECOMPUTE)`

#### 4. Redis Stream æ•´åˆ
- [ ] **Redis Stream ç™¼å¸ƒ**
  - [ ] å¯¦ç¾å¯¦éš›çš„ Redis Stream ç™¼å¸ƒ
  - [ ] ç‰¹å¾µæ•¸æ“šåºåˆ—åŒ–
- [ ] **Redis æ¶ˆè²»**
  - [ ] å¾ `mkt:events:*` æ¶ˆè²»æ•¸æ“š

#### 5. é…ç½®ç®¡ç†
- [ ] **é…ç½®ç†±è¼‰**
  - [ ] ç›£è½ `cfg:events`
  - [ ] RCU ç†±è¼‰æ©Ÿåˆ¶
- [ ] **é…ç½®å¿«å–**
  - [ ] `config_active.rev` è®€å–å’Œå¿«å–

#### 6. æ ¸å¿ƒæ™‚åºåœ–ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼æ™‚åºåœ–å¯¦ä½œï¼‰
- [ ] **ä¿¡è™Ÿè§¸ç™¼æ©Ÿåˆ¶**
  - [ ] features.ready äº‹ä»¶ç”Ÿæˆ
  - [ ] Stream signals:new ç™¼å¸ƒ
  - [ ] ç‰¹å¾µè¨ˆç®—å®Œæˆé€šçŸ¥
- [ ] **ç‰¹å¾µæ•¸æ“šæº–å‚™**
  - [ ] ç‰¹å¾µæ•¸æ“šæ ¼å¼åŒ–å’Œé©—è­‰
  - [ ] config_rev ç‰ˆæœ¬æ¨™è¨˜
  - [ ] t0 æ™‚é–“æˆ³æ¨™è¨˜
- [ ] **äº‹ä»¶æµæ•´åˆ**
  - [ ] feat:events:{INSTR} Stream ç™¼å¸ƒ
  - [ ] ç‰¹å¾µæ•¸æ“šåºåˆ—åŒ–
  - [ ] äº‹ä»¶æ ¼å¼æ¨™æº–åŒ–
- [ ] **æ•¸æ“šè³ªé‡ä¿è­‰**
  - [ ] ç‰¹å¾µæ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥
  - [ ] ä¸å…è¨±æœªä¾†è³‡æ–™é©—è­‰
  - [ ] ç‰¹å¾µè¨ˆç®—éŒ¯èª¤è™•ç†

#### 7. æœå‹™èˆ‡è³‡æ–™æµç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼æœå‹™èˆ‡è³‡æ–™æµå¯¦ä½œï¼‰
- [ ] **ç‰¹å¾µå·¥ç¨‹ï¼ˆATR / RV / ç›¸é—œæ€§ / æ·±åº¦ï¼‰**
  - [ ] True Range è¨ˆç®—ï¼š`TR_t = max(H_t - L_t, |H_t - C_{t-1}|, |L_t - C_{t-1}|)`
  - [ ] ATR(n) Wilder è¨ˆç®—ï¼š`ATR_t = ATR_{t-1} + (TR_t - ATR_{t-1})/n`
  - [ ] log return è¨ˆç®—ï¼š`r_t = ln(P_t / P_{t-1})`
  - [ ] å¯¦ç¾æ³¢å‹•ç‡è¨ˆç®—ï¼š`rv_m = sqrt(252) * std(r_{t-m+1..t})`
  - [ ] rv åˆ†ä½è¨ˆç®—ï¼š`rv_pctile_30d = pctile(rv_1d, lookback=365d)`
  - [ ] USDT/TWDÃ—BTC ç›¸é—œæ€§ï¼š`rho_usdttwd_k = corr(r_btc, r_fx, window=k)`
  - [ ] æ·±åº¦å› å­ï¼š`liq_score = min(depth_top1_usdt / threshold, 1.0)`
- [ ] **å®šæ™‚ä»»å‹™**
  - [ ] æ¯ 1m/5m/1h/4h/1d æ»¾å‹•è¨ˆç®—
  - [ ] æ‰ç·šè£œç®—ä»»å‹™ï¼ˆè£œ K ç·šç¼ºå£ï¼‰
- [ ] **æ•¸æ“šè¼¸å‡º**
  - [ ] signals.featuresï¼ˆArangoDBï¼‰å¯«å…¥
  - [ ] Redis feat:last:{symbol} æ›´æ–°

#### 8. å®šæ™‚ä»»å‹™ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼å®šæ™‚ä»»å‹™å¯¦ä½œï¼‰
- [ ] **ç‰¹å¾µå›è£œï¼ˆæ¯å°æ™‚ / æ‰‹å‹•ï¼‰**
  - [ ] æƒæ `signals`ï¼Œç¯©å‡ºç‰¹å¾µç¼ºå¤±æˆ–éæœŸè¨˜éŒ„
  - [ ] å–å¾—æ­·å² K ç·š / æ·±åº¦ / è³‡é‡‘è²»ç­‰åŸå§‹æ•¸æ“š
  - [ ] é‡æ–°è¨ˆç®—ç‰¹å¾µå¯«å›ï¼›æ¨™è¨˜ DQC æ¬„ä½
  - [ ] True Rangeï¼š`TR_t = max{H_t-L_t, |H_t-C_{t-1}|, |L_t-C_{t-1}|}`
  - [ ] ATRï¼ˆEMA, åƒæ•¸ nï¼‰ï¼š`ATR_t = Î± * TR_t + (1-Î±) * ATR_{t-1}`ï¼Œ`Î± = 2/(n+1)`
  - [ ] å°æ•¸å ±é…¬ï¼š`r_t = ln(P_t / P_{t-1})`
  - [ ] å·²å¯¦ç¾æ³¢å‹•ç‡ï¼ˆN æœŸï¼‰ï¼š`RV_N = sqrt(K) * Ïƒ(r_{t-N+1..t})`ï¼ˆå¹´åŒ–å› å­ Kï¼šæ—¥ç·š sqrt(365)ï¼›4h ç·š â‰ˆ sqrt(6Ã—365)ï¼‰
  - [ ] çš®çˆ¾æ£®ç›¸é—œï¼ˆæ»‘çª— Mï¼‰ï¼š`Ï_XY = Î£(x-xÌ„)(y-È³) / sqrt(Î£(x-xÌ„)Â²) * sqrt(Î£(y-È³)Â²)`
- [ ] **å¸‚å ´ Regime æ›´æ–°ï¼ˆæ¯æ—¥ 00:05ï¼‰**
  - [ ] å–è¿‘ N æ—¥ RV åºåˆ—
  - [ ] è¨ˆç®—ç™¾åˆ†ä½åæ¬¡èˆ‡ Regimeï¼Œå¯«å…¥ `prod:regime:market:state`
  - [ ] ç™¾åˆ†ä½åæ¬¡ï¼ˆå« tiesï¼‰ï¼š`PctRank(X) = (C_L + 0.5 * C_E) / N`ï¼ˆC_Lï¼šå°æ–¼ Xï¼›C_Eï¼šç­‰æ–¼ Xï¼‰
  - [ ] åˆ†ç¾¤å»ºè­°ï¼š`pct < 0.10` â†’ FROZENï¼›`0.10 â‰¤ pct â‰¤ 0.90` â†’ NORMALï¼›`pct > 0.90` â†’ EXTREME

#### 9. ç›®æ¨™èˆ‡ç¯„åœç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼ç›®æ¨™èˆ‡ç¯„åœå¯¦ä½œï¼‰
- [ ] **å‰ç½®ä¾è³´å¯¦ä½œ**
  - [ ] ArangoDB Collectionsï¼š`signals`ã€`strategy_events`
  - [ ] Redis Streamsï¼š`feat:events:<symbol>`
  - [ ] Redis Keysï¼š`prod:{regime}:market:state`ï¼ˆæ¯æ—¥ï¼‰ã€`feat:{cache}:<symbol>`ï¼ˆæ»‘çª—å¿«å–ï¼‰
- [ ] **ç’°å¢ƒè®Šæ•¸é…ç½®**
  - [ ] `S2_DB_ARANGO_URI`ã€`S2_DB_ARANGO_USER/PASS`
  - [ ] `S2_REDIS_ADDRESSES`ï¼ˆé€—è™Ÿåˆ†éš”ï¼ŒCluster æ¨¡å¼ï¼‰
  - [ ] `S2_SYMBOLS`ï¼ˆé è¨­ï¼šBTCUSDTï¼Œå¯å¤šï¼‰
- [ ] **é¢¨éšªèˆ‡ç·©è§£**
  - [ ] Redis Cluster slot ç§»è½‰ï¼šä½¿ç”¨å®˜æ–¹ cluster clientï¼›é—œéµæ“ä½œå…·é‡è©¦ç­–ç•¥

#### 10. è·¯éçš„æœå‹™ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼è·¯éçš„æœå‹™å¯¦ä½œï¼‰
- [ ] **æ¶ˆè²» `mkt:events:*`**
  - [ ] è®€ï¼šæ»‘çª—å¿«å– `feat:{cache}:<symbol>`ã€`config_active.rev`
  - [ ] ç®—ï¼šATR/RV/Ï/Spread/Depth ç­‰ï¼›DQC æ¨™è¨˜
  - [ ] å¯« DBï¼š`signals`ï¼ˆæ–°/è£œå¯« `features`ã€`t0`ã€`config_rev`ï¼‰
  - [ ] ç™¼äº‹ä»¶ï¼š`feat:events:<symbol>`ï¼ˆå« `signal_id,t0,symbol,features`ï¼‰
- [ ] **æ¯æ—¥ Regimeï¼ˆæ’ç¨‹ï¼‰**
  - [ ] ç®—ï¼šRV ç™¾åˆ†ä½ï¼›æ¨™ç±¤ FROZEN/NORMAL/EXTREME
  - [ ] å¯« Redis KVï¼š`prod:{regime}:market:state`ï¼ˆå¸¶ `rev` èˆ‡éæœŸæ™‚é–“æˆ³ï¼‰
  - [ ] æŒ‡æ¨™ï¼š`metrics:events:s2.regime_latency`
- [ ] **POST /features/recompute**
  - [ ] è®€ï¼šæœŸé–“ K ç·š/æ·±åº¦ï¼ˆè³‡æ–™æ¹–/äº¤æ˜“æ‰€ï¼‰
  - [ ] ç®—ï¼šè£œç®—ç‰¹å¾µ
  - [ ] å¯« DBï¼šå›è£œ `signals.features`ï¼›å¯« `strategy_events(kind=FEATURE_RECOMPUTE)`

#### 11. å­—æ®µæ ¡é©—ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼å­—æ®µæ ¡é©—è¡¨å¯¦ä½œï¼‰
- [ ] **POST /features/recompute å­—æ®µæ ¡é©—**
  - [ ] `symbols[]`ï¼šå¿…å¡«ï¼Œâ‰¥1 å€‹ç¬¦è™Ÿï¼Œæ¯å€‹ç¬¦è™Ÿæ­£å‰‡ `^[A-Z0-9]{3,}$` é©—è­‰
  - [ ] `windows[]`ï¼šå¿…å¡«ï¼Œå€¼åŸŸå—é™ {1m, 5m, 1h, 4h, 1d} æšèˆ‰é©—è­‰
  - [ ] `force`ï¼šå¯é¸å¸ƒçˆ¾å€¼ï¼Œé è¨­ false
  - [ ] `from_ts`/`to_ts`ï¼šå¯é¸æ™‚é–“æˆ³ï¼Œç¯„åœ 1â€“90 å¤©é©—è­‰
- [ ] **FeatureRequest å­—æ®µæ ¡é©—**
  - [ ] `symbol`ï¼šå¿…å¡«ï¼Œæ­£å‰‡ `^[A-Z0-9]{3,}$` é©—è­‰
  - [ ] `config_rev`ï¼šå¯é¸ï¼ŒCURRENT æˆ–æ•´æ•¸é©—è­‰
  - [ ] `dry_run`ï¼šå¯é¸å¸ƒçˆ¾å€¼ï¼Œé è¨­ false
- [ ] **éŒ¯èª¤è™•ç†æ ¡é©—**
  - [ ] 400 Bad Requestï¼šæœªçŸ¥ windowã€symbols ç‚ºç©º
  - [ ] 422 Unprocessable Entityï¼šç‰¹å¾µç¼ºå¤±ã€æ•¸æ“šä¸å®Œæ•´
  - [ ] å†ªç­‰æ€§ï¼šç›¸åŒåƒæ•¸è¿”å›ç›¸åŒçµæœ
- [ ] **å¥‘ç´„æ¸¬è©¦**
  - [ ] åˆæ³• symbol/window â†’ `accepted`=true
  - [ ] æœªçŸ¥ window â†’ 400 éŒ¯èª¤
  - [ ] symbols ç‚ºç©º â†’ 400 éŒ¯èª¤
  - [ ] ç‰¹å¾µç¼ºå¤± â†’ 422 éŒ¯èª¤

#### 12. åŠŸèƒ½å°ç…§è£œè¨˜ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼åŠŸèƒ½å°ç…§è£œè¨˜å¯¦ä½œï¼‰
- [ ] **USDT/TWD Ã— BTCUSDT è¦å‰‡ä¿¡è™Ÿ**
  - [ ] è¨ˆç®—å…©è³‡ç”¢æ—¥å°æ•¸å ±é…¬ï¼š$r^{\text{usdttwd}}_t, r^{\text{btcusdt}}_t$
  - [ ] ä»¥å…©æ—¥åŒå‘ + é¦–æ—¥åå‘æ§‹é€ æ–¹å‘ï¼š
    - åšå¤šï¼š$r^{\text{usdttwd}}_{t-1}<0 \land r^{\text{usdttwd}}_{t-2}<0 \land r^{\text{btcusdt}}_{t-1}<0$
    - åšç©ºï¼š$r^{\text{usdttwd}}_{t-1}>0 \land r^{\text{usdttwd}}_{t-2}>0 \land r^{\text{btcusdt}}_{t-1}>0$
  - [ ] ç©©å¥æ¢ä»¶ï¼š$|\rho_{14}(\text{usdttwd},\text{btcusdt})|>\rho_{\min}$
- [ ] **ATR åœæï¼ˆRegime å€æ•¸ + é¢¨éšªä¸Šé™ï¼‰**
  - [ ] ç”¢å‡º $ATR_t$ èˆ‡ `Regime` âˆˆ {FROZEN, NORMAL, EXTREME}
  - [ ] å°æ‡‰å€æ•¸ $k_{\text{regime}}$ï¼›åˆå§‹åœæï¼ˆå¤šï¼‰ï¼š$SL_0=P_{entry}-k \cdot ATR$ï¼ˆç©ºç›¸åï¼‰
  - [ ] é¢¨éšªä¸Šé™ï¼šä¸å…è¨±é¦–ç­†æå¤±è¶…é $\text{RiskCapPct}$ çš„ä¿è­‰é‡‘
  - [ ] å…¬å¼ï¼š$SL = P_{entry} - dir \cdot \min\!\left(\frac{Loss_{cap}}{Q},\ k_{\text{regime}} \cdot ATR\right)$

#### 13. å…¨æœå‹™ä¸€è¦½ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼å…¨æœå‹™ä¸€è¦½å¯¦ä½œï¼‰
- [ ] **æ¶ˆè²» `mkt:events:*`**
  - [ ] è®€ï¼šæ»‘çª—å¿«å– `feat:{cache}:<symbol>`ã€`config_active.rev`
  - [ ] ç®—ï¼šATR/RV/Ï/Spread/Depth ç­‰ï¼›DQC æ¨™è¨˜
  - [ ] å¯« DBï¼š`signals`ï¼ˆæ–°/è£œå¯« `features`ã€`t0`ã€`config_rev`ï¼‰
  - [ ] ç™¼äº‹ä»¶ï¼š`feat:events:<symbol>`ï¼ˆ`signal_id,t0,symbol,features`ï¼‰
- [ ] **æ¯æ—¥ Regimeï¼ˆæ’ç¨‹ï¼‰**
  - [ ] ç®—ï¼šRV ç™¾åˆ†ä½ â†’ Regimeï¼ˆFROZEN/NORMAL/EXTREMEï¼‰
  - [ ] å¯« Redis KVï¼š`prod:{regime}:market:state`ï¼ˆå¸¶ `rev` å’ŒéæœŸæˆ³ï¼‰
  - [ ] æŒ‡æ¨™ï¼š`metrics:events:s2.regime_latency`
- [ ] **POST /features/recompute**
  - [ ] è®€ï¼šæœŸé–“ K ç·š/æ·±åº¦ï¼ˆè³‡æ–™æ¹–/äº¤æ˜“æ‰€ï¼‰
  - [ ] ç®—ï¼šè£œç®—ç‰¹å¾µ
  - [ ] å¯« DBï¼šå›è£œ `signals.features`ï¼›`strategy_events(kind=FEATURE_RECOMPUTE)`

#### 14. Integration é™„éŒ„ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼ Integration é™„éŒ„å¯¦ä½œï¼‰
- [ ] **ä¿¡è™Ÿäº‹ä»¶ç”Ÿæˆï¼ˆS2 â†’ S3ï¼‰**
  - [ ] ä¿¡è™Ÿäº‹ä»¶æ ¼å¼ï¼š`signal_id`ã€`symbol`ã€`t0`ã€`features`ã€`config_rev`
  - [ ] ç‰¹å¾µæ•¸æ“šï¼š`atr_14`ã€`volatility_30d`ã€`correlation_spx`ã€`rsi_14`ã€`macd_signal`
  - [ ] Redis Stream ç™¼å¸ƒï¼š`signals:new` äº‹ä»¶åˆ° Redis Stream
  - [ ] æ™‚é–“æˆ³çµ±ä¸€ï¼šä½¿ç”¨ epoch æ¯«ç§’ï¼ˆmsï¼‰æ ¼å¼
- [ ] **äº‹å‹™ä¸€è‡´æ€§ä¿è­‰**
  - [ ] å†ªç­‰æ€§ä¿è­‰ï¼šç‰¹å¾µè¨ˆç®—ä½¿ç”¨ `signal_id` ä½œç‚ºå†ªç­‰éµ
  - [ ] ç‹€æ…‹æ©Ÿç®¡ç†ï¼šç‰¹å¾µè¨ˆç®—ç‹€æ…‹ PENDING â†’ COMPUTED â†’ PUBLISHED
  - [ ] å¤±æ•—æ¢å¾©ï¼šç³»çµ±å´©æ½°å¾Œèƒ½å¤ é‡æ–°è¨ˆç®—ç‰¹å¾µ
- [ ] **æ€§èƒ½å„ªåŒ–**
  - [ ] ä¸¦è¡Œè™•ç†ï¼šå¤šå€‹ç¬¦è™Ÿçš„ç‰¹å¾µè¨ˆç®—ä¸¦è¡ŒåŸ·è¡Œ
  - [ ] ç·©å­˜æ©Ÿåˆ¶ï¼šç‰¹å¾µçµæœç·©å­˜é¿å…é‡è¤‡è¨ˆç®—
  - [ ] æ‰¹é‡è™•ç†ï¼šæ‰¹é‡ç™¼å¸ƒç‰¹å¾µäº‹ä»¶æé«˜æ•ˆç‡

#### 15. Hop-by-Hop åŸ·è¡Œè¦æ ¼ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼ Hop-by-Hop åŸ·è¡Œè¦æ ¼è£œéºå¯¦ä½œï¼‰
- [ ] **æ¶ˆè²» `mkt:events:*`**
  - [ ] è®€ï¼šæ»‘çª—å¿«å– `feat:{cache}:<symbol>`ã€`config_active.rev`
  - [ ] ç®—ï¼šATR/RV/Ï/Spread/Depth ç­‰ï¼›DQC æ¨™è¨˜
  - [ ] å¯« DBï¼š`signals`ï¼ˆæ–°/è£œå¯« `features`ã€`t0`ã€`config_rev`ï¼‰
  - [ ] ç™¼äº‹ä»¶ï¼š`feat:events:<symbol>`ï¼ˆ`signal_id,t0,symbol,features`ï¼‰
- [ ] **æ¯æ—¥ Regimeï¼ˆæ’ç¨‹ï¼‰**
  - [ ] ç®—ï¼šRV ç™¾åˆ†ä½ â†’ Regimeï¼ˆFROZEN/NORMAL/EXTREMEï¼‰
  - [ ] å¯« Redis KVï¼š`prod:{regime}:market:state`ï¼ˆå¸¶ `rev` å’ŒéæœŸæˆ³ï¼‰
  - [ ] æŒ‡æ¨™ï¼š`metrics:events:s2.regime_latency`
- [ ] **POST /features/recompute**
  - [ ] è®€ï¼šæœŸé–“ K ç·š/æ·±åº¦ï¼ˆè³‡æ–™æ¹–/äº¤æ˜“æ‰€ï¼‰
  - [ ] ç®—ï¼šè£œç®—ç‰¹å¾µ
  - [ ] å¯« DBï¼šå›è£œ `signals.features`ï¼›`strategy_events(kind=FEATURE_RECOMPUTE)`

#### 16. åŠŸèƒ½è¦æ ¼æ›¸ç›¸é—œåŠŸèƒ½ï¼ˆåŸºæ–¼åŠŸèƒ½è¦æ ¼æ›¸å¯¦ä½œï¼‰
- [ ] **å…¥å‘ï¼ˆè¢«å‘¼å«ï¼‰API**
  - [ ] `GET /health`ï¼ˆæ‰€æœ‰æœå‹™ï¼‰â†’ `HealthResponse{Status,Checks,...}`
  - [ ] `POST /features/recompute`ï¼ˆç¶­é‹/æ‰¹æ¬¡ï¼‰â†’ `RecomputeFeaturesResponse`
- [ ] **å‡ºå‘ï¼ˆä¸»ä»¥äº‹ä»¶ï¼‰**
  - [ ] å¯«å…¥ DB signals.featuresï¼›ç™¼ signals:new äº‹ä»¶ï¼ˆStreamï¼‰
- [ ] **ç‰¹å¾µè£œç®—æµç¨‹**
  - [ ] è§¸ç™¼ï¼šç¶­é‹/æ‰¹æ¬¡ â†’ S2 `POST /features/recompute`ï¼ˆ`RecomputeFeaturesRequest`ï¼‰
  - [ ] è™•ç†ï¼šä¾éœ€è¦è·‘å›è£œï¼ˆä¾‹å¦‚è³‡æ–™ç¼ºå£ï¼‰
  - [ ] å¤±æ•—è£œå„Ÿï¼šå¤±æ•—è€…è¨˜è™Ÿé‡è©¦ä½‡åˆ—ï¼›é€£çºŒ 3 æ¬¡å¤±æ•—â†’alerts(ERROR)
- [ ] **ç³»çµ±é–‹æ©Ÿèˆ‡é…ç½®æ”¶æ–‚**
  - [ ] S2 â†’ S10 `GET /active` å–å¾— rev/bundle_id
  - [ ] è¨‚é–±ã€”Stream: cfg:eventsã€•ï¼Œæœ¬åœ° RCU ç†±è¼‰
  - [ ] `GET /active` å¤±æ•—ï¼šé€€é¿é‡è©¦ï¼ˆexponential backoff 5â†’30sï¼‰ï¼›æœªå°±ç·’å‰åƒ… `/health` OK=DEGRADED
  - [ ] æ‰€æœ‰å¯« signals çš„æœå‹™é ˆæŠŠ config_rev å¯«å…¥ç´€éŒ„

### ğŸ¯ å¯¦ä½œå„ªå…ˆé †åº
1. **é«˜å„ªå…ˆç´š**ï¼šRedis Stream æ¶ˆè²»å’Œç‰¹å¾µè¨ˆç®—
2. **ä¸­å„ªå…ˆç´š**ï¼šæ¯æ—¥ Regime è¨ˆç®—
3. **ä½å„ªå…ˆç´š**ï¼šé…ç½®ç®¡ç†å’Œå„ªåŒ–

### ğŸ“Š ç›¸é—œè³‡æ–™å¯«å…¥
- **DB Collections**ï¼š`signals(features,t0,config_rev)`ã€`strategy_events(FEATURE_RECOMPUTE)`
- **Redis Key/Stream**ï¼š`feat:events:<sym>`ã€`prod:{regime}:market:state`

## æ¦‚è¿°

S2 Feature Generator æ˜¯ Project Chimera çš„ç‰¹å¾µå·¥ç¨‹æœå‹™ï¼Œè² è²¬å¾å¸‚å ´æ•¸æ“šå’Œä¿¡è™Ÿä¸­è¨ˆç®—å„ç¨®æŠ€è¡“ç‰¹å¾µï¼ŒåŒ…æ‹¬ ATRã€å·²å¯¦ç¾æ³¢å‹•ç‡ã€ç›¸é—œæ€§ã€æ·±åº¦ç­‰ç‰¹å¾µï¼Œç‚ºç­–ç•¥å¼•æ“æä¾›æ±ºç­–ä¾æ“šã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. ç‰¹å¾µè¨ˆç®—
- **ATR (Average True Range)**ï¼šè¨ˆç®—å¹³å‡çœŸå¯¦ç¯„åœï¼Œç”¨æ–¼è¡¡é‡åƒ¹æ ¼æ³¢å‹•æ€§
- **å·²å¯¦ç¾æ³¢å‹•ç‡ (Realized Volatility)**ï¼šåŸºæ–¼æ­·å²åƒ¹æ ¼è¨ˆç®—çš„æ³¢å‹•ç‡æŒ‡æ¨™
- **ç›¸é—œæ€§åˆ†æ**ï¼šè¨ˆç®—ä¸åŒæ¨™çš„ä¹‹é–“çš„åƒ¹æ ¼ç›¸é—œæ€§
- **æ·±åº¦ç‰¹å¾µ**ï¼šåˆ†æè¨‚å–®ç°¿æ·±åº¦å’Œåƒ¹å·®ç‰¹å¾µ

### 2. å¤šæ™‚é–“çª—å£æ”¯æŒ
- **1åˆ†é˜**ï¼šçŸ­æœŸç‰¹å¾µè¨ˆç®—
- **5åˆ†é˜**ï¼šä¸­çŸ­æœŸç‰¹å¾µè¨ˆç®—
- **1å°æ™‚**ï¼šä¸­æœŸç‰¹å¾µè¨ˆç®—
- **4å°æ™‚**ï¼šä¸­é•·æœŸç‰¹å¾µè¨ˆç®—
- **1å¤©**ï¼šé•·æœŸç‰¹å¾µè¨ˆç®—

### 3. å¯¦æ™‚è¨ˆç®—èˆ‡å¿«å–
- **å…§å­˜å¿«å–**ï¼šæœ€æ–°ç‰¹å¾µæ•¸æ“šçš„å…§å­˜å¿«å–
- **Redis ç™¼å¸ƒ**ï¼šå°‡ç‰¹å¾µæ•¸æ“šç™¼å¸ƒåˆ° Redis Streams
- **å®šæ™‚è£œç®—**ï¼šæ¯ 5 åˆ†é˜è‡ªå‹•è£œç®—ç‰¹å¾µ

### 4. ä»»å‹™ç®¡ç†
- **ç•°æ­¥è¨ˆç®—**ï¼šæ”¯æŒç•°æ­¥ç‰¹å¾µè¨ˆç®—ä»»å‹™
- **é€²åº¦è¿½è¹¤**ï¼šå¯¦æ™‚è¿½è¹¤è¨ˆç®—ä»»å‹™é€²åº¦
- **éŒ¯èª¤è™•ç†**ï¼šå®Œå–„çš„éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶

## API ç«¯é»

### å¥åº·æª¢æŸ¥
- `GET /health` - æœå‹™å¥åº·ç‹€æ…‹æª¢æŸ¥
- `GET /ready` - æœå‹™å°±ç·’ç‹€æ…‹æª¢æŸ¥

### ç‰¹å¾µç®¡ç†
- `POST /features/recompute` - é‡æ–°è¨ˆç®—ç‰¹å¾µ
- `GET /features?symbol=BTCUSDT&feature_type=ATR` - ç²å–ç‰¹å¾µæ•¸æ“š
- `GET /features/computation?task_id=xxx` - ç²å–è¨ˆç®—ä»»å‹™ç‹€æ…‹

## æ•¸å­¸è¨ˆç®—

### ATR (Average True Range)
```
TR_t = max(H_t - L_t, |H_t - C_{t-1}|, |L_t - C_{t-1}|)
ATR_t = ATR_{t-1} + (TR_t - ATR_{t-1}) / n
ATR_pct = (ATR / current_price) * 100
```

### å·²å¯¦ç¾æ³¢å‹•ç‡ (Realized Volatility)
```
r_t = ln(P_t / P_{t-1})
rv_m = sqrt(252) * std(r_{t-m+1..t})
```

### ç›¸é—œæ€§è¨ˆç®—
```
rho = corr(Î”ln P_btc, Î”ln FX, window=k)
```

### æ·±åº¦å› å­
```
liq_score = min(depth_top1_usdt / threshold, 1.0)
spread_bps = (bestAsk - bestBid) / mid * 1e4
```

## ç‰¹å¾µé¡å‹

### ATR ç‰¹å¾µ
- `atr`: ATR çµ•å°å€¼
- `atr_pct`: ATR ç™¾åˆ†æ¯”
- `period`: è¨ˆç®—é€±æœŸ

### RV ç‰¹å¾µ
- `rv`: å·²å¯¦ç¾æ³¢å‹•ç‡
- `rv_pct`: æ³¢å‹•ç‡ç™¾åˆ†æ¯”
- `period`: è¨ˆç®—é€±æœŸ

### ç›¸é—œæ€§ç‰¹å¾µ
- `correlation`: ç›¸é—œæ€§ä¿‚æ•¸
- `symbol1`: ç¬¬ä¸€å€‹æ¨™çš„
- `symbol2`: ç¬¬äºŒå€‹æ¨™çš„
- `period`: è¨ˆç®—é€±æœŸ

### æ·±åº¦ç‰¹å¾µ
- `bid_depth`: è²·ç›¤æ·±åº¦
- `ask_depth`: è³£ç›¤æ·±åº¦
- `bid_ask_ratio`: è²·è³£æ¯”ä¾‹
- `spread`: åƒ¹å·®
- `spread_pct`: åƒ¹å·®ç™¾åˆ†æ¯”

## é…ç½®åƒæ•¸

### è¨ˆç®—å™¨é…ç½®
- **ATR é€±æœŸ**: 14ï¼ˆå¯èª¿æ•´ï¼‰
- **RV é€±æœŸ**: 20ï¼ˆå¯èª¿æ•´ï¼‰
- **ç›¸é—œæ€§é€±æœŸ**: 14ï¼ˆå¯èª¿æ•´ï¼‰

### å®šæ™‚ä»»å‹™é…ç½®
- **è£œç®—é–“éš”**: 5 åˆ†é˜
- **æ”¯æ´æ¨™çš„**: BTCUSDT, ETHUSDT, ADAUSDT
- **æ”¯æ´çª—å£**: 1m, 5m, 1h, 4h, 1d

## æ•¸æ“šæµ

### è¼¸å…¥æ•¸æ“š
- **å¸‚å ´æ•¸æ“š**: ä¾†è‡ª S1 Exchange Connectors
- **K ç·šæ•¸æ“š**: OHLCV æ ¼å¼çš„åƒ¹æ ¼æ•¸æ“š
- **æ·±åº¦æ•¸æ“š**: è¨‚å–®ç°¿è²·è³£ç›¤æ•¸æ“š

### è¼¸å‡ºæ•¸æ“š
- **ç‰¹å¾µå¿«ç…§**: å…§å­˜å¿«å–çš„ç‰¹å¾µæ•¸æ“š
- **Redis Streams**: `feat:last:{symbol}` æœ€æ–°ç‰¹å¾µ
- **ArangoDB**: `signals.features` æŒä¹…åŒ–å­˜å„²

## æ€§èƒ½ç‰¹æ€§

### è¨ˆç®—æ•ˆç‡
- **ä¸¦è¡Œè¨ˆç®—**: å¤šå€‹ç‰¹å¾µä¸¦è¡Œè¨ˆç®—
- **å¿«å–æ©Ÿåˆ¶**: é¿å…é‡è¤‡è¨ˆç®—
- **å¢é‡æ›´æ–°**: åªè¨ˆç®—æ–°å¢æ•¸æ“š

### å…§å­˜ç®¡ç†
- **LRU å¿«å–**: æœ€è¿‘ä½¿ç”¨çš„ç‰¹å¾µå„ªå…ˆä¿ç•™
- **å®šæœŸæ¸…ç†**: æ¸…ç†éæœŸçš„è¨ˆç®—ä»»å‹™
- **å…§å­˜ç›£æ§**: å¯¦æ™‚ç›£æ§å…§å­˜ä½¿ç”¨æƒ…æ³

## éŒ¯èª¤è™•ç†

### æ•¸æ“šä¸è¶³
- æª¢æŸ¥æ•¸æ“šé»æ•¸é‡æ˜¯å¦è¶³å¤ 
- æä¾›è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
- è·³éç„¡æ³•è¨ˆç®—çš„ç‰¹å¾µ

### è¨ˆç®—éŒ¯èª¤
- è¨˜éŒ„è¨ˆç®—å¤±æ•—çš„è©³ç´°ä¿¡æ¯
- ç¹¼çºŒè¨ˆç®—å…¶ä»–ç‰¹å¾µ
- è¿”å›éƒ¨åˆ†æˆåŠŸçš„çµæœ

## ç›£æ§æŒ‡æ¨™

### æœå‹™å¥åº·æŒ‡æ¨™
- Redis é€£æ¥å»¶é²
- ArangoDB é€£æ¥å»¶é²
- ç‰¹å¾µè¨ˆç®—å»¶é²

### æ¥­å‹™æŒ‡æ¨™
- ç‰¹å¾µè¨ˆç®—æˆåŠŸç‡
- å¿«å–å‘½ä¸­ç‡
- ä»»å‹™å®Œæˆæ™‚é–“

## éƒ¨ç½²èªªæ˜

### Docker éƒ¨ç½²
```bash
docker build -t s2-feature .
docker run -p 8082:8082 s2-feature
```


## æŠ€è¡“è¦æ ¼

### ç’°å¢ƒè¦æ±‚
- Go 1.19+
- Redis Cluster
- ArangoDB
- è¶³å¤ çš„å…§å­˜ï¼ˆå»ºè­° 2GB+ï¼‰

## é–‹ç™¼æŒ‡å—
### API ç«¯é»
- `GET /health` - æœå‹™å¥åº·ç‹€æ…‹æª¢æŸ¥
- `GET /ready` - æœå‹™å°±ç·’ç‹€æ…‹æª¢æŸ¥
- `POST /features/recompute` - é‡æ–°è¨ˆç®—ç‰¹å¾µ
- `GET /features?symbol=BTCUSDT&feature_type=ATR` - ç²å–ç‰¹å¾µæ•¸æ“š


### æ·»åŠ æ–°ç‰¹å¾µ
1. å¯¦ç¾ `FeatureCalculator` æ¥å£
2. åœ¨ `initializeFeatureCalculators` ä¸­è¨»å†Š
3. æ·»åŠ ç›¸æ‡‰çš„æ•¸æ“šæ¨¡å‹

### æœ¬åœ°é–‹ç™¼
```bash
# å®‰è£ä¾è³´
go mod tidy

# é‹è¡Œæœå‹™
go run main.go

# æ¸¬è©¦
go test ./...
```

## æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ
1. **ç‰¹å¾µè¨ˆç®—å¤±æ•—**
   - æª¢æŸ¥è¼¸å…¥æ•¸æ“šæ˜¯å¦å®Œæ•´
   - ç¢ºèªè¨ˆç®—åƒæ•¸æ˜¯å¦æ­£ç¢º
   - æŸ¥çœ‹æ—¥èªŒä¸­çš„éŒ¯èª¤ä¿¡æ¯

2. **å¿«å–æ•¸æ“šéæœŸ**
   - æª¢æŸ¥å®šæ™‚ä»»å‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
   - ç¢ºèª Redis é€£æ¥ç‹€æ…‹
   - æ‰‹å‹•è§¸ç™¼ç‰¹å¾µé‡ç®—

3. **å…§å­˜ä½¿ç”¨éé«˜**
   - æª¢æŸ¥å¿«å–å¤§å°è¨­ç½®
   - ç¢ºèªæ˜¯å¦æœ‰å…§å­˜æ´©æ¼
   - èª¿æ•´å¿«å–æ¸…ç†ç­–ç•¥

## ç‰ˆæœ¬æ­·å²

### v1.0.0
- åˆå§‹ç‰ˆæœ¬
- æ”¯æŒ ATRã€RVã€ç›¸é—œæ€§ã€æ·±åº¦ç‰¹å¾µè¨ˆç®—
- å¯¦ç¾å¤šæ™‚é–“çª—å£æ”¯æŒ
- æ·»åŠ ä»»å‹™ç®¡ç†å’Œé€²åº¦è¿½è¹¤

### æ•¸å­¸è¨ˆç®—
- **ATR**: `TR_t = max(H_t - L_t, |H_t - C_{t-1}|, |L_t - C_{t-1}|)`, `ATR_t = ATR_{t-1} + (TR_t - ATR_{t-1}) / n`
- **RV**: `r_t = ln(P_t / P_{t-1})`, `rv_m = sqrt(252) * std(r_{t-m+1..t})`
- **ç›¸é—œæ€§**: `rho = corr(Î”ln P_btc, Î”ln FX, window=k)`
- **æ·±åº¦å› å­**: `liq_score = min(depth_top1_usdt / threshold, 1.0)`