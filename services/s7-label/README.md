# S7 Label Backfill

## 概述

S7 Label Backfill 是 Project Chimera 交易系統的標籤回填服務，負責為歷史交易信號添加標籤，用於機器學習模型訓練和策略回測。

## 功能

- **標籤回填**：為歷史信號添加標籤
- **標籤管理**：管理標籤規則和配置
- **性能評估**：評估標籤準確性
- **數據準備**：為 ML 模型準備訓練數據

## API 接口

### 健康檢查

- `GET /health` - 服務健康狀態檢查
- `GET /ready` - 服務就緒狀態檢查

### 標籤管理

- `POST /labels/backfill` - 標籤回填

#### Backfill Labels

**請求**：
```json
{
  "symbol": "BTCUSDT",
  "market": "FUT",
  "from_time": 1640995200000,
  "to_time": 1641081600000,
  "horizon_hours": 24,
  "label_rules": [
    {
      "rule_id": "rule_001",
      "name": "profit_threshold",
      "threshold": 0.05,
      "enabled": true
    }
  ]
}
```

**回應**：
```json
{
  "updated": 100,
  "message": "Labels backfilled successfully"
}
```

## 服務間交互

### 入向（被呼叫）
- **排程系統** → `POST /labels/backfill` - 定期標籤回填
- **手動觸發** → `POST /labels/backfill` - 手動回填請求

### 出向（主動呼叫）
- **數據庫** → 更新 labels_* 集合
- **Redis Stream** → 推送 labels:ready 事件

## 標籤回填流程

### 時間窗口
- **12小時**：短期標籤
- **24小時**：中期標籤
- **36小時**：長期標籤

### 標籤類型
- **獲利標籤**：基於價格變動
- **風險標籤**：基於波動率
- **趨勢標籤**：基於技術指標

### 回填策略
1. 讀取歷史信號數據
2. 應用標籤規則
3. 計算標籤值
4. 更新數據庫
5. 發送完成事件

## 標籤規則

### 獲利規則
- 基於價格變動百分比
- 考慮交易成本
- 支援多時間窗口

### 風險規則
- 基於波動率
- 考慮最大回撤
- 風險調整收益

### 趨勢規則
- 基於技術指標
- 趨勢強度評估
- 信號質量評分

## 失敗處理

### 重試機制
- 失敗記錄重試佇列
- 指數退避重試
- 最大重試次數限制

### 告警機制
- 連續 3 次失敗 → ERROR 告警
- 大量失敗 → FATAL 告警
- 監控標籤質量

## 配置

服務使用以下配置：
- Redis：用於任務佇列和緩存
- ArangoDB：用於標籤數據存儲
- 標籤規則配置
- 端口：8087（可通過環境變量 PORT 覆蓋）

## 部署

```bash
# 構建
go build -o s7-label .

# 運行
./s7-label
```

## 監控

服務提供以下監控指標：
- 標籤回填延遲
- 標籤準確性
- 處理成功率
- 重試次數
- 標籤質量評分
