# Project Chimera — 定時任務、排程與核心算法詳解 v2.2

**實作進度：0/12 服務已完成 (0%)**

**核心原則**：事件驅動優先；排程僅用於修復性、週期性與聚合性任務。
**時間/單位**：timestamp = epoch ms；金額 = USDT；比例用小數（0.1 = 10%）。

---

## S1 — Exchange Connectors ❌ **[未實作]**

### 1) 交易所心跳巡檢（每 30s）❌ **[未實作]**

#### 流程

* 呼叫 `GET /fapi/v1/time` 取得伺服器時間 $t_{\text{server}}$。
* 讀取本地時間 $t_{\text{local}}$。
* 計算時鐘偏差與可用性；更新健康度指標。

#### 公式

* **時鐘偏差**：$\Delta t = |t_{\text{local}} - t_{\text{server}}|$
* **判定**：$\Delta t \le \text{skew\_max\_ms}$ → PASS；否則 WARN/ERROR（建議分層：250/500/1000ms）。
* **度量**

  * 成功率：$p_{\text{up}} = \frac{\text{ok\_calls}}{\text{total\_calls}}$
  * RTT 分位：$RTT_{p50}, RTT_{p95}$

---

### 2) WS 自動重連（事件驅動 + 每 10s 掃描）❌ **[未實作]**

#### 流程

* 為每條 WS 連線維護 `retry_count`。斷線後按指數退避 + 抖動重連；成功即清零並重新訂閱。

#### 公式（Exponential Backoff + Jitter）

* $\text{wait}=\min\!\big(\text{maxWait},\, \text{base}\cdot 2^{\text{retry\_count}}\big) + U(0,\text{jitter})$

#### 守護

* 連續失敗超過 $N_{\max}$ → FATAL；降級為「僅管理既有倉位」模式。

---

## S2 — Feature Generator ❌ **[未實作]**

### 3) 特徵回補（每小時 / 手動）❌ **[未實作]**

#### 流程

* 掃描 `signals`，篩出特徵缺失或過期記錄。
* 取得歷史 K 線 / 深度 / 資金費等原始數據。
* 重新計算特徵寫回；標記 DQC 欄位。

#### 核心指標公式

* **True Range**：$TR_t = \max\{H_t-L_t,\; |H_t-C_{t-1}|,\; |L_t-C_{t-1}|\}$
* **ATR（EMA, 參數 n）**：$ATR_t = \alpha \cdot TR_t + (1-\alpha)\cdot ATR_{t-1}$，$\alpha=\frac{2}{n+1}$
* **對數報酬**：$r_t=\ln\!\left(\frac{P_t}{P_{t-1}}\right)$
* **已實現波動率（N 期）**：$RV_N = \sqrt{K}\cdot \sigma\big(r_{t-N+1..t}\big)$
  （年化因子 $K$：日線 $\sqrt{365}$；4h 線 $\approx \sqrt{6\times 365}$）
* **皮爾森相關（滑窗 M）**：$\rho_{XY}=\frac{\sum (x-\bar x)(y-\bar y)}{\sqrt{\sum(x-\bar x)^2}\sqrt{\sum(y-\bar y)^2}}$

---

### 4) 市場 Regime 更新（每日 00:05）❌ **[未實作]**

#### 流程

* 取近 N 日 RV 序列。
* 計算百分位名次與 Regime，寫入 `prod:regime:market:state`。

#### 百分位名次（含 ties）

* $\text{PctRank}(X)=\frac{C_L + 0.5\cdot C_E}{N}$（$C_L$：小於 X；$C_E$：等於 X）

#### 分群建議

* $\text{pct} < 0.10$ → **FROZEN**
* $0.10 \le \text{pct} \le 0.90$ → **NORMAL**
* $\text{pct} > 0.90$ → **EXTREME**

---

## S3 — Strategy Engine ❌ **[未實作]**

### 5) 決策心跳（冗餘，毎 10s）❌ **[未實作]**

#### 流程

* 若 `feat:events:*` 在最近 $T$ 秒無更新，主動拉快照並執行一次硬性守門（強平距離、風險預算等）。

#### 強平緩衝

* $\text{LB}=\frac{|P_{\text{mark}}-P_{\text{liq}}|}{P_{\text{mark}}}$；若 $\text{LB} < \text{lb\_min}$ → 觸發降風險（減倉/收緊 SL）。

#### ROE（USDT 永續，長倉）

* $\text{PnL}=(P-P_{\text{entry}})\cdot Q$；$\text{ROE}=\frac{\text{PnL}}{\text{isolated\_margin}}$（空倉對稱換號）。

---

## S4 — Order Router ❌ **[未實作]**

### 6) 路由器殘單清理（每 1–5 分鐘）❌ **[未實作]**

#### 流程

* 以交易所 `openOrders` 對比 DB 中 `orders(status∈{NEW,PARTIALLY_FILLED})`。
* 孤兒單 → 撤單；過期單 → 撤/改價/升級市價（依路由策略）。

#### 一致性度量（Jaccard）

* $J=\frac{|O_{\text{ex}}\cap O_{\text{db}}|}{|O_{\text{ex}}\cup O_{\text{db}}|}$；低於門檻觸發對帳 / 告警。

---

### 7) TWAP / 批次執行 tick（每 1–3 秒）❌ **[未實作]**

#### 參數

* 目標名目 $N$（USDT），切片大小 $s$ → 切片數 $n=\lceil N/s\rceil$
* 時距 $\Delta t$（秒），起點 $t_0$

#### 調度

* $t_i = t_0 + i\cdot \Delta t$，$q_i = \frac{Q_{\text{total}}}{n}$

#### 可選曲線與修正

* **時間平方根曲線**：$q_i \propto \sqrt{i}$（正規化到 $Q_{\text{total}}$）
* **流動性修正**：spread / top1 depth 異常 → 推遲或縮片；估計滑價超閾值 → 改限價或更細分片。

---

## S5 — Reconciler ❌ **[未實作]**

### 8) 對帳（每 10–15 分鐘）❌ **[未實作]**

#### 流程

* 拉取 `positionRisk`、`openOrders` 與 DB 快照。
* 差異分類：API 有 / DB 無；DB 有 / API 無；數量或方向不一致。
* 策略：以 API 為準修 DB；必要時降風險至 FLAT。

#### 集合差異

* $D = (S_{\text{API}} \cup S_{\text{DB}})\setminus (S_{\text{API}} \cap S_{\text{DB}})$

---

## S6 — Position Manager ❌ **[未實作]**

### 9) 持倉管理 tick（每 10–30 秒）❌ **[未實作]**

#### 步驟

* 取得 $P_{\text{mark}}, P_{\text{entry,avg}}, Q, \text{isolated\_margin}$。
* 計算 ROE / ATR / Regime；檢查加倉、分批、移動停損規則。
* 以「撤舊掛新」或減倉/加倉指令送交 S4。

#### 移動停損（ATR & 鎖利）

* **ATR 型（多）**：$SL = P_{\text{entry}} - k\cdot ATR$
* **鎖利 ROE 型（多）**：給定鎖利門檻 $\rho^*$，

  $$
  P_{\text{lock}} = P_{\text{entry}} + \frac{\rho^* \cdot \text{isolated\_margin}}{Q}
  $$

  （空倉對稱換號）

#### 分批止盈（首腿）

* 若 $\text{ROE} \ge \rho_1$ → 平掉 $\beta_1\%$ 的 $Q$；更新均價/保證金後再評估下一腿。

---

### 10) 自動資金劃轉（每 5 分鐘）❌ **[未實作]**

#### 邏輯

* 合約自由額度不足：$\text{need} = \max(0, \text{min\_free\_fut} - \text{free\_fut})$
* 若 $\text{free\_spot} \ge \text{need} + \text{spot\_buffer}$ → 觸發 SPOT→FUT 劃轉（冪等 ID）。

---

## S7 — Label Backfill ❌ **[未實作]**

### 11) 標籤回填（每 15 分鐘）❌ **[未實作]**

#### 流程

* 查詢 `signals`：滿足 $t_0 + H \le \text{now}$ 且尚未標籤。
* 聚合 `fills`（至 $t_0+H$）、`funding_records` 與 `fees`。
* 計算 $ROI_{\text{net}}$、`label`（pos/neg/neutral）並寫回。

#### 公式（USDT 永續）

* $ROI_{\text{net}} = \dfrac{\text{PnL}_{\text{realized}} - \sum \text{Fees} - \sum \text{Funding}}{\text{Margin}_{\text{total}}}$

#### 標籤規則（示例）

* $ROI_{\text{net}} \ge +0.005$ → `pos`；$\le -0.005$ → `neg`；其餘 → `neutral`

---

## S8 — Autopsy Generator ❌ **[未實作]**

### 12) 復盤生成（每小時 / 事件驅動）❌ **[未實作]**

#### 計算

* **滑價（bps）**：$\text{slip\_bps} = \operatorname{sign}(\text{side})\cdot \frac{P_{\text{fill}} - P_{\text{mid\_at\_send}}}{P_{\text{mid\_at\_send}}}\times 10^4$
* **成本占比**：$\text{cost\_share}=\dfrac{\sum \text{Fees}+\sum \text{Funding}+\sum |\text{Slippage}|}{|\text{PnL}_{\text{gross}}|+\varepsilon}$
* **Peer 對比**：同 cohort（同 Regime、同方向）計算分位；輸出 TL;DR 與圖表。

---

## S9 — Hypothesis Orchestrator ❌ **[未實作]**

### 13) 回測 / 實驗批次（每日 / 每週）❌ **[未實作]**

#### 核心績效

* **CAGR**：$\text{CAGR}=(1+R_{\text{tot}})^{\frac{\text{year}}{\text{days}}}-1$
* **最大回撤**：$\text{MaxDD}=\max_t\!\Big(1-\frac{\text{Equity}_t}{\max_{\tau\le t}\text{Equity}_\tau}\Big)$
* **Calmar**：$\text{Calmar}=\frac{\text{CAGR}}{|\text{MaxDD}|}$
* 其他：Sharpe、Sortino、Profit Factor、Hit Ratio、平均持倉時間等。

#### 統計檢定

* 差異顯著性：U-test／bootstrap CI；以 FDR 控制 $\alpha$。

---

## S10 — Config Service ❌ **[未實作]**

### 14) 模擬 + 敏感度批次（手動 / 每夜）❌ **[未實作]**

#### 差異重放

* 對歷史 `signals` 套用新 bundle 重算決策，產出 `trades_new`、`delta_trades_pct`、規則命中分布、覆蓋度等。

#### 敏感度分析（特徵擾動 $\pm\epsilon$）

* **決策翻轉率**：$\text{flip\_pct}=\frac{\#\{\text{decision}(x)\neq \text{decision}(x+\delta)\}}{N}$
* **Local Lipschitz 近似**（連續輸出，如 `size_mult`）：

  $$
  L \approx \operatorname{median}\!\left(\frac{|f(x+\delta)-f(x)|}{\|\delta\|}\right),\quad \|\delta\|=\epsilon\cdot \|x\|
  $$
* **穩健分數**：$\text{robustness}=1-\text{flip\_pct}$

---

### 15) Active / 守門巡檢（每 1 分鐘）❌ **[未實作]**

#### 流程

* 在 Canary / Ramp 階段，滾動監控線上 MaxDD、AUC、Brier 等；越界即自動回滾。

#### 指標

* **AUC（近 100 筆）**：`pred_prob` vs `label` 的 ROC AUC。
* **Brier Score**：$\text{Brier}=\frac{1}{N}\sum (p_i-y_i)^2$

---

## S11 — Metrics & Health ❌ **[未實作]**

### 16) 健康巡檢彙總（每 10 秒）❌ **[未實作]**

#### 合成健康狀態

* **核心指標（示例）**：`losing_streak`、`maker_fill_ratio`、`ib_rate`（資金不足率）、`stream_lag`、`router_p95`
* **狀態映射**：依門檻表將多指標合成 **GREEN / YELLOW / ORANGE / RED**（加權或 max-severity 規則）。

---

## S12 — Web UI / API GW ❌ **[未實作]**

### 17) UI 快取 / 清理（每 5 分鐘）❌ **[未實作]**

#### 流程

* 清理過期快取；刷新 `kill_switch`、`active_rev` 等全域狀態 TTL。
* 偵測 TTL 失效風險 → 立即刷新或標記 WARN。

---

## 追加：共通公式與邊界條件 ❌ **[未實作]**

* **市價滑價上限守門**：若估計執行滑價 $|\Delta P|/P$ 超過 `slip_bp_max` → 改限價或更細分片。
* **Maker 等待**：等待 $T_{\text{wait}}(\text{spread},\text{depth})$（由路由參數表定義），逾時 → Taker 回退。
* **風險預算**：同時約束 `risk.budget.fut_margin_usdt_max`、`concurrent_entries_per_market` 等。
* **SPOT OCO 守護**：任一腿掛單失敗 → 立即補掛或切換守護停損策略。
* **退避與冪等（共通）**

  * 退避：$\text{backoff} = \min(\text{max}, \text{base}\cdot 2^k) + \text{jitter}$
  * 冪等鍵：`intent_id`／`client_order_id`／`transfer_id`
* **告警層級**：WARN（可恢復）、ERROR（需人工注意）、FATAL（降級／停機）。
* **核心 SLI**：`/orders` 成功率、端到端延遲 p95、WS lag、Stream lag、對帳一致率 $J$、MaxDD。
* **SLO（示例）**：`/orders` 成功率 ≥ 99.5% 、端到端 p95 ≤ 800ms、WS 可用 ≥ 99.9%。

---

**備註**：本文件為純 Markdown，可直接存放於版本庫（建議：`docs/schedules-and-algos.md`），作為服務端與前端共同依據的排程與算法參考規範。
