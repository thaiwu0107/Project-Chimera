# Project Chimera — 工程實作清單與開發順序 (Roadmap v1.0)

**實作進度：0/6 階段已完成 (0%)**

**目標**：本文件旨在提供一套清晰的、分階段的開發路線圖，指導工程團隊按照邏輯依賴和風險遞增的順序，逐步完成 Project Chimera 的全部功能。

**核心原則**：

1. **基礎先行 (Infrastructure First)**：先搭建好數據庫、消息隊列和監控系統的骨架。
2. **數據驅動 (Data-Driven)**：先讓數據流動起來，再實現消費數據的業務邏輯。
3. **閉環優先 (Close the Loop First)**：盡快打通一個「信號 → 下單 → 平倉 → 對帳」的最小交易閉環。
4. **智能後置 (Intelligence Later)**：先用簡單的規則跑通，再逐步引入複雜的 ML/AI/優化層。

---

## 階段零：基礎設施與骨架 (Phase 0: Environment & Infrastructure) ❌ **[未實作]**

**目標**：搭建好所有服務運行的基礎環境，萬丈高樓平地起。

**📚 參考文檔**：
- `doc/白皮書.md` 第 1-50 行：系統分工與服務架構
- `doc/服務與資料流.md` 第 1-50 行：服務總覽與資料面
- `doc/OpenAPI 3.1.yaml` 第 1-50 行：API 規格與安全設定
- `doc/路過的服務.md` 第 8-16 行：記號與通用規則
- `doc/功能對照補記.md` 第 7-22 行：符號與常數約定
- `doc/名詞解釋與概念說明.md` 第 1-100 行：系統架構與服務模組概念

|  #  | 任務 (Task)           | 涉及服務                | 產出物 / DoD (Definition of Done)                                                                          |
| :-: | :------------------ | :------------------ | :------------------------------------------------------------------------------------------------------ |
| 0.1 | **雲端環境初始化**         | (Infrastructure)    | ❌ **[未實作]** - GCP/AWS 專案建立。<br>- 網路 VPC、子網、防火牆規則配置。<br>- 具備 `kubectl`, `helm` 的本地開發環境。<br>**📚 參考**：`doc/白皮書.md` 第 23-40 行（執行摘要與工程治理） |
| 0.2 | **Kubernetes 集群部署** | (Infrastructure)    | ❌ **[未實作]** - 部署一個 GKE Autopilot 或標準集群（1 控制平面 + 2 工作節點）。<br>- `kubectl cluster-info` 可用。<br>**📚 參考**：`doc/白皮書.md` 第 42-50 行（系統分工與服務架構） |
| 0.3 | **資料庫部署**           | ArangoDB, Redis     | ❌ **[未實作]** - 使用 K8s Operator 部署 ArangoDB Cluster。<br>- 使用 Helm Chart 或託管服務部署 Redis Cluster。<br>- 內部 DNS 可解析，服務可連接。<br>**📚 參考**：`doc/白皮書.md` 第 100-200 行（ArangoDB Collections）、`doc/服務與資料流.md` 第 20-30 行（資料面） |
| 0.4 | **監控套件部署**          | Prometheus, Grafana | ❌ **[未實作]** - 使用 `kube-prometheus-stack` Helm Chart 部署監控套件。<br>- Grafana 儀表板可訪問，能看到 K8s 節點指標。<br>**📚 參考**：`doc/白皮書.md` 第 34-36 行（Observability）、`doc/定時任務.md` 第 1-50 行（監控指標） |
| 0.5 | **項目初始化**           | S1-S12 (通用)         | ❌ **[未實作]** - 建立 Git 倉庫，初始化 Go Modules。<br>- 建立 CI/CD Pipeline 骨架，能夠自動化構建 Docker 鏡像並推送到倉庫。<br>**📚 參考**：`doc/OpenAPI 3.1.yaml` 第 1-100 行（API 規格）、`doc/字段校驗表.md` 第 1-50 行（共用型別） |

---

## 階段一：最小可用資料鏈 (Phase 1: Minimum Viable Data Chain) ❌ **[未實作]**

**目標**：從交易所→特徵→決策，不下單，僅寫 `signals` 與事件；可離線回補特徵與產生決策。

**📚 參考文檔**：
- `doc/白皮書.md` 第 48-100 行：S1 Exchange Connectors 詳細規格
- `doc/服務與資料流.md` 第 25-100 行：S1-S2-S3 功能矩陣
- `doc/定時任務.md` 第 10-100 行：S1-S2 定時任務與算法
- `doc/核心時序圖.md` 第 1-50 行：FUT 入場時序圖
- `doc/路過的服務.md` 第 20-70 行：S1-S2 到站就做清單
- `doc/功能對照補記.md` 第 24-36 行：USDT/TWD × BTCUSDT 規則信號

|  #  | 任務 (Task)            | 涉及服務       | 產出物 / DoD (Definition of Done)                                                                                                               |
| :-: | :------------------- | :--------- | :------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.1 | **服務框架搭建**           | S1-S12     | ❌ **[未實作]** - 為 12 個服務建立獨立的 Go 專案目錄及 K8s `deployment.yaml` 和 `Dockerfile`。<br>- 所有服務都能成功部署並提供 `/health`, `/ready` 端點。<br>**📚 參考**：`doc/白皮書.md` 第 42-50 行（系統分工）、`doc/OpenAPI 3.1.yaml` 第 10-20 行（health 端點） |
| 1.2 | **S1 - 交易所連接器**      | **S1**     | ❌ **[未實作]** - 實現與 Binance FUT/SPOT 的 WebSocket 連接，處理心跳與自動重連。<br>- 將收到的原始 `Ticker` 和 `Depth` 數據，按規格寫入 Redis Streams (`mkt:*`)。<br>- `S1` 的日誌中可以看到穩定的數據流入。<br>**📚 參考**：`doc/白皮書.md` 第 48-80 行（S1 詳細規格）、`doc/定時任務.md` 第 10-50 行（心跳巡檢與WS重連）、`doc/服務與資料流.md` 第 25-50 行（行情與交易規則快取）、`doc/路過的服務.md` 第 20-44 行（S1 到站就做清單） |
| 1.3 | **S2 - 特徵生成器 (基礎版)** | **S2**     | ❌ **[未實作]** - 能夠消費 `mkt:events:*` streams。<br>- 實現基礎特徵計算，如 `mid_price`, `spread_bps`。<br>- 將包含基礎特徵的 `FeatureEvent` 寫入 `feat:events:*` Stream。<br>**📚 參考**：`doc/白皮書.md` 第 80-120 行（S2 詳細規格）、`doc/服務與資料流.md` 第 44-80 行（特徵工程）、`doc/定時任務.md` 第 47-100 行（特徵回補與Regime更新）、`doc/路過的服務.md` 第 46-69 行（S2 到站就做清單）、`doc/功能對照補記.md` 第 24-36 行（USDT/TWD × BTCUSDT 規則信號） |
| 1.4 | **ArangoDB 初始化任務**   | (Init Job) | ❌ **[未實作]** - 建立一個 K8s `Job`，它會在部署時運行一次。<br>- **職責**：連接 ArangoDB，檢查並創建 v3.0 白皮書中列出的**所有 Collections 和索引**。<br>**📚 參考**：`doc/白皮書.md` 第 100-200 行（ArangoDB Collections 與索引）、`doc/服務與資料流.md` 第 20-30 行（資料面） |
| 1.5 | **S10 - 配置服務 (靜態版)** | **S10**    | ❌ **[未實作]** - 能夠從 ArangoDB `config_bundles` 中讀取一個**寫死的、預設的**配置。<br>- 提供 `GET /active` API，讓其他服務可以拉取這份靜態配置。<br>**📚 參考**：`doc/白皮書.md` 第 400-500 行（S10 配置服務）、`doc/OpenAPI 3.1.yaml` 第 200-300 行（配置相關API） |

---

## 階段二：下單與執行面（期貨 FUT 先行）(Phase 2: Order & Execution - FUT First) ❌ **[未實作]**

**目標**：能在 Testnet 完整下單、撤單、移動停損，並能對帳自癒。

**📚 參考文檔**：
- `doc/白皮書.md` 第 120-200 行：S3-S4-S5-S6 詳細規格
- `doc/服務與資料流.md` 第 100-200 行：S3-S4-S5-S6 功能矩陣
- `doc/核心時序圖.md` 第 1-100 行：FUT 入場完整時序圖
- `doc/字段校驗表.md` 第 7-50 行：Intent、OrderResult、CancelRequest 校驗
- `doc/定時任務.md` 第 100-200 行：S3-S4-S5-S6 定時任務
- `doc/路過的服務.md` 第 71-163 行：S3-S4-S5-S6 到站就做清單
- `doc/功能對照補記.md` 第 36-90 行：ATR停損、20×逐倉、規則DSL、置信度模型、FUT入場

|  #  | 任務 (Task)            | 涉及服務   | 產出物 / DoD (Definition of Done)                                                                                                |
| :-: | :------------------- | :----- | :---------------------------------------------------------------------------------------------------------------------------- |
| 2.1 | **S3 - 策略引擎 (規則版)**  | **S3** | ❌ **[未實作]** - 實現**靜態規則**決策，暫不接 DSL。例如：`IF spread_bps < 10 THEN open`。<br>- 能夠生成標準的 `OrderIntent`，並寫入 `ord:cmd:*` Stream。<br>**📚 參考**：`doc/白皮書.md` 第 120-150 行（S3 詳細規格）、`doc/服務與資料流.md` 第 100-150 行（S3 功能矩陣）、`doc/定時任務.md` 第 100-150 行（決策心跳）、`doc/路過的服務.md` 第 71-91 行（S3 到站就做清單）、`doc/功能對照補記.md` 第 62-79 行（規則DSL與置信度模型） |
| 2.2 | **S4 - 訂單路由 (市價版)**  | **S4** | ❌ **[未實作]** - 能夠消費 `ord:cmd:*`。<br>- 實現**最簡單的市價單 (MARKET)** 執行邏輯，包含冪等性檢查。<br>- 將成交結果寫入 `ord:result:*` Stream 和 ArangoDB `orders`/`fills`。<br>**📚 參考**：`doc/白皮書.md` 第 150-180 行（S4 詳細規格）、`doc/服務與資料流.md` 第 150-200 行（S4 功能矩陣）、`doc/核心時序圖.md` 第 20-80 行（下單執行流程）、`doc/字段校驗表.md` 第 7-50 行（Intent 校驗）、`doc/路過的服務.md` 第 93-123 行（S4 到站就做清單）、`doc/功能對照補記.md` 第 80-106 行（FUT入場與智能執行） |
| 2.3 | **S6 - 倉位管理 (基礎版)**  | **S6** | ❌ **[未實作]** - 能夠消費 `ord:result:*`，在 ArangoDB 中創建和更新倉位快照。<br>- 實現**固定的止損止盈**邏輯（例如，價格下跌 2% 或上漲 4%）。<br>- 能夠生成平倉的 `ord:cmd`。<br>**📚 參考**：`doc/白皮書.md` 第 180-200 行（S6 詳細規格）、`doc/服務與資料流.md` 第 200-250 行（S6 功能矩陣）、`doc/核心時序圖.md` 第 50-100 行（止損保護流程）、`doc/定時任務.md` 第 200-250 行（持倉 tick）、`doc/路過的服務.md` 第 139-163 行（S6 到站就做清單）、`doc/功能對照補記.md` 第 36-61 行（ATR停損與20×逐倉） |
| 2.4 | **S5 - 對帳器 (手動觸發版)** | **S5** | ❌ **[未實作]** - 實現 `POST /reconcile` API。<br>- 能夠完整地執行一次交易所與 DB 的狀態對比，並**僅記錄差異日誌**，暫不執行自動修復。<br>**📚 參考**：`doc/白皮書.md` 第 200-250 行（S5 詳細規格）、`doc/服務與資料流.md` 第 250-300 行（S5 功能矩陣）、`doc/定時任務.md` 第 250-300 行（對帳任務）、`doc/integration-appendix.md` 第 200-300 行（對帳處置流程）、`doc/路過的服務.md` 第 125-137 行（S5 到站就做清單）、`doc/功能對照補記.md` 第 141-148 行（對帳/事務狀態機） |
| 2.5 | **驗收標準**             | S4, S5 | ❌ **[未實作]** - FUT 入場時序圖可重演。<br>- Jaccard 一致率 > 閾值；路由 p95 ≤ 800ms；失敗重試/冪等生效。<br>**📚 參考**：`doc/核心時序圖.md` 第 1-100 行（完整 FUT 入場流程）、`doc/integration-appendix.md` 第 1-100 行（驗收標準與測試策略） |

---

## 階段三：現貨 SPOT 擴充（OCO/守護停損）(Phase 3: Spot Expansion) ❌ **[未實作]**

**目標**：SPOT 入場＋OCO 或守護停損；庫存/WAC 帳務基礎。

**📚 參考文檔**：
- `doc/白皮書.md` 第 150-200 行：S4-S6 現貨相關規格
- `doc/服務與資料流.md` 第 150-250 行：S4-S6 現貨功能矩陣
- `doc/核心時序圖.md` 第 100-150 行：SPOT 入場時序圖
- `doc/字段校驗表.md` 第 50-100 行：OCO 相關字段校驗
- `doc/integration-appendix.md` 第 100-200 行：SPOT OCO 失敗回退流程
- `doc/路過的服務.md` 第 93-163 行：S4-S6 現貨到站就做清單
- `doc/功能對照補記.md` 第 90-106 行：SPOT入場與OCO/守護停損

|  #  | 任務 (Task)       | 涉及服務   | 產出物 / DoD (Definition of Done)                                                                          |
| :-: | :-------------- | :----- | :------------------------------------------------------------------------------------------------------ |
| 3.1 | **S4 - 現貨訂單邏輯** | **S4** | ❌ **[未實作]** - `POST /orders` 接口擴展，能夠處理 `market=SPOT` 的意圖。<br>- 實現 OCO 訂單邏輯：優先嘗試交易所原生 OCO；若不支持或失敗，則切換到**客戶端守護停損**模式。<br>**📚 參考**：`doc/白皮書.md` 第 150-180 行（S4 現貨規格）、`doc/服務與資料流.md` 第 150-200 行（S4 功能矩陣）、`doc/核心時序圖.md` 第 100-150 行（SPOT 入場時序圖）、`doc/字段校驗表.md` 第 50-100 行（OCO 字段校驗）、`doc/路過的服務.md` 第 93-123 行（S4 現貨到站就做清單）、`doc/功能對照補記.md` 第 90-99 行（SPOT入場與OCO/守護停損） |
| 3.2 | **S6 - 現貨會計**   | **S6** | ❌ **[未實作]** - 擴展倉位管理以支持現貨。<br>- 實現**加權平均成本法 (WAC)** 的會計邏輯。<br>- 持久化 `holdings_spot_snapshots`。<br>**📚 參考**：`doc/白皮書.md` 第 180-200 行（S6 現貨會計規格）、`doc/服務與資料流.md` 第 200-250 行（S6 功能矩陣）、`doc/定時任務.md` 第 200-250 行（持倉 tick）、`doc/integration-appendix.md` 第 100-200 行（WAC 會計邏輯）、`doc/路過的服務.md` 第 139-163 行（S6 現貨到站就做清單）、`doc/功能對照補記.md` 第 210-218 行（SPOT會計WAC與對沖） |
| 3.3 | **驗收標準**        | S4, S6 | ❌ **[未實作]** - SPOT OCO 時序圖可重演。<br>- 守護流程在 WS 中斷時能安全撤單/轉市價。<br>- WAC 能正確計算已/未實現損益。<br>**📚 參考**：`doc/核心時序圖.md` 第 100-150 行（SPOT OCO 時序圖）、`doc/integration-appendix.md` 第 100-200 行（驗收標準與測試策略） |

---

## 階段四：標籤與復盤 (S7+S8) 與監控 (S11) (Phase 4: Analytics & Observability) ❌ **[未實作]**

**目標**：能產生 12/24/36h 淨利標籤；自動復盤；前端看到關鍵指標與告警。

**📚 參考文檔**：
- `doc/白皮書.md` 第 250-400 行：S7-S8-S11 詳細規格
- `doc/服務與資料流.md` 第 300-400 行：S7-S8-S11 功能矩陣
- `doc/定時任務.md` 第 300-400 行：S7-S8-S11 定時任務
- `doc/integration-appendix.md` 第 200-300 行：標籤回填與復盤流程
- `doc/全服務一覽.md` 第 200-300 行：S7-S8-S11 服務清單
- `doc/路過的服務.md` 第 165-229 行：S7-S8-S11 到站就做清單
- `doc/功能對照補記.md` 第 149-201 行：標籤回填、復盤、指標告警

|  #  | 任務 (Task)        | 涉及服務        | 產出物 / DoD (Definition of Done)                                                                                |
| :-: | :--------------- | :---------- | :------------------------------------------------------------------------------------------------------------ |
| 4.1 | **S7 - 標籤回填**    | **S7**      | ❌ **[未實作]** - 實現定時批次任務，為 `signals` 表中所有到期的信號計算並回填真實的**淨利標籤 (Net ROI)**。<br>- `ROI_net = (PnL - Fees - Funding) / Margin`。<br>**📚 參考**：`doc/白皮書.md` 第 250-300 行（S7 詳細規格）、`doc/服務與資料流.md` 第 300-350 行（S7 功能矩陣）、`doc/定時任務.md` 第 300-350 行（標籤回填任務）、`doc/integration-appendix.md` 第 200-250 行（標籤回填流程）、`doc/路過的服務.md` 第 165-177 行（S7 到站就做清單）、`doc/功能對照補記.md` 第 149-154 行（標籤回填12/24/36h） |
| 4.2 | **S8 - 復盤報告生成**  | **S8**      | ❌ **[未實作]** - 實現 `POST /autopsy` 接口。<br>- 聚合交易的所有相關數據，計算 TCA、Peer 對比、反事實等高級指標，並渲染成報告。<br>**📚 參考**：`doc/白皮書.md` 第 300-350 行（S8 詳細規格）、`doc/服務與資料流.md` 第 350-400 行（S8 功能矩陣）、`doc/定時任務.md` 第 350-400 行（復盤生成任務）、`doc/integration-appendix.md` 第 250-300 行（復盤報告流程）、`doc/路過的服務.md` 第 179-190 行（S8 到站就做清單）、`doc/功能對照補記.md` 第 155-160 行（復盤Autopsy） |
| 4.3 | **S11 - 指標與健康度** | **S11**     | ❌ **[未實作]** - 實現指標的聚合與健康度計算。<br>- 根據「失效偵測門檻表」，計算出全局的 `GREEN/YELLOW/ORANGE/RED` 健康狀態，寫入 Redis。<br>**📚 參考**：`doc/白皮書.md` 第 350-400 行（S11 詳細規格）、`doc/服務與資料流.md` 第 400-450 行（S11 功能矩陣）、`doc/定時任務.md` 第 400-450 行（健康合成任務）、`doc/全服務一覽.md` 第 250-300 行（S11 服務清單）、`doc/路過的服務.md` 第 216-229 行（S11 到站就做清單）、`doc/功能對照補記.md` 第 176-202 行（指標/告警與失效偵測） |
| 4.4 | **驗收標準**         | S7, S8, S11 | ❌ **[未實作]** - 新信號能於 H 小時後看到 label。<br>- 大盈虧/停滯自動產生 Autopsy。<br>- Grafana 面板可視化 SLI/SLO 指標。<br>**📚 參考**：`doc/integration-appendix.md` 第 200-300 行（驗收標準與測試策略）、`doc/全服務一覽.md` 第 200-300 行（S7-S8-S11 服務清單） |

---

## 階段五：配置中心與治理 (Phase 5: Configuration & Governance) ❌ **[未實作]**

**目標**：規則/因子/標的以 Bundle 管理；Lint、Dry-run、模擬＋敏感度；Promote/Canary/Ramp/回滾；全域熱載。

**📚 參考文檔**：
- `doc/白皮書.md` 第 400-600 行：S10 配置服務詳細規格
- `doc/服務與資料流.md` 第 400-450 行：S10 功能矩陣
- `doc/OpenAPI 3.1.yaml` 第 200-400 行：配置相關 API
- `doc/定時任務.md` 第 450-500 行：配置熱加載任務
- `doc/路過的服務.md` 第 1-100 行：路過服務處理邏輯
- `doc/路過的服務.md` 第 205-214 行：S10 到站就做清單
- `doc/功能對照補記.md` 第 62-70 行：規則DSL/Lint/Dry-run/熱載

|  #  | 任務 (Task)      | 涉及服務       | 產出物 / DoD (Definition of Done)                                                                                     |
| :-: | :------------- | :--------- | :----------------------------------------------------------------------------------------------------------------- |
| 5.1 | **S10 - 配置服務** | **S10**    | ❌ **[未實作]** - 實現 `Config Bundle` 的完整生命週期管理 API (`/bundles`, `/simulate`, `/promote`)。<br>- 實現 Redis Pub/Sub 的 `cfg:events` 廣播。<br>**📚 參考**：`doc/白皮書.md` 第 400-500 行（S10 詳細規格）、`doc/服務與資料流.md` 第 400-450 行（S10 功能矩陣）、`doc/OpenAPI 3.1.yaml` 第 200-400 行（配置相關 API）、`doc/定時任務.md` 第 450-500 行（模擬+敏感度任務）、`doc/路過的服務.md` 第 205-214 行（S10 到站就做清單）、`doc/功能對照補記.md` 第 168-175 行（配置中心模擬+敏感度+Promote） |
| 5.2 | **核心服務熱加載**    | S3, S4, S6 | ❌ **[未實作]** - 為核心服務實現 Config Watcher 和 RCU（Read-Copy-Update）原子性熱加載邏輯。<br>**📚 參考**：`doc/白皮書.md` 第 500-600 行（熱加載機制）、`doc/定時任務.md` 第 450-500 行（配置熱加載任務）、`doc/路過的服務.md` 第 1-100 行（路過服務處理邏輯）、`doc/功能對照補記.md` 第 1-100 行（功能對照） |
| 5.3 | **驗收標準**       | S10, S3    | ❌ **[未實作]** - 新規則能跑過 Lint/Dry-run/模擬＋敏感度並以 Canary 上線。<br>- 越界自動回滾。<br>- 核心服務 RCU 熱載無停機。<br>**📚 參考**：`doc/integration-appendix.md` 第 300-400 行（驗收標準與測試策略）、`doc/功能對照補記.md` 第 100-200 行（功能對照）、`doc/全服務一覽.md` 第 300-336 行（S10 服務清單） |

---

## 階段六：研究與一致性 (S9)＋成本學習 (Phase 6: Research & Consistency) ❌ **[未實作]**

**目標**：假設/實驗回測、WF；線上/離線 TCA 校準；路由參數再估。

**📚 參考文檔**：
- `doc/白皮書.md` 第 600-800 行：S9 實驗框架詳細規格
- `doc/服務與資料流.md` 第 450-500 行：S9 功能矩陣
- `doc/定時任務.md` 第 500-600 行：S9 實驗任務與成本學習
- `doc/integration-appendix.md` 第 400-456 行：研究一致性與成本校準
- `doc/功能對照補記.md` 第 200-239 行：功能對照與補充說明
- `doc/路過的服務.md` 第 192-203 行：S9 到站就做清單
- `doc/功能對照補記.md` 第 161-230 行：假設/實驗、成本學習、停滯交易觸發

|  #  | 任務 (Task)     | 涉及服務    | 產出物 / DoD (Definition of Done)                                         |
| :-: | :------------ | :------ | :--------------------------------------------------------------------- |
| 6.1 | **S9 - 實驗框架** | **S9**  | ❌ **[未實作]** - 實現 `POST /experiments/run` 接口，接收結構化的「假設」，並自動執行 Walk-Forward 回測與統計檢定。<br>**📚 參考**：`doc/白皮書.md` 第 600-700 行（S9 詳細規格）、`doc/服務與資料流.md` 第 450-500 行（S9 功能矩陣）、`doc/定時任務.md` 第 500-550 行（實驗任務）、`doc/integration-appendix.md` 第 400-456 行（實驗框架流程）、`doc/路過的服務.md` 第 192-203 行（S9 到站就做清單）、`doc/功能對照補記.md` 第 161-167 行（假設/實驗回測/GA） |
| 6.2 | **成本學習與校準**   | S9, S11 | ❌ **[未實作]** - 建立月度批次任務，比較線上真實滑價與回測模型的偏差。<br>- 若偏差 `>20%` 則觸發告警，提示需要校準滑價模型。<br>**📚 參考**：`doc/白皮書.md` 第 700-800 行（成本學習機制）、`doc/定時任務.md` 第 550-600 行（成本學習任務）、`doc/integration-appendix.md` 第 400-456 行（成本校準流程）、`doc/功能對照補記.md` 第 200-239 行（功能對照）、`doc/功能對照補記.md` 第 203-224 行（回測一致性檢查與成本學習） |
| 6.3 | **驗收標準**      | S9, S11 | ❌ **[未實作]** - 可通過 API 提交一個假設並完成端到端的回測驗證。<br>- 月度 TCA 偏差報表能正常產出。<br>**📚 參考**：`doc/integration-appendix.md` 第 400-456 行（驗收標準與測試策略）、`doc/功能對照補記.md` 第 200-239 行（功能對照）、`doc/全服務一覽.md` 第 300-336 行（S9-S11 服務清單） |

---

## （補充）A. 全域資料契約與「到站即做」寫入點

> **目的**：不變更任何既有描述與公式，僅增加「資料去哪裡、何時寫、寫什麼鍵」的工程落地說明，方便分工與契約測試。

**📚 參考文檔**：
- `doc/白皮書.md` 第 900-1200 行：Redis Streams、Redis Keys、ArangoDB Collections 完整規格
- `doc/服務與資料流.md` 第 1-50 行：資料面與事件匯流
- `doc/integration-appendix.md` 第 1-100 行：資料契約與寫入點
- `doc/路過的服務.md` 第 301-316 行：到站要寫哪裡速查表

### A.1 Redis Streams（事件匯流；Cluster 哈希標籤示例）

* `mkt:{events}:{symbol}`：S1 產生（Ticker/Depth/Funding/Account）；**消費者**：S2、S4（可選）
* `feat:{events}:{symbol}`：S2 產生（已對齊特徵快照）；**消費者**：S3
* `ord:{cmd}:{market}`：S3/S6 產生（意圖/執行策略）；**消費者**：S4
* `ord:{result}:{market}`：S4 產生（成交、狀態、TCA 欄位）；**消費者**：S6、S5、S7、S11
* `pos:{events}:{market}`：S6 產生（PENDING/ACTIVE/EXIT/STAGNATED…）；**消費者**：S8、S11
* `cfg:{events}`：S10 產生（rev 切換、Canary/Ramp）；**消費者**：S2/S3/S4/S6/S12
* `metrics:{events}`：各服務上拋（路由 p95、maker\_fill\_ratio…）；**消費者**：S11

> **Stream 欄位最小集合**：`ts`、`source`、`kind`、`payload(json)`、`config_rev`（若適用）。

### A.2 Redis Keys（強一致計數與快照）

* `risk:{budget}:fut_margin:cap` / `risk:{budget}:fut_margin:inuse`（整體保證金上限/使用量；S3 檢查、S6 釋放）
* `risk:{concurrency}:{symbol}`（同市場併發限制；S3 檢查、S6 關閉釋放）
* `prod:{kill_switch}`（全域停機；S12 設置，S3/S4/S6 讀取）
* `prod:{active_rev}`（快取 `config_active.rev`；S10 更新，其他服務讀）
* `prod:{regime}:market:state`（日度 Regime 結果；S2 更新，S3/S4 讀）
* `lock:{pos}:{symbol}`、`lock:{treasury}:{from}:{to}`（分散鎖；S6/S12/S1 使用）
* `prod:{exec}:twap:queue`（ZSet；成員=子單 id，score=執行時間；S4 消費）

### A.3 ArangoDB Collections（寫入觸點）

* `signals`（S3 寫入 decisions 與決策時刻特徵快照）
* `orders` / `fills`（S4 寫入；`fills.mid_at_send`, `book_top3`, `slippage_bps`）
* `positions_snapshots`（S6 寫入；秒級或事件級）
* `funding_records`（S1 寫入）
* `labels_12h/24h/36h`（S7 更新）
* `autopsy_reports`（S8 生成）
* `config_bundles` / `config_active` / `promotions` / `simulations`（S10 全權）
* `metrics_timeseries` / `strategy_metrics_daily`（S11 彙整）
* `holdings_spot_snapshots`（S6 會計）

---

## （補充）B. Phase 細節：資料路徑、DB/Redis、相依與驗收擴充

> **說明**：僅新增敘述，不修改原清單與公式。

**📚 參考文檔**：
- `doc/白皮書.md` 第 1200-1400 行：各 Phase 詳細實作規格
- `doc/服務與資料流.md` 第 1-402 行：完整服務功能矩陣
- `doc/定時任務.md` 第 1-311 行：各服務定時任務詳解
- `doc/integration-appendix.md` 第 1-456 行：Phase 細節與驗收擴充
- `doc/路過的服務.md` 第 241-298 行：代表性流程逐站行為明細

### B.0 Phase 0（環境與骨架）

* **到站即做**：建立 `Init Job`（Arango collection/index 自檢自建）；建立 `ConfigMap`：`redis.yaml`, `arango.yaml`, `exchanges.yaml`。
* **觀測性**：每個服務 `/health` 回 `Status=OK|DEGRADED|FAIL`，含依賴檢查（Redis ping、Arango ping、WS 心跳）。
* **驗收擴充**：Prometheus 可抓取每服務 `up`、`build_info`、`request_duration_seconds_bucket`。

### B.1 Phase 1（S1→S2→S3 乾跑）

* **S1**

  * **入**：交易所 WS/REST。
  * **出**：`mkt:{events}:{symbol}`（每筆附 `ts_exch`, `ts_ingest`）；`funding_records`（8 小時一筆）。
  * **補償**：WS 中斷→按指數退避；REST 限流→重試 + 降頻；落「連續空洞」告警到 `metrics:{events}`。

* **S2**

  * **入**：`mkt:*`。
  * **處**：特徵齊次化（同 timebase）、ATR/RV/ρ、`Regime`（每日 00:05 刷新 `prod:{regime}:market:state`）。
  * **出**：`feat:{events}:{symbol}`；必要時把特徵快照冪等寫入 `signals.features`（同 `signal_id`）。

* **S3**

  * **入**：`feat:*`、`prod:{active_rev}`、`prod:{kill_switch}`、風險 key。
  * **處**：L0 守門→靜態規則→產 `OrderIntent`（期貨/現貨可共用）。
  * **出**：`signals`（`decision` 節點 + `config_rev`）、`ord:{cmd}:{market}`。
  * **驗收擴充**：`signals` 連續 24h 無斷層；`config_rev` 一致。

### B.2 Phase 2（FUT 執行）

* **S4**

  * **入**：`ord:{cmd}:FUT`。
  * **處**：冪等鍵檢查→限價/市價（市價版起步）→收集成交填 `TCA` 欄位。
  * **出**：`orders`（NEW/…/FILLED）、`fills`、`ord:{result}:FUT`。
  * **Redis**：TWAP 尚未啟用時，保留 `prod:{exec}:twap:queue` 空。

* **S6**

  * **入**：`ord:{result}:FUT`。
  * **處**：更新 `positions_snapshots`、固定 SL/TP 判斷→必要時發平倉 `ord:{cmd}:FUT`。
  * **出**：`pos:{events}:FUT`（PENDING/ACTIVE/EXIT）。

* **S5**

  * **入**：按需 HTTP `POST /reconcile`。
  * **處**：以 API 為準做集合差；僅記錄差異（Phase 2 不修）。
  * **出**：`strategy_events` 差異記錄；`alerts`（ERROR 級）。

* **驗收擴充**：

  * **Jaccard**（API vs DB 開單集合）達門檻；`/orders` p95≤800ms；冪等重試覆蓋 429/5xx。

### B.3 Phase 3（SPOT 擴充）

* **S4**

  * **處**：市場=SPOT；優先原生 OCO；不支援→守護停損（本地監控當前價達停損先撤入場）。
  * **DB**：同 `orders`/`fills`；`fills` 保留 `mid_at_send` 與 `slippage_bps` 計算欄。

* **S6**

  * **處**：SPOT WAC 會計（加買更新 `WAC'`；賣出產已實現 PnL）；持久化 `holdings_spot_snapshots`。
  * **Redis**：`lock:{pos}:{symbol}` 在守護場景避免雙重操作。

* **驗收擴充**：WS 中斷場景下守護能安全撤換單；WAC 與已/未實現損益對賬一致。

### B.4 Phase 4（S7/S8/S11）

* **S7**

  * **入**：`signals`、`fills`、`funding_records`。
  * **處**：按 H=12/24/36h 聚合，計算

    * `ROI_net = (PnL - Fees - Funding)/Margin`（**保留原公式，不變更**）
  * **出**：`labels_H` upsert；必要時 `labels:ready` 事件。

* **S8**

  * **入**：`pos:{events}`（EXIT/STAGNATED）；`orders/fills/signals/metrics`。
  * **處**：TCA、Peer 分位、反事實；渲染報告→MinIO。
  * **出**：`autopsy_reports`（meta + URL）。

* **S11**

  * **入**：`metrics:{events}` + DB 聚合。
  * **處**：maker\_fill\_ratio、ib\_rate、模型 AUC/Brier、router\_p95、stream\_lag 等合成健康；
  * **出**：`prod:{health}:system:state`（GREEN/YELLOW/ORANGE/RED）。

### B.5 Phase 5（S10 配置治理）

* **S10**

  * **入**：`/bundles`、`/simulate`、`/promote`。
  * **處**：Lint、Dry-run（Jaccard/skip\_rate/size\_mult>1 比率）、模擬重放、敏感度（flip\_pct、Local Lipschitz）；守門通過→更新 `config_active` 並發 `cfg:{events}`。
  * **出**：`config_active`、`promotions`、`simulations`；Redis `cfg:{events}`。

* **各服務**

  * **處**：收到 `cfg:{events}` → 拉 `GET /active` → RCU 熱載；`signals`/`orders` 附 `config_rev`。

### B.6 Phase 6（S9 研究一致性）

* **S9**

  * **入**：`hypotheses` / API；歷史 DB/檔湖。
  * **處**：WF/檢定，產 `experiments`；月度 TCA 偏差（live vs bt）>20% → `alerts`。
  * **出**：`experiments` 報告；可回饋 S10 形成新 bundle 草案。

---

## （補充）C. 定時任務與事件對照（工程排程用）

**📚 參考文檔**：
- `doc/定時任務.md` 第 1-311 行：完整定時任務與算法詳解
- `doc/服務與資料流.md` 第 1-402 行：事件對照與資料流
- `doc/白皮書.md` 第 1400-1500 行：定時任務規格與 SLA/SLO

| 作業        | 所屬  | 觸發       | 輸入                       | 輸出（DB/Redis）                    | SLA/SLO（建議）                    |
| --------- | --- | -------- | ------------------------ | ------------------------------- | ------------------------------ |
| 心跳巡檢      | S1  | 30s      | 交易所 / 本地時鐘               | `metrics:{events}`              | RTT p95 `<` 300ms；時偏 `<` 500ms |
| WS 重連掃描   | S1  | 10s + 事件 | WS                       | `metrics:{events}`              | 成功率 `>99.9%`                   |
| 特徵回補      | S2  | 1h/手動    | `mkt:*`                  | `feat:*` / `signals.features`   | 缺口 1h 內補齊                      |
| Regime 更新 | S2  | 00:05    | 日線 RV                    | `prod:{regime}:market:state`    | 成功率 `>99.9%`                   |
| 決策心跳      | S3  | 10s      | `feat:*`                 | `signals` / `ord:cmd:*`         | 補洞延遲 `<` 30s                   |
| TWAP tick | S4  | 1–3s     | `prod:{exec}:twap:queue` | `orders/fills` / `ord:result:*` | 子單延遲 p95 `<` 1s                |
| 殘單清理      | S4  | 1–5m     | API + DB                 | `orders` 更新 / `alerts`          | 孤兒清理 `<` 5m                    |
| 對帳        | S5  | 10–15m   | API + DB                 | `strategy_events` / `alerts`    | Jaccard `>` 閾值                 |
| 持倉 tick   | S6  | 10–30s   | 市價 + DB                  | `pos:{events}` / `orders`       | SL 更新延遲 `<` 2s                 |
| 自動劃轉      | S6  | 5m       | 餘額                       | `strategy_events` / `alerts`    | 失敗重試 N 次                       |
| 標籤回填      | S7  | 15m      | `signals/fills/funding`  | `labels_H`                      | H+15m 完成                       |
| 復盤生成      | S8  | 1h/事件    | 多表                       | `autopsy_reports`               | 觸發後 `<` 10m                    |
| 模擬＋敏感度    | S10 | 手動/夜間    | `signals`                | `simulations`                   | 規模 N=10k `<` 5m                |
| 健康合成      | S11 | 10s      | `metrics:{events}`       | `prod:{health}:system:state`    | 延遲 `<` 10s                     |

---

## （補充）D. 測試與驗收擴充（契約測試焦點）

**📚 參考文檔**：
- `doc/integration-appendix.md` 第 1-456 行：完整測試與驗收擴充
- `doc/字段校驗表.md` 第 1-241 行：字段校驗與契約測試
- `doc/OpenAPI 3.1.yaml` 第 1-648 行：API 規格與測試用例

* **S3→S4 `/orders`**：冪等（同 `intent_id` 重送）、429/5xx 退避、部分成交→`ord:result` 聚合一致。
* **S4→DB**：`orders/fills` 欄位完整（含 `mid_at_send`, `slippage_bps`）。
* **S6 撤舊掛新**：停損序列正確、鎖 `lock:{pos}:{symbol}` 生效、失敗補償回滾策略。
* **S10 `/simulate`**：flip\_pct 超閾值、Jaccard 過低、bounds out-of-range → 正確拒絕。
* **S11 健康度**：故障注入時（maker\_fill\_ratio 下降、ib\_rate 升高）→ health 逐級降級，S3/S4 行為跟著收斂（size\_mult、maker\_wait）。

---

## （補充）E. 風險守門與降級矩陣（落地提示）

**📚 參考文檔**：
- `doc/白皮書.md` 第 1500-1600 行：風險控制與降級策略
- `doc/定時任務.md` 第 250-311 行：風險監控與降級任務
- `doc/服務與資料流.md` 第 1-50 行：風險守門機制

* **Health→行為映射**（示例）

  * `GREEN`：`size_mult ×1.0`、`maker_wait = base`、`market_ratio = 0.3`
  * `YELLOW`：`size_mult ×0.8`、`maker_wait +25%`、`market_ratio = 0.2`
  * `ORANGE`：`size_mult ×0.5`、`maker_wait +50%`、`market_ratio = 0.1`
  * `RED`：**禁止新倉**、僅管理既有倉位

> **說明**：上表僅補充執行層「如何根據健康度聯動調參」，不改動任何數學公式與原有敘述。

---

## （補充）F. 開發落地備忘（只增補，不更動原文）

**📚 參考文檔**：
- `doc/白皮書.md` 第 1600-1765 行：開發落地備忘與 Runbook
- `doc/服務與資料流.md` 第 1-50 行：事件冪等與背壓策略
- `doc/定時任務.md` 第 1-50 行：背壓策略與灰階策略
- `doc/路過的服務.md` 第 1-343 行：路過服務處理與 Runbook
- `doc/路過的服務.md` 第 8-16 行：記號與通用規則
- `doc/功能對照補記.md` 第 233-239 行：共通守門與邊界

* **RCU 熱載**：新 `config_rev` 到站後，**同一筆**決策/下單/寫庫需保持版本一致；跨請求以 `rev` 界定。
* **事件冪等**：Streams 消費以 group 消費者；每筆處理完畢前**不可 ack**；失敗可重試不產生副作用（靠冪等鍵）。
* **背壓策略**：S1/S2/S4 寫庫採「批次 + 時窗」（例如 100 筆或 200ms 先到者寫入）。
* **灰階策略**：S10 Canary 10%→Ramp 50%→Full；任何守門越界自動回滾，事件記錄 `promotions`。
* **Runbook**：

  * **Kill-switch**：S12 設 `prod:{kill_switch}=ON`；S3/S4 讀到即停新倉。
  * **孤兒單**：S5 標記→S4 撤單；若撤失敗→升級告警並進入 DEGRADED。

---

## 📊 實作進度總結

### ❌ 全部未實作 (0%)
- **Phase 0**：基礎設施與骨架（雲端環境、K8s、資料庫、監控、項目初始化）
- **Phase 1**：最小可用資料鏈（服務框架、S1交易所連接器、S2特徵生成器、ArangoDB初始化、S10配置服務）
- **Phase 2**：下單與執行面（S3策略引擎、S4訂單路由、S6倉位管理、S5對帳器、驗收標準）
- **Phase 3**：現貨SPOT擴充（S4現貨訂單邏輯、S6現貨會計、驗收標準）
- **Phase 4**：標籤與復盤（S7標籤回填、S8復盤報告生成、S11指標與健康度、驗收標準）
- **Phase 5**：配置中心與治理（S10配置服務、核心服務熱加載、驗收標準）
- **Phase 6**：研究與一致性（S9實驗框架、成本學習與校準、驗收標準）

### 🎯 建議開發順序
1. **Phase 0** - 基礎設施與骨架
2. **Phase 1** - 最小可用資料鏈
3. **Phase 2** - 下單與執行面（期貨FUT先行）
4. **Phase 3** - 現貨SPOT擴充
5. **Phase 4** - 標籤與復盤與監控
6. **Phase 5** - 配置中心與治理
7. **Phase 6** - 研究與一致性

### 📋 補充說明
- **全域資料契約**：Redis Streams、Redis Keys、ArangoDB Collections 均未實作
- **定時任務與事件對照**：所有定時任務均未實作
- **測試與驗收擴充**：所有契約測試均未實作
- **風險守門與降級矩陣**：所有風險控制機制均未實作
- **開發落地備忘**：所有開發落地細節均未實作

> **結語**：以上所有階段、任務、補充說明均標記為「未實作」，可作為完整的開發路線圖參考，按照建議順序逐步完成 Project Chimera 的全部功能。
