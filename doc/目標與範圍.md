# 目標與範圍

**實作進度：12/12 服務基礎架構已完成，但核心功能均未實作 (15%)**

## A. 目標與範圍

**目標**：在真實交易前，完成 S3（Strategy Engine）與 S4（Order Router）的生產級落地：
L0 守門→規則 DSL→（可接 ML 分數）→ 產生 FUT/SPOT 下單意圖 → 智能執行（Maker→Taker、TWAP、OCO/SL/TP）→ 事件與持久化 → 指標與告警。

**不在本波**：ML 訓練（S9）、復盤（S8）完整產物、Promote 流程（S10 全量）。S3 可先支援 ML 分數為常數或 Mock 值。

**實作狀態**：
- ⚠️ **S3 Strategy Engine**：L0守門、規則DSL、ML分數、下單意圖 **[基礎架構完成，核心功能未實作]**
- ⚠️ **S4 Order Router**：智能執行、Maker→Taker、TWAP、OCO/SL/TP **[基礎架構完成，核心功能未實作]**

## B. 前置依賴（可 Mock）

### ArangoDB ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ 已建 collections & 索引，或以初始化腳本先建立
- ❌ `instrument_registry`（取 tickSize/stepSize/minNotional/spread/depth 門檻）
- ❌ `factor_registry`、`strategy_rules`、`config_active/config_bundles`
- ❌ `signals`、`orders`、`fills`、`positions_snapshots`、`strategy_events`

### Redis Cluster ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ key/stream 已在 v3 白皮書定義
- ❌ **讀**：`cfg:active_rev`、`cfg:events`（RCU 熱載）、`mkt:tick:{symbol}`、`mkt:depth:{symbol}`
- ❌ **寫**：`orders:intent`、`orders:executed`、`router:events`、`alerts`
- ❌ **分散鎖**：`lock:pos:{symbol}`、**冪等**：`idem:order:{client_order_id}`

### 配置 ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ **ConfigMap**：S3_ / S4_ 開頭（下方「環境變數」給全表）
- ❌ **交易所金鑰**（僅在最終接線上時啟用）
- ❌ 先接 Binance Testnet 或 Exchange Stub

## C. S3 Strategy Engine — 任務分解 ⚠️ **[基礎架構完成，核心功能未實作]**

### C1. API 與健康檢查 ⚠️ **[基礎架構完成，核心功能未實作]**

- ✅ **GET /health**：基礎健康檢查已完成
- ❌ **GET /health**：回傳依賴（Redis、Arango、Config rev、Rules loaded N）
- ❌ **POST /decide**
  - **入**：`{ symbol, sideHint?, dry_run?, context? }`
  - **出**：`{ decision: open|skip, intent?, reason, config_rev, rules_fired[] }`
- ❌ **（可選）POST /decide/batch**

### C2. Config Watcher（RCU 熱載）❌ **[未實作]**

- ❌ **來源**：`config_active.rev`（Arango/Redis）；事件：`cfg:events`
- ❌ **流程**：取得 `bundle_id, rev` → 拉取 `strategy_rules/flags` → 本地 Lint 再替換
- ❌ **版本一致性**：進行中判斷使用舊；下一筆切新版；`signals.config_rev` 落地

### C3. 決策管線（演算法）❌ **[未實作]**

- ❌ **取特徵**：從 `signals.features` 或即時計算快取（`feat:last:{symbol}`）

- ❌ **L0 守門**：
  - `funding_next_abs ≤ max_funding_abs`
  - `spread_bps ≤ spread_bp_limit`、`depth_top1_usdt ≥ min`
  - 風險預算：`risk.budget.*`、`concurrent_entries_per_market`

- ❌ **L1 規則 DSL**（白名單、clamp、短路 skip_entry）

- ❌ **L2 ML 分數**（暫以 mock：`p=0.65 → size_mult_ml=1.0`）

- ❌ **Sizing（FUT）**：`margin=20*size_mult`；`notional=margin*leverage`；`qty=round(notional/price, stepSize)`

- ❌ **SL/TP**：
  - `d_atr = ATR_mult*ATR`；`d_cap = max_loss_usdt/qty`；`d=min(...)`
  - 多單：`SL=entry-d`；TP 以「淨利≥10%」反推

- ❌ **SPOT**：`qty=floor(quote_budget/price, stepSize)`；OCO tp/sl 由策略或固定距離

- ❌ **意圖輸出**：FUT 或 SPOT；附 `exec_policy`（Maker→Taker/TWAP/OCO）與 `client_order_id`

### C4. 持久化與事件 ❌ **[未實作]**

- ❌ `signals` 寫入：`{signal_id,t0,symbol,features,decision,config_rev}`
- ❌ 發布至 `orders:intent`（Stream）與 REST 直呼 S4（兩條路皆可，建議雙軌先保險）

### C5. 冪等 & 鎖 ❌ **[未實作]**

- ❌ `client_order_id` 生成規則：`{svc}-btc-TS-rand`；Redis `SETNX idem:order:{id}=1 ttl=1h`
- ❌ 同 symbol 單次決策：`lock:pos:{symbol}`（最大 3s），避免重覆 open

### C6. 指標與告警 ❌ **[未實作]**

- ❌ `strategy.decide.latency_ms`、`rules.fired.count`、`gate.skip.count`
- ❌ **告警**：無規則可用、配置與本地 rev 不一致、決策產生但發布失敗

### C7. 測試與驗收 ❌ **[未實作]**

- ❌ **單元**：L0/L1/L2、sizing、SL/TP 反解、clamp、skip 短路
- ❌ **契約**：POST /decide schema 正確；dry_run 不落地 intent
- ❌ **整合**：與 S4 stub；亂流（spread/depth 異常）能正確 skip

- ❌ **驗收（Ready）**
  - 1000 筆模擬特徵決策 ≤ 200ms/P50、≤ 500ms/P95
  - 風險守門全覆蓋；決策落 signals 且 config_rev 正確
  - 意圖可同時走 REST 與 Stream；冪等生效

## D. S4 Order Router — 任務分解 ⚠️ **[基礎架構完成，核心功能未實作]**

### D1. API 與健康檢查 ⚠️ **[基礎架構完成，核心功能未實作]**

- ✅ **GET /health**：基礎健康檢查已完成
- ❌ **GET /health**：連線（Exch、Redis、Arango）、路由表 rev、CB 狀態
- ❌ **POST /orders**

**入（FUT）**：
```json
{
  "intent_id":"uuid","market":"FUT","symbol":"BTCUSDT","side":"BUY",
  "qty":0.002,"exec_policy":{"maker_wait_ms":2000,"twap":{"slices":2,"gap_ms":600}},
  "sl":{"type":"STOP_MARKET","price":64800},
  "tp":{"type":"TAKE_PROFIT_MARKET","target":"net_profit_usdt","value":2.0},
  "client_order_id":"s3-btc-...","reduce_only":false
}
```

**入（SPOT-OCO）**：
```json
{
  "intent_id":"uuid","market":"SPOT","symbol":"BTCUSDT","side":"BUY",
  "qty":0.003,"exec_policy":{"type":"OCO","tp_price":67000,"sl_price":64500},
  "client_order_id":"s3-btc-..."
}
```

- ❌ **出**：`{ result: OK|FAIL, order_ids[], message? }`
- ❌ **POST /cancel**：按 order_id 或 client_order_id 撤單

### D2. 路由策略（Maker→Taker / TWAP / 流動性探測）❌ **[未實作]**

- ❌ **Maker 等待** `wait_ms = f(notional)`（路由表）
- ❌ 不足量或超時 → cancel → 市價（或限價追 1 檔）
- ❌ **TWAP**：按 slices/gap_ms 切片，支援 ± 抖動
- ❌ **流動性探測**：下單前查 spread_bps、top1_depth；過閾值延時或改拆單

### D3. 交易規則與 rounding ❌ **[未實作]**

- ❌ 檢查 minNotional、tickSize/stepSize；round_to_tick/step
- ❌ **FUT**：設 marginType=ISOLATED、leverage=20（若尚未設）
- ❌ **FUT**：市價開倉成交後，立即下 STOP_MARKET（workingType=MARK_PRICE、reduceOnly）
- ❌ **TP**：TAKE_PROFIT_MARKET 或由 S6 管理（本波可先由 S4 挂單）
- ❌ **SPOT**：交易所 OCO 支援則直用；否則 客戶端守護（WS/輪巡）確保一腿成交另一腿撤銷

### D4. 冪等／熔斷／錯誤重試 ❌ **[未實作]**

- ❌ `idem:order:{client_order_id}` 保證一次性
- ❌ **熔斷**：近 60s 內 5xx/429 超閾值 → CB=OPEN（暫停新開，允許平倉與風險操作）
- ❌ **重試**：網路超時 N 次內退避重試；重試仍失敗 → 發 alerts

### D5. 事件與持久化 ❌ **[未實作]**

- ❌ 寫 orders/fills；Stream `orders:executed`、`router:events`
- ❌ fills 記錄 mid_at_send、book_top3、slippage_bps
- ❌ **OCO 守護**：維持內部狀態機；任何腿成交→另一腿撤銷；寫 strategy_events

### D6. 指標與告警 ❌ **[未實作]**

- ❌ `router.submit.latency_ms`（P50/P95）、`maker.fill_ratio`、`twap.slice_fill_ratio`
- ❌ `taker.rate`、`slippage.bps.p50/p95`、`fee.usdt.total`
- ❌ **告警**：CB 開啟、maker_fill_ratio 長期過低、insufficient_balance_rate 過高

### D7. 測試與驗收 ❌ **[未實作]**

- ❌ **單元**：四捨五入、最小單位、OCO 守護狀態機、Maker→Taker 回退
- ❌ **契約**：/orders 入出 schema；/cancel 多場景
- ❌ **整合**：串接 Sandbox 或 Stub，驗證 SL/TP/ReduceOnly 行為

- ❌ **驗收（Ready）**
  - 1000 筆連續意圖：成功下單 ≥ 99%，平均延遲 P95 ≤ 500ms
  - 市場極端（大 spread/薄深度）能自動延時/拆分/降級
  - OCO 守護 100% 一腿成交另一腿撤銷；無重覆成交

## E. 環境變數 / ConfigMap（S3/S4）⚠️ **[基礎架構完成，核心功能未實作]**

### S3 ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ `S3_DB_ARANGO_URI`、`S3_DB_ARANGO_USER/PASS`
- ❌ `S3_REDIS_ADDRESSES`（逗號分隔，Cluster 模式）
- ❌ `S3_SYMBOLS`（預設：BTCUSDT，可多）
- ❌ `S3_MAX_FUNDING_ABS`（例 0.0005）
- ❌ `S3_SPREAD_BP_LIMIT_DEFAULT`、`S3_DEPTH_TOP1_USDT_MIN_DEFAULT`
- ❌ `S3_LEVERAGE_DEFAULT=20`、`S3_MARGIN_BASE_USDT=20`
- ❌ `S3_MAX_LOSS_USDT=1.2`、`S3_ATR_MULT=1.5`
- ❌ `S3_CONCURRENT_ENTRIES_PER_MARKET=1`
- ❌ `S3_CONFIG_POLL_SEC=5`

### S4 ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ `S4_EXCHANGE=binance`、`S4_BINANCE_KEY/SECRET`、`S4_TESTNET=true`
- ❌ `S4_REDIS_ADDRESSES`、`S4_DB_ARANGO_*`
- ❌ `S4_ROUTE_TABLE_PATH=/etc/chimera/route.json`
- ❌ `S4_CB_ERROR_RATE_WINDOW=60s`、`S4_CB_ERROR_RATE_THRESH=0.2`
- ❌ `S4_MAKER_MAX_WAIT_MS=3000`、`S4_TWAP_MAX_SLICES=4`
- ❌ `S4_OCO_GUARDIAN=true`
- ❌ `S4_WORKING_TYPE=MARK_PRICE`

## F. 典型驗收情境（Happy + Edge）

### FUT（Happy）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ `/decide` 命中規則 → open BUY、size_mult=1.0 → 發 `/orders`
- ❌ 市價成交 → STOP_MARKET 成功掛上 → TAKE_PROFIT_MARKET 成功掛上
- ❌ orders/fills 正確落地；orders:executed 發送
- ❌ 指標：P95 ≤ 500ms；slippage_bps 在基準區間

### FUT（Edge）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ spread 2× 平均、深度不足 → S3 skip **[S3未實作]**
- ❌ 交易所 429/5xx → S4 重試並可能 CB=OPEN，對外返回 FAIL 與告警 **[S4未實作]**

### SPOT OCO（Happy）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ `/decide` market=SPOT → `/orders`（OCO）
- ❌ 一腿成交 → 守護撤銷另一腿；落地 fills；strategy_events 記錄 OCO_RESOLVE

### SPOT OCO（Edge）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ 交易所不支援 OCO → OCO_GUARDIAN 接管；WS 中斷期間用輪巡確保撤銷

### 冪等 ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
- ❌ `/orders` 相同 client_order_id 重送 → S4 直接回覆已存在/拒絕，無重複下單

## G. 樣本 Fixtures（供單元/整合測試）⚠️ **[基礎架構完成，核心功能未實作]**

### instrument_registry（BTCUSDT）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
```json
{
  "symbol":"BTCUSDT","tickSize":1,"stepSize":0.001,"minNotional":5,
  "spread_bp_limit":3,"depth_top1_usdt_min":200
}
```

### 規則（strategy_rules）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
```json
{
  "rule_id":"R-023","priority":50,
  "applies":{"symbols":["BTCUSDT"],"services":["s3-strategy"]},
  "when":{"allOf":[{"f":"rv_pctile_30d","op":"<","v":0.25},{"f":"rho_usdttwd_14","op":"<","v":-0.3}]},
  "action":{"type":"size_mult","value":1.2},"status":"ENABLED"
}
```

### 路由表（S4）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
```json
[
  {"notional_usdt_max":200,"maker_wait_ms":1500,"twap":{"slices":1,"gap_ms":0}},
  {"notional_usdt_max":500,"maker_wait_ms":2000,"twap":{"slices":2,"gap_ms":600}}
]
```

## H. 風險與緩解

- ⚠️ **時鐘偏移**：下單前先比對 serverTime，偏移>1s 停新倉 **[S4基礎架構完成，核心功能未實作]**
- ⚠️ **資金不足**：偵測到 insufficient balance → 降額再試；連續失敗 → 告警 **[S4基礎架構完成，核心功能未實作]**
- ⚠️ **規則/配置缺失**：無 ENALBED 規則或 factor 缺 → 直接 skip + alert **[S3基礎架構完成，核心功能未實作]**
- ⚠️ **網路波動**：所有 REST 調用退避重試；WebSocket 自動重連 **[S1基礎架構完成，核心功能未實作]**
- ⚠️ **Redis Cluster slot 移轉**：使用官方 cluster client；關鍵操作具重試策略 **[S1-S3基礎架構完成，核心功能未實作]**

## I. 交付物清單（本波完成才算 Done）

- ⚠️ S3 可執行服務（有 GET /health、POST /decide、RCU 熱載、signals 落地）**[基礎架構完成，核心功能未實作]**
- ⚠️ S4 可執行服務（有 GET /health、POST /orders、/cancel、Maker→Taker、TWAP、SPOT OCO/守護、FUT SL/TP 挂單）**[基礎架構完成，核心功能未實作]**
- ⚠️ 配置與路由表（ConfigMap / Secret）**[基礎架構完成，核心功能未實作]**
- ⚠️ 契約測試（schema 驗證、自動化 happy/edge cases）**[基礎架構完成，核心功能未實作]**
- ⚠️ 觀測性（核心 SLI 指標上報；告警到 alerts stream）**[基礎架構完成，核心功能未實作]**
- ⚠️ Runbook（CB 開啟/關閉、OCO 守護異常、撤舊掛新故障處理）**[基礎架構完成，核心功能未實作]**

## J. 快速自測（curl 範例）

### S3 決策（dry run）⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
```bash
curl -X POST http://s3:8080/decide -H 'content-type: application/json' \
  -d '{"symbol":"BTCUSDT","dry_run":true}'
```

### S4 FUT 下單 ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
```bash
curl -X POST http://s4:8080/orders -H 'content-type: application/json' \
  -d '{"intent_id":"uuid-1","market":"FUT","symbol":"BTCUSDT","side":"BUY","qty":0.002,
       "exec_policy":{"maker_wait_ms":2000,"twap":{"slices":2,"gap_ms":600}},
       "sl":{"type":"STOP_MARKET","price":64800}, "client_order_id":"s3-btc-16900001"}'
```

### S4 SPOT OCO ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
```bash
curl -X POST http://s4:8080/orders -H 'content-type: application/json' \
  -d '{"intent_id":"uuid-2","market":"SPOT","symbol":"BTCUSDT","side":"BUY","qty":0.003,
       "exec_policy":{"type":"OCO","tp_price":67000,"sl_price":64500},
       "client_order_id":"s3-btc-16900002"}'
```

### 健康檢查 ⚠️ **[基礎架構完成，核心功能未實作]**
- ✅ 基礎服務架構已完成
```bash
curl http://s3:8080/health
curl http://s4:8080/health
```

---

## 📊 實作進度總結

### ⚠️ 基礎架構完成，核心功能未實作 (15%)
- **S3 Strategy Engine**：基礎架構完成，決策管線、API、健康檢查、配置熱載未實作
- **S4 Order Router**：基礎架構完成，訂單執行、路由策略、交易規則、冪等/熔斷未實作
- **前置依賴**：基礎架構完成，ArangoDB、Redis Cluster、配置管理未實作
- **樣本Fixtures**：基礎架構完成，instrument_registry、strategy_rules未實作
- **風險緩解**：基礎架構完成，規則/配置缺失、網路波動、Redis Cluster未實作
- **驗收情境**：基礎架構完成，FUT/SPOT完整流程、邊界情況處理未實作
- **交付物**：基礎架構完成，S3/S4服務、Runbook未實作
- **自測範例**：基礎架構完成，S3/S4 API調用未實作

### 🎯 建議優先順序
1. **前置依賴** - ArangoDB、Redis Cluster、配置管理
2. **S3 Strategy Engine** - 決策管線核心
3. **S4 Order Router** - 訂單執行核心
4. **驗收情境** - 完整流程測試
5. **交付物** - 生產級部署
6. **Runbook** - 運維文檔

## 📋 詳細實作清單

### S3 Strategy Engine 待實作項目
- [ ] **Config Watcher**：實現配置熱載機制
- [ ] **L0 守門**：實現資金費率、價差、深度檢查
- [ ] **L1 規則 DSL**：實現規則引擎和條件判斷
- [ ] **L2 ML 分數**：實現ML模型分數計算
- [ ] **Sizing 計算**：實現FUT/SPOT倉位大小計算
- [ ] **SL/TP 計算**：實現止損止盈價格計算
- [ ] **信號持久化**：實現signals寫入和Redis Stream發布
- [ ] **冪等機制**：實現client_order_id生成和Redis鎖
- [ ] **指標收集**：實現決策延遲、規則觸發等指標
- [ ] **告警機制**：實現規則缺失、配置不一致等告警

### S4 Order Router 待實作項目
- [ ] **訂單執行**：實現FUT/SPOT訂單下單邏輯
- [ ] **Maker→Taker**：實現Maker等待和Taker回退
- [ ] **TWAP 執行**：實現時間加權平均價格執行
- [ ] **OCO 守護**：實現OCO訂單監控和撤銷
- [ ] **交易規則**：實現tickSize/stepSize檢查和四捨五入
- [ ] **熔斷機制**：實現錯誤率監控和熔斷器
- [ ] **重試機制**：實現網路超時重試和退避策略
- [ ] **事件持久化**：實現orders/fills寫入和事件發布
- [ ] **指標收集**：實現延遲、成交率、滑點等指標
- [ ] **告警機制**：實現熔斷開啟、成交率過低等告警

### 前置依賴待實作項目
- [ ] **ArangoDB Collections**：創建所有必要的集合和索引
- [ ] **Redis Streams**：設置所有必要的Stream和Key
- [ ] **配置管理**：實現ConfigMap和環境變數管理
- [ ] **交易所連接**：實現Binance API連接和認證
- [ ] **WebSocket連接**：實現市場數據WebSocket連接
- [ ] **健康檢查**：實現完整的依賴檢查機制

### 測試與驗收待實作項目
- [ ] **單元測試**：實現所有核心邏輯的單元測試
- [ ] **整合測試**：實現服務間整合測試
- [ ] **契約測試**：實現API契約驗證
- [ ] **性能測試**：實現延遲和吞吐量測試
- [ ] **邊界測試**：實現異常情況處理測試
- [ ] **端到端測試**：實現完整交易流程測試