# Project Chimera — 功能對照、邏輯與算法詳解（公式補完版）

**實作進度：0/12 服務已完成 (0%)**

**目標**：把每一個未實作功能補上可直接落地的數學定義與決策流程，供工程對照開發與單元/契約測試使用。

**約定**：$t$=時間索引（epoch ms）；價格 $P$ 以 USDT；比例用小數（0.1=10%）。長/短倉以符號 $dir \in \{+1,-1\}$ 表示；多倉 $dir=+1$、空倉 $dir=-1$。

---

### 符號與常數約定（通用）

- **對數報酬**：$r_t=\ln(P_t/P_{t-1})$
- **年化因子**：$K$（日線 $\sqrt{365}$；4h $\sqrt{6\times365}$）
- **ATR(EMA, n)**：$ATR_t=\alpha \cdot TR_t+(1-\alpha) \cdot ATR_{t-1},\ \alpha=\frac{2}{n+1}$
- **True Range**：$TR_t=\max\{H_t-L_t, |H_t-C_{t-1}|, |L_t-C_{t-1}|\}$
- **相關係數（滑窗 M）**：$\rho=\frac{\sum (x-\bar x)(y-\bar y)}{\sqrt{\sum(x-\bar x)^2}\sqrt{\sum(y-\bar y)^2}}$
- **百分位名次（含 ties）**：$\text{PctRank}(X)=\frac{C_L+0.5C_E}{N}$
- **ROE（方向內生）**：$\text{PnL} = (P_{\text{exit}}-P_{\text{entry}}) \cdot Q \cdot dir$, $\text{ROE}=\frac{\text{PnL}}{\text{isolated\_margin}}$
- **滑價（bps）**：$\text{slip\_bps} = dir \cdot \frac{P_{\text{fill}}-P_{\text{mid@send}}}{P_{\text{mid@send}}} \cdot 10^4$

---

### 1) USDT/TWD × BTCUSDT 規則信號 — ❌ **[未實作]**（S2/S3）

- **邏輯**:
    - S2 計算兩資產日對數報酬 $r^{\text{usdttwd}}_t, r^{\text{btcusdt}}_t$。
    - S3 以兩日同向 + 首日反向構造方向：
        - **做多**：$r^{\text{usdttwd}}_{t-1}<0 \land r^{\text{usdttwd}}_{t-2}<0 \land r^{\text{btcusdt}}_{t-1}<0$
        - **做空**：$r^{\text{usdttwd}}_{t-1}>0 \land r^{\text{usdttwd}}_{t-2}>0 \land r^{\text{btcusdt}}_{t-1}>0$
    - 可加穩健條件：$|\rho_{14}(\text{usdttwd},\text{btcusdt})|>\rho_{\min}$
- **公式**:
    - **基礎**：$r_t=\ln(P_t/P_{t-1})$
    - **相關性門檻**：$\rho_{14} < -\rho_{\min}$（負相關假設）

### 2) ATR 停損（Regime 倍數 + 風險上限）— ❌ **[未實作]**（S2/S6）

- **邏輯**:
    - S2 產出 $ATR_t$ 與 `Regime` ∈ {FROZEN, NORMAL, EXTREME}。
    - 對應倍數 $k_{\text{regime}}$；初始停損（多）：$SL_0=P_{entry}-k \cdot ATR$（空相反）。
    - 風險上限：不允許首筆損失超過 $\text{RiskCapPct}$ 的保證金。
- **公式**:
    $$
    \begin{aligned}
    SL_0 &= P_{entry} - dir \cdot k_{\text{regime}} \cdot ATR \\
    Loss_{ATR} &= |P_{entry}-SL_0| \cdot Q \\
    Loss_{cap} &= \text{Margin} \cdot \text{RiskCapPct} \\
    SL &= P_{entry} - dir \cdot \min\!\left(\frac{Loss_{cap}}{Q},\ k_{\text{regime}} \cdot ATR\right)
    \end{aligned}
    $$

### 3) 20× 逐倉、保證金 20 USDT、淨利 ≥10% 離場 — ❌ **[未實作]**（S3/S6）

- **邏輯**:
    - 開倉：逐倉，`initial_margin`=20；可用槓桿 $L=20$。
    - S6 監控 $ROE_{net} \ge 0.10$ 觸發平倉（`reduceOnly` 市價）。
- **公式**:
    $$
    ROE_{net}=\frac{(P_{\text{exit}}-P_{\text{entry}}) \cdot Q \cdot dir - \sum \text{Fees} - \sum \text{Funding}}{\text{InitialMargin}} \ge 0.10
    $$

### 4) 規則 DSL／Lint／Dry-run／熱載 — ❌ **[未實作]**（S10/S3）

- **邏輯**:
    - **Lint**：欄位、白名單、值域；依賴因子存在性；合規邊界。
    - **Dry-run**：對近 $N$ 天 `signals` 重放，產出 `skip_rate`/`size_mult>1` 比率/policy shift Jaccard 等。
    - **Promote**：守門閾值通過才切 `config_active.rev`；Redis 廣播，S3 熱載（RCU）。
- **公式（策略位移）**:
    - **Jaccard**：$J=\frac{|D_{\text{new}}\cap D_{\text{ref}}|}{|D_{\text{new}}\cup D_{\text{ref}}|}$

### 5) 置信度模型（推論 + 回退）— ❌ **[未實作]**（S3/S9）

- **邏輯**:
    - S3 對 L1 合格樣本送模型，得 $p=\Pr(\text{success}|X)$。
    - 對應 `size` 多段映射：$p>0.85 \Rightarrow \times1.2$、$0.6-0.85 \Rightarrow \times1.0$、$0.4-0.6 \Rightarrow \times0.5$、$<0.4 \Rightarrow \text{skip}$。
    - 超時/失敗：降級採預設 $\times1.0$（或 DSL 指定）。
- **公式（Logit 範例）**:
    - $p=\sigma(\beta_0+\sum \beta_i X_i),\ \sigma(z)=\frac{1}{1+e^{-z}}$

### 6) FUT 入場與 SL/TP 掛單 — ❌ **[未實作]**（S4/S6）

- **邏輯**:
    - S4 市價入場 → 等 `FILL`（聚合均價 $\bar P$）。
    - 由 S6 計算 $SL, TP$（`reduceOnly=true`）→ 立即掛 `STOP_MARKET` 與 `TAKE_PROFIT_MARKET`。
    - 若掛單失敗 → 重試/降級為守護停損（客戶端監控） 。
- **參考**:
    - **TP（多）**：$TP=\bar P + m \cdot ATR$ 或目標 ROE 反解價格：
    - $TP=\bar P + \frac{(ROE^* \cdot \text{Margin} + \sum \text{Fees})}{Q}$

### 7) SPOT 入場與 OCO/守護停損 — ❌ **[未實作]**（S4）

- **邏輯**:
    - **支援 OCO**：下 `LIMIT_MAKER` + `STOP_LOSS_LIMIT`；撮合引擎保障互斥。
    - **不支援：守護序列**
        - a) 先 `LIMIT_MAKER`；b) 若觸發停損價先到 → 先撤入場 → 視規則可反手；
        - c) 入場成交後 → 立即掛 `STOP_MARKET`。
- **風險守門**:
    - 若預估滑價 > $\text{slip\_bp\_max}$ 或 spread > $\text{spread\_max}$ → 改限價 / 降片。

### 8) 智能執行（Maker→Taker、TWAP）— ❌ **[未實作]**（S4）

- **Maker→Taker**:
    - 等候 $T_{\text{wait}}=f(\text{spread}, \text{depth})$；部分成交比率 $\phi$；剩餘 $(1-\phi)Q$ 以市價完成。
- **TWAP**:
    - 切片 $n=\lceil Q/s \rceil$；時間序列 $t_i=t_0+i \cdot \Delta t$；每片 $q_i=Q/n$ 或曲線加權 $q_i \propto \sqrt{i}$。

### 9) Trailing Stop（撤舊掛新）— ❌ **[未實作]**（S6）

- **邏輯**:
    - ROE 進入更高鎖利階：$\rho\_1,\rho\_2,\dots$；每達一階：撤舊 SL → 新 SL 更靠近當前價。
- **公式（多倉示例）**:
    - **階段 $k$**：$SL_k = \max(SL_{k-1}, P_{entry} + \theta_k \cdot \frac{\text{isolated\_margin}}{Q})$
    - 其中 $\theta_k$ 為第 $k$ 階的 ROE 鎖利門檻。

### 10) 加倉（ROE門檻、上限）— ❌ **[未實作]**（S6）

- **邏輯**:
    - **觸發**：同向新信號 + 當前 $\text{ROE} \ge$ 門檻 + `add_on_count` < cap。
    - **加倉量**：幾何遞減 $Q_{add}(j)=Q_0 \cdot \gamma^j$（$0<\gamma<1$）。

### 11) 分批止盈 — ❌ **[未實作]**（S6）

- **邏輯**:
    - 若 $\text{ROE} \ge \rho_1$ → 平 $\beta_1 Q$；達 $\rho_2$ → 再平 $\beta_2 Q_{\text{remaining}}$ …
    - 每次平倉後重算均價與保證金。

### 12) 資金費率守門 + 記帳 — ❌ **[未實作]**（S3/S7）

- **邏輯**:
    - **S3**：$|\hat f_{next}| > f_{\max} \Rightarrow \text{skip}$。
    - **S7**：對每次 funding 記錄 $\text{funding} = \text{notional} \cdot f$（方向與交易所規格一致），累加入 $ROI_{net}$。

### 13) 風險預算/併發守門 — ❌ **[未實作]**（S3）

- **邏輯**:
    - 進場前檢查：
        - 總保證金占用 $\le$ `risk.budget.fut_margin_usdt_max`
        - 同市場併發 $\le$ `concurrent_entries_per_market`
    - 透過 Redis 原子遞增/遞減，關閉時釋放額度。

### 14) 對帳/事務狀態機 — ❌ **[未實作]**（S5）

- **狀態**:
    - `PENDING_ENTRY` → `ACTIVE` → `PENDING_CLOSING` → `CLOSED`
- **啟動對帳**：以 API 為準修 DB；孤兒單 → 撤單或接管；倉位不一致 → 降風險至 FLAT。
- **度量**:
    - 一致率 Jaccard（訂單集/倉位集）

### 15) 標籤回填（12/24/36h）— ❌ **[未實作]**（S7）

- **公式**:
    - $ROI_{\text{net}}(H)=\frac{\text{PnL}_{[t_0,t_0+H]} - \sum \text{Fees} - \sum \text{Funding}}{\text{Margin}_{[t_0,t_0+H]}}$
- **標籤**：$\ge +\tau \Rightarrow \text{pos}; \le -\tau \Rightarrow \text{neg}; \text{else neutral}$

### 16) 復盤 Autopsy — ❌ **[未實作]**（S8）

- **指標**:
    - 滑價、費用、Funding 瀑布；Peer 分位（同 Regime/方向/名目桶）
    - 反事實：若早/晚 $\Delta t$ 出場之 $\Delta ROI$

### 17) 假設/實驗（回測/GA）— ❌ **[未實作]**（S9）

- **核心績效**:
    - CAGR、Sharpe、Sortino、PF、Hit、MaxDD、Calmar：$\text{Calmar}=\frac{\text{CAGR}}{|\text{MaxDD}|}$
- **檢定**:
    - U-test / bootstrap CI；FDR 控制 $\alpha$

### 18) 配置中心（模擬＋敏感度＋Promote）— ❌ **[未實作]**（S10）

- **差異重放**:
    - 對歷史 `signals` 用新 `bundle` 產生 $\text{trades}_{new}$ 與差異率 $\Delta$。
- **敏感度**:
    - **決策翻轉率**：$\text{flip\_pct}=\frac{\#\{d(x)\neq d(x+\delta)\}}{N}$
    - **Local Lipschitz**（連續輸出 `size_mult`）：$L \approx \text{median} \frac{|f(x+\delta)-f(x)|}{\|\delta\|}$

### 19) 指標/告警（SLI/SLO）— ❌ **[未實作]**（S11）

- **例**:
    - `/orders` 成功率、端到端延遲 p95、WS lag、Stream lag、對帳一致率 J
- **SLO 例**：成功率 $\ge 99.5\%$，p95 $\le 800$ms，WS 可用 $\ge 99.9\%$

### 20) API Gateway / Web UI（代理 + Kill-switch）— ❌ **[未實作]**（S12）

- **邏輯**:
    - 代理各服務 API；RBAC；審批
    - **Kill-switch**：設 `kill_switch=ON` → S3/S4 停止新倉；可選一鍵平倉

### 21) SPOT↔FUT 金庫劃轉（自動/人工）— ❌ **[未實作]**（S12/S6；S1 私有）

- **邏輯**:
    - **自動**：S6 根據 `min_free_fut` 與 `spot_buffer` 計算 `need` → 產生審批請求 → S12 人工批准 → S1 執行
    - **冪等**：`transfer_id` 保證一次且僅一次

### 22) 失效偵測（maker_fill_ratio / ib_rate / AUC / Brier → 動作矩陣）— ❌ **[未實作]**（S11→S3/S4/S6）

- **指標**:
    - **Maker 成交率**：$\text{maker\_fill\_ratio}=\frac{\text{maker\_filled\_qty}}{\text{total\_qty}}$
    - **資金不足率**（SPOT/FUT）：$\text{ib\_rate}=\frac{\#\text{insufficient\_balance}}{\#\text{orders}}$
    - **模型**：AUC（近 100 筆）、Brier Score：$\frac{1}{N}\sum (p_i-y_i)^2$
- **動作矩陣（例）**:
    - AUC↓、Brier↑、`maker_fill_ratio`↓、`ib_rate`↑ → 降級 health：GREEN→YELLOW→ORANGE→RED
    - S3/S4 讀健康度調整 `size_mult`、改市價比例、延長 maker 等待

### 23) 回測一致性檢查（線上/離線 TCA 偏差）— ❌ **[未實作]**（S9/S11）

- **邏輯**:
    - 單月聚合線上滑價/費率均值 $\hat s_{\text{live}},\hat f_{\text{live}}$ 與回測假定 $s_{bt},f_{bt}$ 比較
- **偏差**：$\Delta_s=\frac{|\hat s_{\text{live}}-s_{bt}|}{s_{bt}}$；越界（>20%） → 警示與重擬合

### 24) SPOT 會計（WAC）、庫存/對沖 — ❌ **[未實作]**（S6/S8）

- **WAC（加權平均成本）**:
    - $WAC'=\frac{Q \cdot WAC + Q_{buy} \cdot P_{buy}}{Q+Q_{buy}}$
- **賣出已實現損益**：$\text{PnL}_{real}= (P_{sell}-WAC) \cdot Q_{sell}$
- **未實現損益**：$(P_{mark}-WAC) \cdot Q_{\text{remain}}$
- **對沖**:
    - 目標淨曝險（名目）：$E^*$；以 FUT 調整 $Q_{fut}$ 使 $Q_{spot} \cdot P + Q_{fut} \cdot P \approx E^*$

### 25) 成本學習（TCA→路由表再估）— ❌ **[未實作]**（S11→S4）

- **邏輯**:
    - 以回歸/分段模型擬合：$\widehat{\text{slip\_bps}} = g(\text{spread}, \text{depth}, \text{vol}, \text{regime})$
    - 週期性更新路由參數（`maker_wait`、twap 粒度、限價距離）

### 26) 停滯交易觸發（Autopsy/處置）— ❌ **[未實作]**（S6→S8）

- **邏輯**:
    - 若 $\text{duration} > T_{\text{stagnation}} \land |\text{ROE}|<\rho_{\min}$ → 觸發 `STAGNATED` 事件
    - S8 自動產生復盤，量化機會成本：期間若資金用於 cohort 中位策略的期望收益 $E[\Delta ROI]$

---

### 補充：共通守門與邊界（供實作時直接套用）

- **市價滑價上限**：若估計 $|\Delta P|/P > \text{slip\_bp\_max}$ → 改限價或細分片
- **Maker 等待曲線**：$T_{\text{wait}}=a+b \cdot \frac{1}{\text{spread}}+c \cdot \log(\text{depth}_{top1})$（係數由 TCA 回歸）
- **加倉上限**：$\sum_j Q_{add}(j) \le \eta \cdot Q_0$（$\eta$ 為總加倉倍數上限）
- **Health 降級作用**：在 YELLOW/ORANGE/RED 下，對 `size_mult`, `maker_wait`, `market_ratio`（市價占比）套用遞減/遞增係數矩陣
- **交付提示**：每條邏輯請對應到一個最小可測試單元（Pure Function 或策略模組），用表驅動測試覆蓋邊界值（門檻上下 $\epsilon$）與退化情形（無流動性、大滑價、資金不足、模型超時）。