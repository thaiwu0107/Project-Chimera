# Integration 附錄：核心順序圖 + 參數對照（v3 嵌入版）

**實作進度：0/12 服務已完成 (0%)**

## 概述

本附錄詳細描述了 Project Chimera 交易系統的核心業務流程，包括 FUT 期貨入場、SPOT 現貨入場和對帳處置三個關鍵場景。每個場景都包含完整的順序圖、參數對照表和 JSON 範例，確保開發團隊能夠準確理解和實現系統的業務邏輯。

**實作狀態**：
- ❌ **S1-S3 核心流程**：特徵計算、策略決策、信號生成 **[未實作]**
- ❌ **S4-S6 執行流程**：訂單執行、倉位管理、止損掛單 **[未實作]**
- ❌ **S5 對帳流程**：孤兒處置、狀態修復、保守回收 **[未實作]**

## 設計原則

### 事務一致性
- ❌ **冪等性保證**：所有狀態變更操作都使用 `X-Idempotency-Key` 確保重複請求的安全性 **[未實作]**
- ❌ **狀態機管理**：採用明確的狀態轉換（PENDING_ENTRY → ACTIVE → CLOSED）**[未實作]**
- ❌ **失敗恢復**：系統崩潰後能夠通過對帳機制恢復到一致狀態 **[未實作]**

### 風險控制
- ❌ **保守回收策略**：無法接管的孤兒訂單/持倉優先採用降風險處理 **[未實作]**
- ❌ **多層止損機制**：FUT 使用交易所止損，SPOT 使用 OCO 或守護停損 **[未實作]**
- ❌ **實時監控**：通過 Redis Streams 實現關鍵事件的實時通知 **[未實作]**

### 性能優化
- ❌ **Maker→Taker 回退**：優先使用限價單降低交易成本，超時自動回退到市價單 **[未實作]**
- ❌ **TWAP 執行**：大單拆分執行，減少市場衝擊 **[未實作]**
- ❌ **並行處理**：對帳過程中使用並行查詢提高效率 **[未實作]**

## 1) FUT 入場（Maker→Taker 回退、事務狀態機、SL 掛單）❌ **[未實作]**

### 業務場景
FUT 期貨入場是系統的核心交易流程，採用逐倉 20 倍槓桿，優先使用 Maker 策略降低交易成本，在流動性不足時自動回退到 Taker 策略。入場成功後立即掛上止損單保護資金安全。

### 流程說明

#### 階段 1：信號觸發與決策 ❌ **[未實作]**
1. ❌ **特徵計算完成**：S2 Feature Generator 完成特徵計算，通過 Redis Stream 發送 `signals:new` 事件
2. ❌ **策略決策**：S3 Strategy Engine 接收信號，基於規則 DSL 和置信度生成交易決策
3. ❌ **狀態記錄**：將決策結果記錄到 `strategy_events` 表，狀態設為 `PENDING_ENTRY`

#### 階段 2：訂單執行（Maker→Taker 回退）❌ **[未實作]**
1. ❌ **限價單嘗試**：S4 Order Router 首先嘗試掛限價單（Maker 策略）
2. ❌ **等待成交**：在指定時間窗口內等待成交
3. ❌ **回退機制**：如果超時或流動性不足，自動取消限價單並改為市價單（Taker 策略）
4. ❌ **TWAP 執行**：大單可選擇 TWAP 方式拆分執行

#### 階段 3：止損保護 ❌ **[未實作]**
1. ❌ **新倉監控**：S6 Position Manager 監控到新倉建立
2. ❌ **止損掛單**：立即掛上 STOP_MARKET 止損單，使用 `MARK_PRICE` 工作類型
3. ❌ **風險通知**：通過 Redis Stream 發送止損掛單通知

### 關鍵技術點

#### Maker→Taker 回退策略 ❌ **[未實作]**
- ❌ **等待時間**：`post_only_wait_ms: 3000`（3秒）
- ❌ **回退條件**：未成交或部分成交
- ❌ **執行順序**：先取消限價單，再下市價單
- ❌ **滑點記錄**：記錄實際成交價格與預期價格的差異

#### 冪等性處理 ❌ **[未實作]**
- ❌ **Intent ID**：每個交易意圖都有唯一的 `intent_id`
- ❌ **重試安全**：使用相同的 `intent_id` 重試不會產生重複訂單
- ❌ **狀態恢復**：系統重啟後可以通過 `intent_id` 查詢訂單狀態

#### 止損機制 ❌ **[未實作]**
- ❌ **工作類型**：使用 `MARK_PRICE` 確保止損觸發的準確性
- ❌ **減倉標記**：設置 `reduce_only: true` 確保只能減倉不能加倉
- ❌ **價格設定**：基於 ATR 或其他技術指標動態計算止損價格

### 錯誤處理與重試 ❌ **[未實作]**
- ❌ **超時處理**：上游服務超時時自動重試，最多重試 3 次
- ❌ **部分成交**：記錄部分成交情況，剩餘部分繼續執行
- ❌ **交易所錯誤**：根據錯誤碼決定是否重試或放棄

## 2) SPOT 入場（OCO / 守護停損 fallback）❌ **[未實作]**

### 業務場景
SPOT 現貨入場優先使用 OCO（One-Cancels-Other）訂單，同時設置止盈和止損。當交易所不支援 OCO 或 OCO 掛單失敗時，系統會自動回退到守護停損機制，通過本地監控實現止損功能。

### 流程說明

#### 階段 1：OCO 嘗試 ❌ **[未實作]**
1. ❌ **OCO 訂單**：S4 Order Router 嘗試創建 OCO 訂單，包含限價單和止損單
2. ❌ **雙腿掛單**：交易所同時掛上止盈腿和止損腿
3. ❌ **狀態確認**：確認 OCO 訂單成功掛出

#### 階段 2：OCO 失敗回退 ❌ **[未實作]**
1. ❌ **失敗檢測**：檢測到 OCO 不支援或掛單失敗
2. ❌ **市價入場**：改為市價單入場
3. ❌ **分別掛單**：嘗試分別掛止盈單和止損單

#### 階段 3：守護停損啟動 ❌ **[未實作]**
1. ❌ **條件單失敗**：如果交易所不支援條件單
2. ❌ **守護啟動**：啟動本地守護停損機制
3. ❌ **價格監控**：通過 WebSocket 監控中間價格
4. ❌ **觸發平倉**：價格觸及止損線時自動平倉

### 關鍵技術點

#### OCO 訂單配置 ❌ **[未實作]**
- ❌ **限價價格**：設置合理的限價價格，確保能夠成交
- ❌ **止盈價格**：基於技術分析設定止盈目標
- ❌ **止損價格**：基於風險管理設定止損價格
- ❌ **時間有效性**：設置 `GTC`（Good Till Cancel）確保訂單持續有效

#### 守護停損機制 ❌ **[未實作]**
- ❌ **價格監控**：實時監控 WebSocket 中間價格
- ❌ **觸發條件**：價格觸及止損線時立即觸發
- ❌ **執行方式**：使用市價單快速平倉
- ❌ **對沖標記**：雖然不是 `reduce_only`，但通過等量對沖實現減倉效果

#### 回退策略 ❌ **[未實作]**
1. ❌ **OCO 優先**：優先嘗試 OCO 訂單
2. ❌ **分別掛單**：OCO 失敗時嘗試分別掛止盈和止損單
3. ❌ **守護停損**：條件單不支援時啟動守護停損
4. ❌ **手動管理**：最後回退到人工管理

## 3) 對帳處置（孤兒訂單/倉位、狀態機修復、保守回收）❌ **[未實作]**

### 業務場景
對帳處置是確保系統數據一致性的關鍵流程，通過比較交易所實際狀態與本地數據庫狀態，識別並處理孤兒訂單和持倉。採用保守回收策略，優先降低風險而非追求利潤。

### 流程說明

#### 階段 1：數據收集 ❌ **[未實作]**
1. ❌ **並行查詢**：同時查詢交易所 API 和本地數據庫
2. ❌ **時間窗口**：查詢最近 72 小時的數據
3. ❌ **數據聚合**：將訂單和持倉數據進行聚合處理

#### 階段 2：差異分析 ❌ **[未實作]**
1. ❌ **訂單比對**：比較交易所訂單與本地訂單
2. ❌ **持倉比對**：比較交易所持倉與本地持倉
3. ❌ **狀態檢查**：檢查訂單和持倉的狀態一致性

#### 階段 3：處置策略 ❌ **[未實作]**
1. ❌ **孤兒訂單**：API 有單但 DB 無單的情況
2. ❌ **孤兒持倉**：API 有倉但 DB 無倉的情況
3. ❌ **殘留數據**：DB 有數據但 API 無對應的情況

### 關鍵技術點

#### 保守回收策略 ❌ **[未實作]**
- ❌ **風險優先**：優先考慮風險控制而非利潤最大化
- ❌ **接管條件**：只有在能夠安全接管的情況下才接管孤兒訂單
- ❌ **平倉處理**：無法接管的訂單/持倉優先平倉處理
- ❌ **審計記錄**：所有處置操作都記錄詳細的審計日誌

#### 狀態機修復 ❌ **[未實作]**
- ❌ **PENDING_ENTRY**：修復崩潰時遺留的待入場狀態
- ❌ **ACTIVE**：恢復活躍持倉的正確狀態
- ❌ **CLOSED**：清理已關閉的訂單和持倉
- ❌ **RECONCILED**：標記已對帳的數據

#### 並行處理 ❌ **[未實作]**
- ❌ **API 查詢**：並行查詢 FUT 和 SPOT 的訂單和持倉
- ❌ **DB 查詢**：並行查詢不同類型的本地數據
- ❌ **處置操作**：並行執行多個處置操作以提高效率

## 4) 統一約束

### 冪等性約束 ❌ **[未實作]**
所有會變更系統狀態的請求都必須攜帶 `X-Idempotency-Key`：
- ❌ **下單請求**：使用 `intent_id` 作為冪等鍵
- ❌ **撤單請求**：使用 `order_id` 或 `client_order_id` 作為冪等鍵
- ❌ **資金劃轉**：使用 `treasury:<from>:<to>:<amount>:<timestamp>:<hash>` 格式

### 時間與數字單位 ❌ **[未實作]**
- ❌ **時間戳**：統一使用 epoch 毫秒（ms）
- ❌ **費率**：使用小數表示（0.01 = 1%）
- ❌ **金額**：統一使用 USDT 作為計價單位
- ❌ **數量**：使用實際交易數量，不包含槓桿倍數

### Redis Streams 命名規範 ❌ **[未實作]**
- ❌ **信號家族**：`signals:new` - 新信號事件
- ❌ **執行家族**：`orders:executed`, `spot:oco:armed`, `guard:spot:arm`, `risk:sl_arm`
- ❌ **對帳家族**：`strategy:reconciled` - 對帳完成事件
- ❌ **告警家族**：`alerts` - 系統告警事件

### 事務狀態機 ❌ **[未實作]**
- ❌ **PENDING_ENTRY**：等待入場
- ❌ **ACTIVE**：活躍持倉
- ❌ **PENDING_CLOSING**：等待平倉
- ❌ **CLOSED**：已關閉
- ❌ **對帳恢復**：系統崩潰後能夠通過對帳機制恢復到正確狀態

### 保守回收原則 ❌ **[未實作]**
- ❌ **降風險優先**：無法接管的孤兒一律優先降風險處理
- ❌ **審計記錄**：所有回收操作都記錄詳細的審計日誌
- ❌ **告警通知**：重要操作通過告警系統通知相關人員
- ❌ **人工確認**：重大決策需要人工確認

## 5) 典型 JSON 範例（便於調試）

### 5.1 FUT 入場成功 + 掛 SL

#### 信號事件（S2 → S3）❌ **[未實作]**
```json
{
  "signal_id": "signal_20250120_001",
  "symbol": "BTCUSDT",
  "t0": 1758345600000,
  "features": {
    "atr_14": 0.025,
    "volatility_30d": 0.18,
    "correlation_spx": 0.65,
    "rsi_14": 45.2,
    "macd_signal": "BULLISH"
  },
  "config_rev": 130
}
```

#### 下單請求（S3 → S4）❌ **[未實作]**
```json
{
  "intent": {
    "intent_id": "uuid-123",
    "market": "FUT",
    "symbol": "BTCUSDT",
    "side": "BUY",
    "qty": 0.0012,
    "exec_policy": "MakerThenTaker",
    "post_only_wait_ms": 3000,
    "twap": {
      "enabled": true,
      "slices": 3,
      "interval_ms": 800
    },
    "leverage": 20,
    "isolated": true,
    "client_tags": ["entry", "atr-sl"]
  },
  "tp": null,
  "sl": null
}
```

#### 下單響應（S4 → S3）❌ **[未實作]**
```json
{
  "status": "FILLED",
  "order_id": "123456789",
  "avg_price": 65000.5,
  "filled_qty": 0.0012,
  "fills": [
    {
      "price": 65001,
      "qty": 0.0008,
      "timestamp": 1758345601000
    },
    {
      "price": 64999,
      "qty": 0.0004,
      "timestamp": 1758345601200
    }
  ],
  "slippage_bps": 2.1
}
```

#### 止損掛單（S6 → S4）❌ **[未實作]**
```json
{
  "intent": {
    "intent_id": "uuid-sl-1",
    "market": "FUT",
    "symbol": "BTCUSDT",
    "side": "SELL",
    "qty": 0.0012,
    "type": "STOP_MARKET",
    "reduce_only": true,
    "stop_price": 64200,
    "working_type": "MARK_PRICE"
  }
}
```

#### 訂單執行事件（S4 → Redis Stream）❌ **[未實作]**
```json
{
  "order_id": "123456789",
  "intent_id": "uuid-123",
  "symbol": "BTCUSDT",
  "side": "BUY",
  "avg_px": 65000.5,
  "filled_qty": 0.0012,
  "market": "FUT",
  "ts": 1758345601200
}
```

### 5.2 SPOT OCO 失敗 → 守護停損

#### OCO 入場請求（S3 → S4）❌ **[未實作]**
```json
{
  "intent": {
    "intent_id": "uuid-spot-1",
    "market": "SPOT",
    "symbol": "BTCUSDT",
    "side": "BUY",
    "qty": 0.01,
    "exec_policy": "OCO",
    "oco": {
      "tp_price": 66000,
      "sl_price": 64000,
      "limit_price": 65000,
      "leg_time_in_force": "GTC"
    }
  }
}
```

#### OCO 武裝事件（S4 → Redis Stream）❌ **[未實作]**
```json
{
  "group_id": "oco_20250120_001",
  "symbol": "BTCUSDT",
  "tp_order_id": "987654321",
  "sl_order_id": "987654322",
  "qty": 0.01,
  "ts": 1758345600000
}
```

#### 守護停損武裝（S4 → Redis Stream）❌ **[未實作]**
```json
{
  "symbol": "BTCUSDT",
  "sl_px": 64000,
  "qty": 0.01,
  "side": "SELL",
  "group_id": "oco-fb-123",
  "ts": 1758345600123
}
```

#### 守護停損觸發（S6 → S4）❌ **[未實作]**
```json
{
  "intent": {
    "intent_id": "uuid-guard-exe-1",
    "market": "SPOT",
    "symbol": "BTCUSDT",
    "side": "SELL",
    "qty": 0.01,
    "type": "MARKET",
    "client_tags": ["guard-stop"]
  }
}
```

### 5.3 對帳摘要（回應）

#### 對帳請求（S12 → S5）❌ **[未實作]**
```json
{
  "mode": "ALL",
  "dry_run": false,
  "orphan_policy": "CONSERVATIVE",
  "time_window_h": 72
}
```

#### 對帳響應（S5 → S12）❌ **[未實作]**
```json
{
  "summary": {
    "checked_orders": 132,
    "checked_positions": 4,
    "adopted": 1,
    "closed": 2,
    "fixed": 5
  },
  "items": [
    {
      "type": "ORPHAN_ORDER",
      "action": "CANCELLED",
      "order_id": "orphan_001",
      "reason": "Unknown source, conservative closure"
    },
    {
      "type": "ORPHAN_POS",
      "action": "ADOPTED",
      "symbol": "BTCUSDT",
      "reason": "PENDING_ENTRY crash recovery"
    },
    {
      "type": "STALE_ORDER",
      "action": "FIXED",
      "order_id": "stale_001",
      "reason": "Status mismatch corrected"
    }
  ]
}
```

#### 對帳完成事件（S5 → Redis Stream）❌ **[未實作]**
```json
{
  "kind": "ORDER",
  "action": "ADOPTED",
  "ref": "orphan_001",
  "ts": 1758345600000
}
```

## 實現建議

### 開發優先級
1. ❌ **核心流程**：優先實現 FUT 入場和基本對帳功能
2. ❌ **回退機制**：實現 Maker→Taker 回退和 OCO 失敗回退
3. ❌ **守護機制**：實現守護停損和風險監控
4. ❌ **高級功能**：實現 TWAP 執行和複雜對帳策略

### 測試策略
1. ❌ **單元測試**：每個服務的 API 接口測試
2. ❌ **集成測試**：完整的業務流程測試
3. ❌ **壓力測試**：高頻交易場景測試
4. ❌ **故障測試**：系統崩潰和恢復測試

### 監控指標
1. ❌ **業務指標**：訂單成功率、平均執行時間、滑點統計
2. ❌ **技術指標**：API 響應時間、錯誤率、重試次數
3. ❌ **風險指標**：止損觸發率、孤兒訂單數量、對帳成功率

---

## 📊 實作進度總結

### ❌ 全部未實作 (0%)
- **S1-S12**：所有服務均未實作
- **核心流程**：FUT 入場、SPOT 入場、對帳處置
- **執行流程**：訂單執行、止損保護、守護停損
- **對帳流程**：數據收集、差異分析、處置策略
- **統一約束**：冪等性、時間單位、Redis Streams、事務狀態機
- **JSON 範例**：所有請求/響應格式
- **測試策略**：單元測試、集成測試、壓力測試、故障測試
- **監控指標**：業務指標、技術指標、風險指標

### 🎯 建議優先順序
1. **S1 Exchange Connectors** - 交易所通信基礎
2. **S2 Feature Generator** - 特徵計算引擎
3. **S3 Strategy Engine** - 決策邏輯核心
4. **S4 Order Router** - 訂單執行核心（Maker→Taker、TWAP、OCO）
5. **S6 Position Manager** - 止損保護和倉位管理
6. **S5 Reconciler** - 對帳處置和狀態修復
7. **S12 API Gateway** - 對帳請求代理
8. **S10 Config Service** - 配置管理
9. **S11 Metrics & Health** - 監控系統
10. **S7-S9** - 分析、研究服務

這份 Integration 附錄提供了完整的業務流程規範，開發團隊可以根據這些順序圖和參數對照表準確實現系統功能，確保業務邏輯的正確性和一致性。
