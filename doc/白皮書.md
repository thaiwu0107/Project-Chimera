# Project Chimera — 工程版白皮書 · Spec v3.0

**USDT 計價｜Futures 逐倉 20× + Spot｜Redis Cluster 事件總線｜ArangoDB 資料湖｜零停機熱更新**

本版是最終整合：包含 v2.4/2.5 的全部內容 + 你最新要求（路由策略參數表、失效偵測門檻、回測一致性檢查、Observability 套件），並移除 TWD 估值/多來源匯率（全系統以 USDT 計價）。

## 內容涵蓋

- 12 個服務說明（S1–S12）
- 所有 ArangoDB Collections JSON Schema
- Redis Key/Hash/Set/ZSet/Lock JSON 規格
- Redis Streams 全家族與每一種訊息 Payload 的 JSON Schema
- 規則 DSL / Lint / Promote 守門
- 路由策略配置
- 健康/回測守門
- 初始化/索引
- SLO/SLI
- Runbook
- 安全與權限

**目標**：僅憑本文即可實作全部服務與資料契約，無須回頭對照舊版本。

## 0. 執行摘要

### 決策核心
USDT/TWD（MAX）兩日同向 + BTCUSDT 首日反向 -> 期現可開倉；ATR 動態停損；逐倉 20×；單筆保證金 20 USDT；淨利 ≥10% 才離場；只對獲利倉位加倉；分層移動停損。

### 工程治理
事務狀態機、啟動對帳、冪等下單、熔斷與降級、Redis Cluster 作為事件匯流排、ArangoDB 為真相源、MinIO（選配）存報表。

### 動態配置
因子/規則/標的以 Config Bundle 版本管理；零停機熱更新（RCU）；配置模擬器 + 敏感度分析；Promote 守門與 Canary→Ramp→Full。

### Observability
核心 SLI/SLO、失效偵測（maker_fill_ratio / ib_rate / AUC / Brier）、回測一致性（線上 TCA vs 滑價模型），越界即自動降級或停新倉。

### 現貨擴充
原生 OCO（若交易所支援）／守護停損（客戶端）；WAC 會計；資金不足自動降額/重試。



## 1. 系統分工（S1–S12）

各服務皆以 HTTP（內網） + Redis Streams 溝通；資料持久化進 ArangoDB。

每個服務須具備：`/health`、`/ready`、`/metrics`（S11 聚合）。

### S1. Exchange Connectors

**職責**：整合 Binance FUT/UM & SPOT 之 REST/WS；（選）MAX USDTTWD 僅作因子；重連/節流/時鐘校正。

**輸入/輸出**：
- 輸出 Streams：`mkt:ticker:{INSTR}`、`mkt:depth:{INSTR}`、`acct:events`
- 持久化：原始行情（可選）、帳戶餘額 snapshot（`balances_snapshots`）
- API：`GET /health` `GET /ready`

**關鍵狀態**：WS 心跳、REST 429/5xx 計數、ServerTime 偏差

**故障動作**：連線不穩 -> 降頻/重連；多次 429 -> 通告 S4 熔斷

### S2. Feature Generator

**職責**：計算 ATR/RV/ρ（USDT/TWD×BTCUSDT）、Spread/Depth、Funding 等特徵；不允許未來資料。

**輸入/輸出**：
- IN：S1 Streams、K 線/深度/資金費
- OUT：`feat:events:{INSTR}`、`signals`（features 填入）
- API：`POST /features/recompute?symbol=`
- 資料：`factor_registry` 註冊/版本

**故障動作**：來源不足 -> 特徵標記 stale，S3 守門可拒新倉

### S3. Strategy Engine

**職責**：L0 守門（風險/健康/回測守門）→ 規則 DSL → 模型分數 → OrderCmd。

**輸入/輸出**：
- IN：`feat:events:*`、`cfg:events`、健康/回測指標
- OUT：`sig:events:{INSTR}`、`ord:cmd:{INSTR}`、`strategy_events`
- API：`POST /decide`（診斷）、`POST /dryrun`（調試）

**故障動作**：RED 級 -> `halt_new_entries=true`（只管倉）

### S4. Order Router

**職責**：冪等下單、Maker→Taker 回退、TWAP、現貨 OCO/守護停損、速率限制與熔斷；寫 orders、fills、回推 `ord:result:*`。

**輸入/輸出**：
- IN：`ord:cmd:{INSTR}`、`cfg:events`
- OUT：`ord:result:{INSTR}`、`alerts`、`strategy_events`
- API：`POST /orders` `POST /cancel`

**故障動作**：429/5xx 連發 -> 熔斷降級（停 Maker、TWAP 更細或停新倉）

### S5. Reconciler

**職責**：啟動對帳、事務狀態機（PENDING_ENTRY → ACTIVE → PENDING_CLOSING → CLOSED）、孤兒倉處置。

**輸入/輸出**：
- IN：交易所 openOrders/positionRisk、DB 狀態
- OUT：修復 DB、`recon:result`、`strategy_events`
- API：`POST /reconcile` / `GET /status`

**故障動作**：DB 不一致 -> 以交易所為真相，依規則接管/平倉

### S6. Position Manager

**職責**：移動停損（保本→鎖利）、加倉（僅獲利）、分批止盈、SPOT 守護停損；`pos:events`。

**輸入/輸出**：
- IN：positionRisk/持倉查詢、`ord:result:*`、健康狀態
- OUT：`ord:cmd:*`、`pos:events:*`、更新 `positions_snapshots`

**故障動作**：守護停損觸發時持鎖 `lock:pos:{INSTR}`，重試直至成功/降級

### S7. Label Backfill

**職責**：t0+12/24/36h 淨利標籤（含費用/資金費），寫 `labels_*`。

**輸入/輸出**：
- IN：fills、funding_records、signals
- OUT：`labels_12h/24h/36h`、`label:result`
- API：`POST /labels/backfill?h=24`

### S8. Autopsy Generator

**職責**：交易復盤（TL;DR 敘事、ROE 曲線、Peer 對比、TCA、反事實）。

**輸入/輸出**：
- IN：signals/labels/fills/metrics_timeseries
- OUT：`autopsy_reports`、`autopsy:result`
- API：`POST /autopsy/:trade_id`

### S9. Hypothesis Orchestrator

**職責**：假設→回測/實驗（Walk-Forward、Purged K-Fold、FDR），寫 experiments。

- API：`POST /experiments/run`

### S10. Config Service

**職責**：因子/規則/標的註冊；Bundle Lint/Dry-run/模擬器+敏感度；Promote/回滾；廣播 `cfg:events`。

- API：`POST /bundles` `POST /bundles/:id/stage` `POST /promote` `POST /simulate` `GET /simulations/:id`

### S11. Metrics & Health

**職責**：聚合 SLI/SLO、健康/回測一致性；`/metrics` 暴露；寫 `metrics_timeseries`。

- API：`GET /metrics` `GET /alerts`

### S12. Web UI / API GW

**職責**：前端管理；配置中心（差異/模擬/敏感度/審批/回滾）、倉位/Autopsy/告警板；RBAC（單人版可簡化）。

- API：`/ui/*` `/auth/*`



## 2. 決策與規則 DSL

### 2.1 層級

- **L0 守門**：風險預算/健康/回測守門
- **L1 規則 DSL**：when（allOf/anyOf/not + f/op/v）→ action（白名單）
- **L2 模型**：監督式開倉置信度（0–1），轉 size_mult
- **L3 執行**：路由策略（TWAP + Maker 等待曲線）

### 2.2 DSL 白名單

- **比較**：`<` `<=` `>` `>=` `==` `!=`
- **集合**：`in` `notIn`
- **邏輯**：`allOf` `anyOf` `not`
- **函式**（僅 S2 預計算）：`pctile(x,win)`、`zscore(x,win)`、`abs`
- **動作**：
  - `size_mult` ∈ [0.5,1.2]
  - `tp_mult` ∈ [0.5,1.5]
  - `sl_mult` ∈ [0.8,2.5]
  - `skip_entry` ∈ {true,false}
  - `max_adds_override` ∈ {0,1,2}

**合成**：多條相乘後 clamp；`skip_entry=true` 短路；`max_adds_override` 取保守最小

### 2.3 Lint 規則

- Schema/型別/值域
- `when.f` 存在於 `factor_registry(status=ENABLED)`
- `applies.services` 必須為合法服務代碼（s3/s4/…）
- **Dry-run**：近 N 天 signals 重放；限制：skip_entry 命中率 ≤ 60%、size_mult>1 ≤ 50%、Jaccard policy shift ≥ 0.35

### 2.4 Promote 守門（摘要）

Lint/Dry-run/模擬/敏感度/健康 OK → Canary(10%/7d) → Ramp(50%) → Full

越界（MaxDD、AUC/Brier 劣化等）→自動回滾



## 3. 路由策略 & 守門配置（Config Bundle Flags）

以 JSON 存入 `config_bundles.flags`；以下為 Schema（簡化必要欄位）。

```json
{
  "$id": "config_flags.schema.json",
  "type": "object",
  "properties": {
    "execution": {
      "type": "object",
      "properties": {
        "routing": {
          "type": "object",
          "properties": {
            "twap": {
              "type": "object",
              "properties": {
                "buckets": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "range": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                      "slices": { "type": "integer", "minimum": 1 },
                      "min_slice_usdt": { "type": "number", "minimum": 0 }
                    },
                    "required": ["range","slices","min_slice_usdt"]
                  }
                }
              },
              "required": ["buckets"]
            },
            "maker_wait": {
              "type": "object",
              "properties": {
                "base_ms": { "type": "integer" },
                "need_fill_ratio": { "type": "number" },
                "spread_bp_gate": { "type": "number" },
                "min_top1_depth_usdt": { "type": "number" },
                "regime_adjust_ms": {
                  "type": "object",
                  "properties": {
                    "LOW": { "type": "integer" },
                    "MEDIUM": { "type": "integer" },
                    "HIGH": { "type": "integer" }
                  },
                  "required": ["LOW","MEDIUM","HIGH"]
                }
              },
              "required": ["base_ms","need_fill_ratio","spread_bp_gate","min_top1_depth_usdt","regime_adjust_ms"]
            },
            "taker": {
              "type": "object",
              "properties": { "fallback": { "enum": ["DIRECT","AFTER_CANCEL"] } },
              "required": ["fallback"]
            },
            "fees": {
              "type": "object",
              "properties": { "maker_bp": { "type": "number" }, "taker_bp": { "type": "number" } },
              "required": ["maker_bp","taker_bp"]
            }
          },
          "required": ["twap","maker_wait","taker","fees"]
        }
      },
      "required": ["routing"]
    },
    "health_guard": {
      "type": "object",
      "properties": {
        "window_min": { "type": "integer" },
        "thresholds": { "type": "object" },
        "actions": { "type": "object" }
      },
      "required": ["window_min","thresholds","actions"]
    },
    "backtest_guard": {
      "type": "object",
      "properties": {
        "slippage_mape_7d_max": { "type": "number" },
        "taker_pct_diff_7d_max": { "type": "number" },
        "latency_diff_ms_p95_max": { "type": "number" },
        "actions": { "type": "object" }
      },
      "required": ["slippage_mape_7d_max","taker_pct_diff_7d_max","latency_diff_ms_p95_max","actions"]
    },
    "risk": {
      "type": "object",
      "properties": {
        "budget": {
          "type": "object",
          "properties": {
            "spot_quote_usdt_max": { "type": "number" },
            "fut_margin_usdt_max": { "type": "number" }
          },
          "required": ["spot_quote_usdt_max","fut_margin_usdt_max"]
        },
        "concurrent_entries_per_market": { "type": "integer" }
      },
      "required": ["budget","concurrent_entries_per_market"]
    },
    "inventory": {
      "type": "object",
      "properties": {
        "spot_multi_symbols": { "type": "boolean" },
        "spot_hedge_enable": { "type": "boolean" }
      },
      "required": ["spot_multi_symbols","spot_hedge_enable"]
    },
    "treasury": {
      "type": "object",
      "properties": {
        "auto_transfer": { "type": "boolean" },
        "min_free_usdt_spot": { "type": "number" },
        "min_free_usdt_fut": { "type": "number" }
      },
      "required": ["auto_transfer","min_free_usdt_spot","min_free_usdt_fut"]
    },
    "compliance": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "large_order_usdt_threshold": { "type": "number" },
        "approval_ttl_sec": { "type": "integer" }
      },
      "required": ["enabled"]
    }
  },
  "required": ["execution","health_guard","backtest_guard","risk","inventory","treasury","compliance"]
}
```


## 4. ArangoDB Collections — JSON Schema（完整清單）

皆為 draft/2020-12；實作可微調，但需後相容。省略 $schema 行請自行補上。

### 4.1 signals

```json
{
  "title":"signals","type":"object",
  "properties":{
    "signal_id":{"type":"string"},
    "t0":{"type":"integer","description":"epoch ms"},
    "symbol":{"type":"string"},
    "features":{"type":"object","additionalProperties":{"type":["number","string","boolean"]}},
    "decision":{
      "type":"object",
      "properties":{
        "action":{"enum":["open","skip"]},
        "size_mult":{"type":"number"},
        "tp_mult":{"type":"number"},
        "sl_mult":{"type":"number"},
        "reason":{"type":"string"}
      },
      "required":["action"]
    },
    "config_rev":{"type":"integer"},
    "created_at":{"type":"integer"}
  },
  "required":["signal_id","t0","symbol","features","decision","config_rev"]
}
```

### 4.2 labels_12h / labels_24h / labels_36h

```json
{
  "title":"labels_24h","type":"object",
  "properties":{
    "signal_id":{"type":"string"},
    "horizon_h":{"type":"integer","enum":[12,24,36]},
    "net_roi":{"type":"number"},
    "pnl_usdt":{"type":"number"},
    "funding_cost_usdt":{"type":"number"},
    "fees_usdt":{"type":"number"},
    "label":{"enum":["pos","neg","neutral"]},
    "computed_at":{"type":"integer"}
  },
  "required":["signal_id","horizon_h","net_roi","label"]
}
```

### 4.3 orders

```json
{
  "title":"orders","type":"object",
  "properties":{
    "order_id":{"type":"string"},
    "client_order_id":{"type":"string"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "side":{"enum":["BUY","SELL"]},
    "type":{"enum":["MARKET","LIMIT","STOP_MARKET","TAKE_PROFIT_MARKET","STOP_LOSS_LIMIT","TAKE_PROFIT_LIMIT","OCO_PARENT"]},
    "reduce_only":{"type":"boolean"},
    "quantity":{"type":"number"},
    "quote_qty":{"type":["number","null"]},
    "price":{"type":["number","null"]},
    "oco_pair_id":{"type":["string","null"]},
    "status":{"enum":["NEW","PARTIALLY_FILLED","FILLED","CANCELED","REJECTED"]},
    "rcu_rev":{"type":"integer"},
    "created_at":{"type":"integer"}
  },
  "required":["order_id","market","symbol","side","type","status","rcu_rev","created_at"]
}
```

### 4.4 fills

```json
{
  "title":"fills","type":"object",
  "properties":{
    "fill_id":{"type":"string"},
    "order_id":{"type":"string"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "side":{"enum":["BUY","SELL"]},
    "price":{"type":"number"},
    "qty":{"type":"number"},
    "fee_usdt":{"type":"number"},
    "mid_at_send":{"type":"number"},
    "book_top3":{"type":"array","items":{"type":"object"}},
    "slippage_bps":{"type":"number"},
    "timestamp":{"type":"integer"}
  },
  "required":["fill_id","order_id","market","symbol","price","qty","timestamp"]
}
```

### 4.5 positions_snapshots

```json
{
  "title":"positions_snapshots","type":"object",
  "properties":{
    "symbol":{"type":"string"},
    "side":{"enum":["LONG","SHORT","FLAT"]},
    "entry_price_avg":{"type":"number"},
    "isolated_margin_usdt":{"type":"number"},
    "unrealized_pnl_usdt":{"type":"number"},
    "roe":{"type":"number"},
    "add_on_count":{"type":"integer"},
    "ts":{"type":"integer"}
  },
  "required":["symbol","side","entry_price_avg","isolated_margin_usdt","unrealized_pnl_usdt","ts"]
}
```

### 4.6 holdings_spot_snapshots

```json
{
  "title":"holdings_spot_snapshots","type":"object",
  "properties":{
    "symbol":{"type":"string"},
    "qty":{"type":"number"},
    "avg_cost_usdt":{"type":"number"},
    "unrealized_pnl_usdt":{"type":"number"},
    "ts":{"type":"integer"}
  },
  "required":["symbol","qty","avg_cost_usdt","ts"]
}
```

### 4.7 balances_snapshots

```json
{
  "title":"balances_snapshots","type":"object",
  "properties":{
    "market":{"enum":["SPOT","FUT"]},
    "asset":{"type":"string"},
    "free":{"type":"number"},
    "locked":{"type":"number"},
    "ts":{"type":"integer"}
  },
  "required":["market","asset","free","locked","ts"]
}
```

### 4.8 funding_records

```json
{
  "title":"funding_records","type":"object",
  "properties":{
    "symbol":{"type":"string"},
    "funding_time":{"type":"integer"},
    "funding_rate":{"type":"number"},
    "amount_usdt":{"type":"number"}
  },
  "required":["symbol","funding_time","funding_rate","amount_usdt"]
}
```

### 4.9 strategy_events

```json
{
  "title":"strategy_events","type":"object",
  "properties":{
    "event_id":{"type":"string"},
    "kind":{"enum":["ENTRY","EXIT","ADD","STOP_MOVE","CIRCUIT_BREAK","ROLLBACK","PROMOTE","CONFIG_HOTLOAD"]},
    "symbol":{"type":"string"},
    "detail":{"type":"object"},
    "ts":{"type":"integer"}
  },
  "required":["event_id","kind","ts"]
}
```

### 4.10 alerts

```json
{
  "title":"alerts","type":"object",
  "properties":{
    "alert_id":{"type":"string"},
    "severity":{"enum":["INFO","WARN","ERROR","FATAL"]},
    "source":{"type":"string"},
    "message":{"type":"string"},
    "ts":{"type":"integer"}
  },
  "required":["alert_id","severity","source","message","ts"]
}
```

### 4.11 autopsy_reports

```json
{
  "title":"autopsy_reports","type":"object",
  "properties":{
    "trade_id":{"type":"string"},
    "tl_dr":{"type":"string"},
    "entry_snapshot":{"type":"object"},
    "trajectory":{"type":"object"},
    "exit_analysis":{"type":"object"},
    "peer_comparison":{"type":"object"},
    "tca":{"type":"object"},
    "counterfactual":{"type":"object"},
    "generated_at":{"type":"integer"}
  },
  "required":["trade_id","tl_dr","generated_at"]
}
```

### 4.12 hypotheses

```json
{
  "title":"hypotheses","type":"object",
  "properties":{
    "hypothesis_id":{"type":"string"},
    "description":{"type":"string"},
    "status":{"enum":["PENDING","VALIDATING","CONFIRMED","REJECTED"]},
    "related_trades":{"type":"array","items":{"type":"string"}},
    "validation_metrics":{"type":"array","items":{"type":"string"}},
    "backtest_run_id":{"type":["string","null"]},
    "created_at":{"type":"integer"}
  },
  "required":["hypothesis_id","description","status","created_at"]
}
```

### 4.13 experiments

```json
{
  "title":"experiments","type":"object",
  "properties":{
    "exp_id":{"type":"string"},
    "hypothesis_id":{"type":"string"},
    "design":{"type":"object"},
    "metrics":{"type":"object"},
    "result":{"enum":["PASS","FAIL","INCONCLUSIVE"]},
    "created_at":{"type":"integer"}
  },
  "required":["exp_id","hypothesis_id","design","result","created_at"]
}
```

### 4.14 strategy_rules（DSL 存放）

```json
{
  "title":"strategy_rules","type":"object",
  "properties":{
    "rule_id":{"type":"string"},
    "priority":{"type":"integer"},
    "applies":{
      "type":"object",
      "properties":{
        "symbols":{"type":"array","items":{"type":"string"}},
        "services":{"type":"array","items":{"type":"string"}}
      },
      "required":["symbols","services"]
    },
    "when":{"type":"object"},
    "action":{
      "type":"object",
      "properties":{
        "type":{"enum":["size_mult","tp_mult","sl_mult","skip_entry","max_adds_override"]},
        "value":{}
      },
      "required":["type","value"]
    },
    "explain":{"type":"string"},
    "status":{"enum":["ENABLED","DISABLED"]},
    "updated_at":{"type":"integer"}
  },
  "required":["rule_id","priority","applies","when","action","status"]
}
```

### 4.15 factor_registry

```json
{
  "title":"factor_registry","type":"object",
  "properties":{
    "factor_id":{"type":"string"},
    "family":{"type":"string"},
    "version":{"type":"string"},
    "freq":{"type":"string"},
    "lag_ms":{"type":"integer"},
    "definition":{"type":"string"},
    "deps":{"type":"array","items":{"type":"string"}},
    "range":{"type":"array","items":{"type":"number"},"minItems":2,"maxItems":2},
    "owner":{"type":"string"},
    "status":{"enum":["ENABLED","DISABLED"]},
    "updated_at":{"type":"integer"}
  },
  "required":["factor_id","version","freq","definition","status"]
}
```

### 4.16 instrument_registry

```json
{
  "title":"instrument_registry","type":"object",
  "properties":{
    "symbol":{"type":"string"},
    "tickSize":{"type":"number"},
    "stepSize":{"type":"number"},
    "minNotional":{"type":"number"},
    "leverageBracket":{"type":"array","items":{"type":"object"}},
    "spread_bp_limit":{"type":"number"},
    "depth_top1_usdt_min":{"type":"number"},
    "status":{"enum":["ENABLED","DISABLED"]},
    "updated_at":{"type":"integer"}
  },
  "required":["symbol","tickSize","stepSize","minNotional","status"]
}
```

### 4.17 config_bundles（已在 §3 給出 flags Schema）

（同 v2.5，含 flags）

### 4.18 config_active

```json
{
  "title":"config_active","type":"object",
  "properties":{
    "key":{"const":"active"},
    "rev":{"type":"integer"},
    "bundle_id":{"type":"string"},
    "activated_at":{"type":"integer"}
  },
  "required":["key","rev","bundle_id","activated_at"]
}
```

### 4.19 promotions

```json
{
  "title":"promotions","type":"object",
  "properties":{
    "promotion_id":{"type":"string"},
    "bundle_id":{"type":"string"},
    "from_rev":{"type":"integer"},
    "to_rev":{"type":"integer"},
    "mode":{"enum":["CANARY","RAMP","FULL","ROLLBACK"]},
    "status":{"enum":["PENDING","ACTIVE","ROLLED_BACK","ABORTED","DONE"]},
    "guardrail":{"type":"object"},
    "activated_at":{"type":"integer"}
  },
  "required":["promotion_id","bundle_id","from_rev","to_rev","mode","status"]
}
```

### 4.20 simulations

```json
{
  "title":"simulations","type":"object",
  "properties":{
    "sim_id":{"type":"string"},
    "bundle_id":{"type":"string"},
    "ref_rev":{"type":"integer"},
    "window":{"type":"object"},
    "summary":{"type":"object"},
    "approx_effect":{"type":"object"},
    "sensitivity_analysis":{"type":"object"},
    "bounds_guard":{"type":"object"},
    "detail":{"type":"object"},
    "status":{"enum":["QUEUED","RUNNING","DONE","FAILED"]},
    "created_at":{"type":"integer"}
  },
  "required":["sim_id","bundle_id","status","created_at"]
}
```

### 4.21 metrics_timeseries

```json
{
  "title":"metrics_timeseries","type":"object",
  "properties":{
    "metric":{"type":"string"},
    "value":{"type":"number"},
    "tags":{"type":"object","additionalProperties":{"type":"string"}},
    "ts":{"type":"integer"}
  },
  "required":["metric","value","ts"]
}
```

### 4.22 cost_curves（費率/滑價模型版本）

```json
{
  "title":"cost_curves","type":"object",
  "properties":{
    "curve_id":{"type":"string"},
    "kind":{"enum":["FEES","SLIPPAGE"]},
    "version":{"type":"string"},
    "params":{"type":"object"},
    "fitted_at":{"type":"integer"},
    "notes":{"type":"string"}
  },
  "required":["curve_id","kind","version","params","fitted_at"]
}
```

### 4.23 approvals（單人極簡，可選）

```json
{
  "title":"approvals","type":"object",
  "properties":{
    "approval_id":{"type":"string"},
    "subject":{"type":"object"},
    "token":{"type":"string"},
    "expires_at":{"type":"integer"},
    "status":{"enum":["PENDING","APPROVED","CONSUMED","EXPIRED","REVOKED"]},
    "created_at":{"type":"integer"}
  },
  "required":["approval_id","token","expires_at","status","created_at"]
}
```

## 索引與保留建議

- `signals(t0,symbol)`、`orders(order_id,client_order_id)`、`fills(order_id,timestamp)`、`positions_snapshots(ts,symbol)`、`holdings_spot_snapshots(ts,symbol)`、`metrics_timeseries(metric,ts)` 等
- **保留期**：核心 180–365d，報表永久

## 5. Redis Cluster — Key & Streams（與 JSON 規範）

### 5.1 命名與 HashTag

Key 形如：`{env}:{domain}:{entity}:{name}:{HashTag?}`，其中 HashTag = `{MARKET:SYMBOL}`，例：`{FUT:BTCUSDT}`，確保同標的落同槽。

- **env**：prod|stg|dev

### 5.2 Key 規格（Hash/String/ZSet/Lock）

| Key | Type | HashTag | JSON/欄位 | TTL | 說明 |
|-----|------|---------|-----------|-----|------|
| `prod:cfg:active:rev` | String | – | 整數 rev | – | 目前生效 rev |
| `prod:cfg:bundle:{rev}` | Hash | – | hash, flags_digest, created_at | 永久 | 快取摘要 |
| `prod:lock:pos:{FUT:BTCUSDT}` | String | `{FUT:BTCUSDT}` | 值=owner:uuid | 30s | 管倉互斥鎖（續租） |
| `prod:ord:idemp:{FUT:BTCUSDT}:{clientOrderId}` | String | `{FUT:BTCUSDT}` | 固定字串 "1" | 1d | 冪等去重 |
| `prod:risk:usage:spot_quote_usdt` | String | – | 數值 | 1h 滾動 | 風險預算使用量 |
| `prod:risk:usage:fut_margin_usdt` | String | – | 數值 | 1h 滾動 | 同上 |
| `prod:risk:concurrency:{market}` | String | – | 數值 | 1m | 市場並發新倉計數 |
| `prod:router:rate:{FUT:BTCUSDT}` | Hash | `{FUT:BTCUSDT}` | 429,5xx,window_start_ms | 10m | 熔斷依據 |
| `prod:pos:state:{FUT:BTCUSDT}` | Hash | `{FUT:BTCUSDT}` | side, entry_price_avg, margin, roe, add_on_count, updated_at | – | 快照 |
| `prod:spot:oco:state:{SPOT:BTCUSDT}` | Hash | `{SPOT:BTCUSDT}` | parent_id, tp_id, sl_id, status, updated_at | – | OCO 狀態 |
| `prod:wallet:spot:asset:USDT` | Hash | – | free, locked, updated_at | – | 錢包 |
| `prod:wallet:fut:asset:USDT` | Hash | – | free, cross, isolated, updated_at | – | 保證金 |
| `prod:delay:ord:{FUT:BTCUSDT}` | ZSet | `{FUT:BTCUSDT}` | member=json(cmd) score=ts | – | 退避重試 |
| `prod:health:rolling` | Hash | – | maker_fill_ratio, ib_rate, model_auc, brier, updated_at | – | 健康窗口 |
| `prod:metrics:counters` | Hash | – | 多計數器 | – | S11 聚合源 |

### JSON 規範（Hash 內容）

例 `prod:pos:state:{FUT:BTCUSDT}` Hash 欄位值皆為字串，但存放的 JSON 結構如下：

```json
{
  "side": "LONG",
  "entry_price_avg": 65400.5,
  "margin": 60.0,
  "roe": 0.12,
  "add_on_count": 1,
  "updated_at": 1737421112000
}
```

### 5.3 Streams 與 Payload JSON Schema

所有 Streams 名稱皆以：`{env}:{family}:{name}:{HashTag?}`，如 `prod:ord:cmd:{FUT:BTCUSDT}`

每個 Stream 建立 Consumer Group（如 s4-router）與 DLQ：`...:dlq`。

下列是訊息 Payload 的 JSON Schema（精簡但可驗證）。

#### 5.3.1 TickerEvent（prod:mkt:ticker:{INSTR}）

```json
{
  "title":"TickerEvent","type":"object",
  "properties":{
    "ts":{"type":"integer"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "last":{"type":"number"},
    "bid":{"type":"number"},
    "ask":{"type":"number"}
  },
  "required":["ts","market","symbol","last","bid","ask"]
}
```

#### 5.3.2 DepthEvent（prod:mkt:depth:{INSTR}）

```json
{
  "title":"DepthEvent","type":"object",
  "properties":{
    "ts":{"type":"integer"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "best_bid":{"type":"array","items":{"type":"number"},"minItems":2,"maxItems":2},
    "best_ask":{"type":"array","items":{"type":"number"},"minItems":2,"maxItems":2},
    "top3":{"type":"object"}
  },
  "required":["ts","market","symbol","best_bid","best_ask"]
}
```

#### 5.3.3 AccountEvent（prod:acct:events）

```json
{
  "title":"AccountEvent","type":"object",
  "properties":{
    "ts":{"type":"integer"},
    "market":{"enum":["SPOT","FUT"]},
    "asset":{"type":"string"},
    "free":{"type":"number"},
    "locked":{"type":"number"}
  },
  "required":["ts","market","asset","free","locked"]
}
```

#### 5.3.4 FeatureEvent（prod:feat:events:{INSTR}）

```json
{
  "title":"FeatureEvent","type":"object",
  "properties":{
    "ts":{"type":"integer"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "features":{"type":"object","additionalProperties":{"type":["number","string","boolean"]}}
  },
  "required":["ts","market","symbol","features"]
}
```

#### 5.3.5 SignalEvent（prod:sig:events:{INSTR}）

```json
{
  "title":"SignalEvent","type":"object",
  "properties":{
    "signal_id":{"type":"string"},
    "t0":{"type":"integer"},
    "symbol":{"type":"string"},
    "features_ref":{"type":"string"},
    "decision":{
      "type":"object",
      "properties":{
        "action":{"enum":["open","skip"]},
        "size_mult":{"type":"number"},
        "tp_mult":{"type":"number"},
        "sl_mult":{"type":"number"},
        "reason":{"type":"string"}
      },
      "required":["action"]
    },
    "config_rev":{"type":"integer"}
  },
  "required":["signal_id","t0","symbol","decision","config_rev"]
}
```

#### 5.3.6 OrderCmd（prod:ord:cmd:{INSTR}）

```json
{
  "title":"OrderCmd","type":"object",
  "properties":{
    "cmd_id":{"type":"string"},
    "ts":{"type":"integer"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "clientOrderId":{"type":"string"},
    "side":{"enum":["BUY","SELL"]},
    "intent":{"enum":["ENTRY","ADD","EXIT","HEDGE"]},
    "quantity":{"type":"number"},
    "quote_qty":{"type":["number","null"]},
    "type":{"enum":["MARKET","LIMIT","STOP_MARKET","TAKE_PROFIT_MARKET","STOP_LOSS_LIMIT","TAKE_PROFIT_LIMIT","OCO_PARENT"]},
    "price":{"type":["number","null"]},
    "exec_policy":{
      "type":"object",
      "properties":{
        "routing":{"enum":["AUTO","DIRECT_TAKER","MAKER_ONLY"]},
        "maker_try_ms":{"type":"integer"},
        "need_fill_ratio":{"type":"number"},
        "twap":{
          "type":"object",
          "properties":{"enabled":{"type":"boolean"},"slices":{"type":"integer"},"min_slice_usdt":{"type":"number"}},
          "required":["enabled"]
        },
        "oco":{
          "type":"object",
          "properties":{"enabled":{"type":"boolean"},"tp":{"type":["number","null"]},"sl":{"type":["number","null"]}},
          "required":["enabled"]
        }
      },
      "required":["routing"]
    },
    "risk":{"type":"object","properties":{"rcu_rev":{"type":"integer"},"approval_token":{"type":["string","null"]}}}
  },
  "required":["cmd_id","ts","market","symbol","clientOrderId","side","intent","type","exec_policy","risk"]
}
```

#### 5.3.7 OrderResult（prod:ord:result:{INSTR}）

```json
{
  "title":"OrderResult","type":"object",
  "properties":{
    "cmd_id":{"type":"string"},
    "order_id":{"type":"string"},
    "clientOrderId":{"type":"string"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "status":{"enum":["NEW","PARTIALLY_FILLED","FILLED","CANCELED","REJECTED"]},
    "fills":{"type":"array","items":{
      "type":"object",
      "properties":{
        "price":{"type":"number"},
        "qty":{"type":"number"},
        "fee_usdt":{"type":"number"},
        "mid_at_send":{"type":"number"},
        "slippage_bps":{"type":"number"},
        "ts":{"type":"integer"}
      },
      "required":["price","qty","ts"]
    }},
    "exec_summary":{"type":"object","properties":{"maker_ratio":{"type":"number"},"twap_slices":{"type":"integer"},"latency_ms":{"type":"integer"}}},
    "error":{"type":["string","null"]}
  },
  "required":["cmd_id","clientOrderId","market","symbol","status"]
}
```

#### 5.3.8 PositionEvent（prod:pos:events:{INSTR}）

```json
{
  "title":"PositionEvent","type":"object",
  "properties":{
    "ts":{"type":"integer"},
    "market":{"enum":["FUT","SPOT"]},
    "symbol":{"type":"string"},
    "kind":{"enum":["ENTRY","ADD","EXIT","STOP_MOVE","TP_PARTIAL"]},
    "detail":{"type":"object"}
  },
  "required":["ts","market","symbol","kind"]
}
```

#### 5.3.9 ReconcileCmd/Result（prod:recon:*）

```json
{
  "title":"ReconcileCmd","type":"object",
  "properties":{"req_id":{"type":"string"},"ts":{"type":"integer"},"scope":{"enum":["ALL","SYMBOL"]},"symbol":{"type":["string","null"]}},
  "required":["req_id","ts","scope"]
}
```

```json
{
  "title":"ReconcileResult","type":"object",
  "properties":{"req_id":{"type":"string"},"ts":{"type":"integer"},"actions":{"type":"array","items":{"type":"object"}},"status":{"enum":["OK","FIXED","FAILED"]}},
  "required":["req_id","ts","status"]
}
```

#### 5.3.10 LabelCmd/Result（prod:label:*）

```json
{
  "title":"LabelCmd","type":"object",
  "properties":{"horizon_h":{"enum":[12,24,36]},"since_ms":{"type":"integer"}},
  "required":["horizon_h"]
}
```

```json
{
  "title":"LabelResult","type":"object",
  "properties":{"horizon_h":{"enum":[12,24,36]},"processed":{"type":"integer"},"errors":{"type":"integer"}},
  "required":["horizon_h","processed","errors"]
}
```

#### 5.3.11 CfgEvent（prod:cfg:events）

```json
{
  "title":"CfgEvent","type":"object",
  "properties":{
    "rev":{"type":"integer"},
    "bundle_id":{"type":"string"},
    "event":{"enum":["PROMOTE","ROLLBACK"]},
    "activated_at":{"type":"integer"},
    "hash":{"type":"string"}
  },
  "required":["rev","bundle_id","event","activated_at","hash"]
}
```

#### 5.3.12 SimCmd/Result（prod:sim:*）

```json
{
  "title":"SimCmd","type":"object",
  "properties":{
    "sim_id":{"type":"string"},
    "bundle_id":{"type":"string"},
    "ref_rev":{"type":["integer","string"]},
    "window":{"type":"object","properties":{"from":{"type":"string"},"to":{"type":"string"}},"required":["from","to"]},
    "symbols":{"type":"array","items":{"type":"string"}},
    "horizons":{"type":"array","items":{"type":"string"}},
    "sensitivity":{"type":"object","properties":{"enabled":{"type":"boolean"},"topk":{"type":"integer"},"epsilon":{"type":"number"},"n_eval":{"type":"integer"}}}
  },
  "required":["sim_id","bundle_id","window"]
}
```

```json
{
  "title":"SimResult","type":"object",
  "properties":{
    "sim_id":{"type":"string"},
    "status":{"enum":["DONE","FAILED"]},
    "summary":{"type":"object"},
    "approx_effect":{"type":"object"},
    "sensitivity_analysis":{"type":"object"},
    "bounds_guard":{"type":"object"}
  },
  "required":["sim_id","status"]
}
```

#### 5.3.13 AlertEvent（prod:alerts）

```json
{
  "title":"AlertEvent","type":"object",
  "properties":{
    "ts":{"type":"integer"},
    "severity":{"enum":["INFO","WARN","ERROR","FATAL"]},
    "source":{"type":"string"},
    "message":{"type":"string"},
    "tags":{"type":"object","additionalProperties":{"type":"string"}}
  },
  "required":["ts","severity","source","message"]
}
```

#### 5.3.14 AutopsyCmd/Result（prod:autopsy:*）

```json
{
  "title":"AutopsyCmd","type":"object",
  "properties":{"trade_id":{"type":"string"}},
  "required":["trade_id"]
}
```

```json
{
  "title":"AutopsyResult","type":"object",
  "properties":{"trade_id":{"type":"string"},"report_id":{"type":"string"},"status":{"enum":["DONE","FAILED"]}},
  "required":["trade_id","status"]
}
```


6. 初始作業（Init Job）
檢查/建立 Collections 與索引（§4 推薦索引）


初始化 config_active；若缺失 → 掛載預設 Bundle rev=1


建立 Streams、消費者群組、DLQ、設定 MAXLEN


初始化 風險/並發計數 Keys 為 0


驗證交易所權限與 exchangeInfo 緩存；設定 FUT 逐倉/槓桿



7. 健康守門與回測一致性（動作矩陣）
健康守門（滾動 6h，1min 更新）：


任何指標 YELLOW：size_mult×0.8、Maker 等待縮短 300ms


ORANGE（任一橘或兩黃）：停 Maker → 走 Taker/TWAP 更細，新倉佔比×0.5


RED（任一紅或≥3 指標≥橘）：暫停新開倉，僅管倉/止損/減倉


回測一致性（7d）：


slippage_mape_7d > 0.35 或 taker_pct_diff_7d > 0.20 或 latency_diff_ms_p95 > 300
 → 保守路由模式；觸發 recalibrate_cost_model 事件


連 14d 超標 → 停 Maker、TWAP 更細



8. Observability（SLI/SLO）
SLI
定義
SLO
router_e2e_latency_p95
ord:cmd→ord:result 95th
≤ 1200 ms
order_submit_error_rate
4xx/5xx 比率
≤ 0.5%
maker_fill_ratio
Maker 成交佔比（6h）
≥ 0.55
risk_gate_miss_rate
應拒未拒
0
redis_stream_lag_max
消費者最大落後
≤ 200 條
db_write_latency_p95
DB 寫入 p95
≤ 80 ms

S11 聚合、出 /metrics；越界→依 §7 自動降級 + alerts。

9. Runbook（摘錄）
現貨資金不足：S4 接回 insufficient balance → 自動降額（按路由表最小切片）重試；達 ib_rate 橙區 → 停新倉


OCO 一腿失敗：S4 立刻撤另一腿 → 改用守護停損


守護停損觸發：S6 持 lock:pos:{INSTR}，直到 ord:result 回來或達最大重試


熔斷：1 分鐘內 429/5xx 超閾值 → 熔斷 5 分鐘，新倉禁入；告警



10. 安全與權限
單人使用：合規 enabled=false；若開啟 large_order_usdt_threshold 則一次性 token（Redis）


Secrets：K8s Secret 或 Vault；API key 只開必需權限（FUT/Spot Trade）


RBAC：UI 僅本人；所有 Promote/回滾/緊急停機寫入 strategy_events/promotions



11. 服務實作優先序（建議）
S10（Config/Lint/Dry-run/Promote/Events）、S1、S4（冪等+路由+TWAP）


S3（守門+DSL）、S6（管倉/移動停損/加倉/守護停損）


S2（特徵全量）、S5（對帳）


S7（標籤）、S8（Autopsy v1）


S11/S12（metrics+UI）



12. 附錄：參考片段
12.1 路由策略（示例 flags）
{
  "execution": {
    "routing": {
      "twap": { "buckets":[
        {"range":[0,300],"slices":1,"min_slice_usdt":0},
        {"range":[300,1500],"slices":3,"min_slice_usdt":150},
        {"range":[1500,5000],"slices":5,"min_slice_usdt":300},
        {"range":[5000,20000],"slices":8,"min_slice_usdt":1000}]},
      "maker_wait": {
        "base_ms": 1200, "need_fill_ratio": 0.7, "spread_bp_gate": 3.0, "min_top1_depth_usdt": 20000,
        "regime_adjust_ms": { "LOW": 800, "MEDIUM": 0, "HIGH": -600 }
      },
      "taker": { "fallback":"DIRECT" },
      "fees": { "maker_bp": 1.0, "taker_bp": 5.0 }
    }
  },
  "health_guard": { "...": "see §3" },
  "backtest_guard": { "...": "see §3" },
  "risk": { "budget": { "spot_quote_usdt_max": 2000, "fut_margin_usdt_max": 600 }, "concurrent_entries_per_market": 2 },
  "inventory": { "spot_multi_symbols": true, "spot_hedge_enable": true },
  "treasury": { "auto_transfer": false, "min_free_usdt_spot": 50, "min_free_usdt_fut": 50 },
  "compliance": { "enabled": false }
}

12.2 規則 DSL（示例）
{
  "rule_id":"R-023","priority":50,
  "applies":{"symbols":["BTCUSDT"],"services":["s3-strategy"]},
  "when":{"allOf":[
    {"f":"rv_pctile_30d","op":"<","v":0.25},
    {"f":"rho_usdttwd_14","op":"<","v":-0.3}
  ]},
  "action":{"type":"size_mult","value":1.2},
  "explain":"低波動且負相關強 → 放大初始倉位",
  "status":"ENABLED"
}


13. 完整性聲明
本 Spec v3.0 已整合先前所有版本要求，並新增你指定的四大模組（路由策略、失效偵測、回測一致性、Observability）。


Project Chimera — 工程版白皮書 · Spec v3.2
（USDT 計價｜Futures 逐倉 20× + Spot｜Redis Cluster 事件匯流｜ArangoDB 資料湖｜零停機熱更新）
本版在 v3.0 基礎上補齊你剛剛加的需求，並把 Collections 的索引一併完整列出。
 新增重點：
 • 路由策略參數表（TWAP 粒度 & Maker 等待曲線）實作規範
 • 失效偵測門檻表（maker_fill_ratio / ib_rate / AUC / Brier → 動作矩陣）
 • 回測一致性檢查（線上 TCA/滑價模型偏差容許度）
 • Observability SLI/SLO（Router p95 / Risk Gate / Stream Lag 等）
 • 現貨擴充：OCO/守護停損時序、WAC 會計示例、資金不足自動降額重試狀態機
 • 風險預算分配、成本曲線路由決策、庫存/對沖、錢包劃轉、合規（單人簡化）、測試策略（Chaos）
 • 所有 ArangoDB Collections 的索引方案（含 TTL/保留建議）
 • Redis Cluster Key/Streams 全規格（與 JSON Payload Schema）

1) 核心擴充與落地細節
1.1 路由策略參數表（隸屬 S4 / Config flags.execution.routing）
TWAP 粒度（按名目 Notional USDT）
buckets：[0,300]→1 切、(300,1500]→3 切、(1500,5000]→5 切、(5000,20000]→8 切，每切 ≥ min_slice_usdt。
 Maker 等待曲線


base_ms=1200、need_fill_ratio=0.7、spread_bp_gate=3.0、min_top1_depth_usdt=20000


regime_adjust_ms：LOW:+800 / MEDIUM:+0 / HIGH:-600
 Taker 回退


fallback=DIRECT（Maker 超時立即撤單改市價）
 費率


fees.maker_bp=1.0、fees.taker_bp=5.0（可依 VIP 調整）


決策邏輯：S4 以「期望總成本」= 費用 + 估計滑價 比較 Maker 與 Taker。
 估計滑價由 深度/價差/名目 + 最近 7d 的 slippage_model（cost_curves）給出；若 Maker 期望成本 < Taker 期望成本且 spread/top1_depth 達門檻 → 先走 Maker；否則直接 Taker；名目超出 bucket → TWAP。

1.2 失效偵測門檻表（Health Guard，隸屬 S11 → S3/S4 降級動作）
指標
黃色 (Y)
橙色 (O)
紅色 (R)
動作（6h 滾動）
maker_fill_ratio
<0.55
<0.45
<0.35
Y: size×0.8；O: 停 Maker→Taker/TWAP；R: 暫停新倉
ib_rate（insufficient balance rate, SPOT）
>3%
>6%
>10%
Y: 降名目；O: 限 TWAP 最細；R: 暫停新現貨單
model_auc（滾動 100 筆）
<0.60
<0.55
<0.50
Y: size×0.9；O: size×0.7；R: 暫停新倉
brier（越低越好）
>0.22
>0.25
>0.28
同上
router_e2e_latency_p95
>1200ms
>2000ms
>3000ms
Y: TWAP 更細；O: 停 Maker；R: 停新倉

矩陣聚合規則：任一 R → RED；任一 O 或 ≥2 Y → ORANGE；其餘 Y → YELLOW；無 Y → GREEN。
 動作：GREEN 正常；YELLOW 輕降；ORANGE 強降（停 Maker）；RED 停新倉僅管倉。

1.3 回測一致性檢查（Backtest Guard）
slippage_mape_7d ≤ 0.35、taker_pct_diff_7d ≤ 0.20、latency_diff_ms_p95 ≤ 300


超標 → 保守路由模式（停 Maker + TWAP 更細）與 recalibrate_cost_model 任務；連 14d 超標 → 暫停新倉。



1.4 現貨擴充：OCO/守護停損與會計
(A) S4 現貨 OCO/守護停損時序（精簡）
OrderCmd(intent=ENTRY, market=SPOT, exec.oco.enabled=true) → S4


S4 預檢餘額/費率/深度 → 送父單 OCO_PARENT（或同時送 TP & SL）


回傳 ord:result（父單/子單 id）→ Redis Hash spot:oco:state:{SPOT:SYM} 更新


任何一腿成交 → S4 立即撤另一腿；更新 spot:oco:state；落 DB orders/fills


若 OCO 任一腿下單失敗 → 撤另一腿 → 切換守護停損（本地監控觸價市價出場）


(B) SPOT 會計（WAC，Weighted Average Cost）
買入：


新均價：WAC' = (WAC * Qty + Price * BuyQty) / (Qty + BuyQty)


Qty' = Qty + BuyQty


賣出：


實現損益：PnL = (SellPrice - WAC) * SellQty - Fees


Qty' = Qty - SellQty（Qty'=0 → WAC 清零）


例：Qty=0.2, WAC=30,000，再買 0.1@33,000 → WAC'=(30,000*0.2 + 33,000*0.1)/0.3=31,000。


手續費 以 USDT 計，在 PnL 直接扣除；holdings_spot_snapshots 每 10s 刷一次。


(C) 現貨資金不足自動降額重試（狀態機）
 States：INIT → PRECHECK → SUBMIT → INSUFF → DOWNSIZE → RETRY (exp backoff) → GIVEUP/OK
DOWNSIZE 規則：按 TWAP bucket 最小切片，至少縮至 min_slice_usdt；最多 N=5 次；


ib_rate（資金不足率）超橙區 → 停止新現貨單，僅排隊重試當前；


Redis：delay:ord:{SPOT:SYM}（ZSet，score=重試 ts）排程重試；ord:idemp:* 去重。



1.5 風險預算、庫存/對沖、錢包劃轉、合規（簡化）
風險預算（Config.flags.risk.budget）


spot_quote_usdt_max：現貨持倉名目上限（按 WAC*Qty）


fut_margin_usdt_max：逐倉保證金總上限


concurrent_entries_per_market：每市場（FUT/SPOT）同時新開倉上限


逾限 → skip_entry=true


庫存策略


inventory.spot_multi_symbols=true/false：是否允許同時多標的現貨


inventory.spot_hedge_enable=true/false：允許以現貨對沖 FUT（例如多現貨減少多 FUT 尺度）


對沖計：net_delta = FUT_qty * contract_size - SPOT_qty，依 net_delta 調整 S6 管倉目標


錢包劃轉（可選）


treasury.auto_transfer=true/false、min_free_usdt_spot/fut 閾值


由 S4 或 Treasury 子模組呼叫交易所 API SPOT↔FUT 劃轉；寫 treasury_transfers；單人模式可免審


合規/審批（單人簡化）


compliance.enabled=false（預設）；若開啟：large_order_usdt_threshold 以上需 approval_token（Redis approvals:*）


測試策略


OCO 模擬器（對兩腿觸發順序、失敗策略）


Chaos：WS 斷/抖動、REST 超時 → S4/S6 行為驗證（守護停損、重試、熔斷）



2) ArangoDB Collections 索引方案（完整）
命名採 persistent（B 樹），時間清理用 TTL。TTL 需欄位為「秒級 epoch 或 datetime」，建議新增 ts_sec = floor(ts/1000) 寫入。
Collection
主鍵建議
索引（name / type / fields / opts）
用途 & 備註
保留
signals
_key=signal_id
by_t0_sym / persistent / [symbol, t0]；by_rev / persistent / [config_rev, t0]
近窗查詢、重放/模擬
365d
labels_12h/24h/36h
_key=signal_id
by_h / persistent / [horizon_h]
連接 signals 作標籤
365d
orders
_key=order_id
by_client / persistent / [client_order_id] (unique)；by_sym_time / persistent / [symbol, created_at]；ttl / ttl / [created_at_sec], expireAfter=400d
查重/回放/稽核
365d
fills
_key=fill_id
by_order / persistent / [order_id, timestamp]；by_sym_time / persistent / [symbol, timestamp]；ttl / ttl / [timestamp_sec], 400d
TCA、滑價模型
365d
positions_snapshots
_key=auto
by_sym_time / persistent / [symbol, ts]；ttl / ttl / [ts_sec], 200d
管倉回溯
180–200d
holdings_spot_snapshots
_key=auto
by_sym_time / persistent / [symbol, ts]；ttl / ttl / [ts_sec], 200d
WAC/庫存回溯
180–200d
balances_snapshots
_key=auto
by_market_time / persistent / [market, ts]；ttl / ttl / [ts_sec], 120d
餘額審計
90–120d
funding_records
_key=auto
by_sym_time / persistent / [symbol, funding_time]
標籤回填
永久
strategy_events
_key=event_id
by_time / persistent / [ts]；by_kind / persistent / [kind, ts]
追溯
180d
alerts
_key=alert_id
by_time / persistent / [ts]；by_sev / persistent / [severity, ts]
監控
90d
autopsy_reports
_key=trade_id
by_time / persistent / [generated_at]
報告索引
永久
hypotheses
_key=hypothesis_id
by_status / persistent / [status, created_at]
研究流程
永久
experiments
_key=exp_id
by_hypo / persistent / [hypothesis_id, created_at]
回測追溯
永久
strategy_rules
_key=rule_id
by_status / persistent / [status, updated_at]；by_priority / persistent / [priority]
規則掃描
永久
factor_registry
_key=factor_id
by_status / persistent / [status, updated_at]；by_family / persistent / [family, version]
因子依賴
永久
instrument_registry
_key=symbol
by_status / persistent / [status, updated_at]
交易規格
永久
config_bundles
_key=bundle_id
by_rev / persistent / [rev] (unique)；by_status / persistent / [status, created_at]
版本管理
永久
config_active
_key="active"
–
單例
–
promotions
_key=promotion_id
by_bundle / persistent / [bundle_id, activated_at]；by_status / persistent / [status]
發佈流
永久
simulations
_key=sim_id
by_status / persistent / [status, created_at]；by_bundle / persistent / [bundle_id, created_at]
模擬查詢
180d
metrics_timeseries
_key=auto
by_metric / persistent / [metric, ts]；（可分桶）
SLI/SLO
90–180d
cost_curves
_key=curve_id
by_kind_ver / persistent / [kind, version] (unique)
模型版控
永久
approvals（可選）
_key=approval_id
by_status_exp / persistent / [status, expires_at]；ttl / ttl / [expires_at], expireAfter=0
一次性審批
7–30d
treasury_transfers（新增）
_key=transfer_id
by_time / persistent / [created_at]；by_dir / persistent / [from,to,created_at]
劃轉稽核
永久

註：*_sec 欄位為 TTL 需要的秒級時間戳，建議在寫入時同步落地（或由資料管道新增）。

3) Redis Cluster（Key & Streams，與 v3.0 相容，補充細節）
3.1 Key（Hash / String / ZSet / Lock）— 擴充與微調
共通前綴：{env}:{domain}:{entity}:{name}:{HashTag?}，HashTag = {FUT:SYM} / {SPOT:SYM} 以分槽。


增補：


prod:spot:wac:{SPOT:SYM}（Hash）：qty, wac, updated_at（WAC 快取，落 DB 以 holdings_spot_snapshots 為準）


prod:treasury:quota（Hash）：spot_quote_usdt_max, fut_margin_usdt_max, used_spot, used_fut


prod:health:rolling（Hash）：加入 router_e2e_latency_p95, stream_lag_max


prod:router:rate:{FUT:SYM}：新增 submit_err_4xx, submit_err_5xx 計數


prod:delay:ord:{SPOT:SYM}：ZSet（重試）；對 FUT 亦可同名


其餘 Keys 與 v3.0 一致（cfg:* / lock:* / ord:idemp:* / pos:state:* / spot:oco:state:* / wallet:* / risk:usage:* 等），TTL 按 v3.0 建議。
3.2 Streams（家族與 Payload Schema）
全部承襲 v3.0 §5.3（Ticker/Depth/Account/Feature/Signal/OrderCmd/OrderResult/Position/Recon/Label/Cfg/Sim/Alert/Autopsy），補充：
prod:treasury:transfers（事件流；新增）


Payload：


{
  "ts": 1737421112000,
  "from": "SPOT",
  "to": "FUT",
  "amount_usdt": 200.0,
  "reason": "AUTO_TOPUP_FUT",
  "result": "OK"
}


prod:health:events（S11 釋出健康等級變更，供 S3/S4/S6 訂閱）

 { "ts":1737421, "level":"ORANGE", "metrics": { "maker_fill_ratio":0.42, "ib_rate":0.08 } }


Stream 滿長（MAXLEN）：核心流（ord:cmd/result、sig、feat）建議 ≥ 1,000,000；其餘 100,000。
 消費群組：每服務至少一組；DLQ 命名 :dlq；失敗重試指數退避，達上限寫 alerts。

4) 規則 DSL / Lint / Promote（摘要）
DSL 白名單與合成規則：同 v3.0 §2


Lint：Schema/型別/值域、因子存在、服務存在、Dry-run（skip_entry≤60%、size_mult>1≤50%、policy shift≥0.35）


Promote 守門：模擬器差異、敏感度 robustness_score≥0.6、健康 30d 合格；Canary→Ramp→Full；越界自動回滾



5) Observability（SLI/SLO，最小可行集）
SLI
定義
SLO
來源
router_e2e_latency_p95
ord:cmd→ord:result p95
≤1200ms
S11 聚合
order_submit_error_rate
4xx/5xx 比率
≤0.5%
S4
maker_fill_ratio
Maker 成交佔比（6h）
≥0.55
S4
risk_gate_miss_rate
應拒未拒
0
S3
redis_stream_lag_max
消費最大落後
≤200 條
S11
db_write_latency_p95
DB 寫入 p95
≤80ms
S11
ib_rate
資金不足率（SPOT）
≤3%
S4

超標 → 依 失效偵測矩陣（§1.2）自動降級或暫停新倉；一律寫 alerts。

6) 初始化與維運
Init Job：建立全部 Collections（若無則建）與索引（按 §2 表），填 *_sec；建立 Streams & Groups；初始化 config_active、risk:usage、wallet:* 快取。


資料保留：依表所載 TTL/保留期；無 TTL 者由每日 Job 轉冷存（MinIO，可選）再清理。


對帳啟動：S5 先跑 reconcile ALL，再放行 S3/S4/S6。



7) 附：範例片段
7.1 treasury_transfers Collection Schema（新增）
{
  "title":"treasury_transfers","type":"object",
  "properties":{
    "transfer_id":{"type":"string"},
    "from":{"enum":["SPOT","FUT"]},
    "to":{"enum":["SPOT","FUT"]},
    "amount_usdt":{"type":"number"},
    "reason":{"type":"string"},
    "result":{"enum":["OK","FAIL"]},
    "tx_id":{"type":["string","null"]},
    "created_at":{"type":"integer"}
  },
  "required":["transfer_id","from","to","amount_usdt","reason","result","created_at"]
}

索引：by_time / persistent / [created_at]、by_dir / persistent / [from,to,created_at]
7.2 spot:oco:state:{SPOT:SYM}（Hash 內容 JSON）
{
  "parent_id":"12345",
  "tp_id":"12346",
  "sl_id":"12347",
  "status":"ARMED",  // ARMED / ONE_LEG_FILLED / BOTH_CANCELED / FALLBACK_GUARD
  "updated_at":1737421112000
}


8) 實作優先序（建議）
S10（Config/Promote/模擬+敏感度/事件）


S1+S4（連接器 + 下單路由/TWAP/冪等/OCO/守護停損/熔斷）


S3（守門/DSL/模型乘法） + S6（移動停損/加倉/分批止盈/守護停損）


S2（特徵） + S5（對帳）


S7（標籤） + S8（Autopsy v1）


S11/S12（SLI/SLO + 前端）



9) 完整性聲明
本 Spec v3.2 為單一參考標準：
已納入你要求的路由參數 / 失效偵測 / 回測一致性 / Observability與現貨完整擴充；


所有 Collections 的索引已表格化列出（含 TTL/保留）並對應查詢場景；


Redis Cluster Key/Streams 與 Payload Schema 全數落地，對齊服務責任（S1–S12）。


你可以直接以本文件驅動各服務的 API Contract、資料模型、初始化腳本與 CI 驗證（Schema/Lint/索引檢查）。
 需要我把索引建立腳本（AQL）與 Redis 初始化（Lua/Redis-CLI）一併輸出，或產出 OpenAPI/AsyncAPI 契約，我可以馬上給你。

