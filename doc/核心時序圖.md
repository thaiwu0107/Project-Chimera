# 核心時序圖

**實作進度：0/12 服務已完成 (0%)**

## 1) FUT 入場（Maker→Taker 回退、事務狀態機、SL 掛單）❌ **[未實作]**

```mermaid
sequenceDiagram
    autonumber
    title FUT 入場（逐倉 20x；Maker→Taker 回退；事務狀態機；SL 掛單）

    participant S2 as S2 FeatureGen ❌
    participant S3 as S3 Strategy ❌
    participant S4 as S4 OrderRouter ❌
    participant S1 as S1 ExchangeConn ❌
    participant EX as Binance FUT ❌
    participant S6 as S6 PositionMgr ❌
    participant DB as ArangoDB ❌
    participant RS as Redis Streams ❌

    rect rgb(245,245,245)
    note over S2,S3: 觸發：新一筆信號
    S2->>S3: features.ready 事件〔Stream signals:new〕 ❌
    S3->>DB: INSERT signals{features, config_rev, t0} ❌
    S3->>S3: 規則DSL + 置信度 → 決策 & intents(FUT) ❌
    end

    S3->>DB: INSERT strategy_events{ENTRY,PENDING_ENTRY} ❌
    S3->>S4: POST /orders (intent_id 冪等, policy=MakerThenTaker, market=FUT) ❌
    S4->>S1: 下單(限價, passive) + Idempotency-Key ❌
    S1->>EX: NEW_ORDER (LIMIT, postOnly) ❌
    EX-->>S1: ACK NEW / FILL / TIMEOUT ❌

    alt 限價在等待視窗內成交
        S1-->>S4: FILLED + 成交均價/量 ❌
        S4->>DB: UPSERT orders, INSERT fills ❌
    else 等待逾時或流動性不足
        S1-->>S4: 未成或部分成 ❌
        S4->>S1: CANCEL 限價 ❌
        S1->>EX: CANCEL_ORDER ❌
        EX-->>S1: CANCELED ❌
        S4->>S1: NEW_ORDER (MARKET) — Taker 回退/TWAP ❌
        S1-->>S4: FILLED ❌
        S4->>DB: UPSERT orders, INSERT fills (含 slippage_bps) ❌
    end

    S4->>RS: XADD orders:executed {order_id,filled,…} ❌
    S4-->>S3: OrderResult{FILLED} ❌
    S3->>DB: UPDATE strategy_events{ACTIVE} ❌

    note over S6: 新倉成立 → 掛止損(workingType=MARK_PRICE, reduceOnly)
    S6->>S4: POST /orders (STOP_MARKET, reduceOnly=true) ❌
    S4->>S1: PLACE STOP_MARKET ❌
    S1->>EX: STOP_MARKET ❌
    EX-->>S1: ACK ❌
    S4->>DB: UPSERT orders(stop) ❌
    S4->>RS: XADD risk:sl_arm {symbol,sl_px} ❌

    rect rgb(255,248,230)
    note over S4: 失敗/超時重試：沿用同 intent_id；若交易所已受理 → S4回傳既有 OrderID (冪等)
    end
```

### 要點

- ❌ **intent_id 作為冪等鍵**；Maker 等待視窗逾時即回退至 MARKET/TWAP **[S4未實作]**
- ❌ **成功後 S6 立刻「撤舊掛新」或「新掛」STOP_MARKET**（reduceOnly=true, workingType=MARK_PRICE）**[S6未實作]**
- ❌ **事務狀態**：PENDING_ENTRY → ACTIVE，全程寫 strategy_events **[S3未實作]**

## 2) SPOT 入場（OCO / 守護停損 fallback）❌ **[未實作]**

```mermaid
sequenceDiagram
    autonumber
    title SPOT 入場（OCO 優先；不支援時改守護停損 Guard-Stop）

    participant S3 as S3 Strategy ❌
    participant S4 as S4 OrderRouter ❌
    participant S1 as S1 ExchangeConn ❌
    participant EX as Binance Spot ❌
    participant S6 as S6 PositionMgr ❌
    participant DB as ArangoDB ❌
    participant RS as Redis Streams ❌

    S3->>DB: INSERT signals{market=SPOT, ...} ❌
    S3->>S4: POST /orders (intent_id, market=SPOT, execPolicy=OCO, tp_px/sl_px) ❌
    S4->>S1: CREATE_OCO (limit + stopLoss leg) ❌
    alt 交易所支援OCO 且雙腿成功掛單
        S1->>EX: OCO_ORDER ❌
        EX-->>S1: ACK OCO ❌
        S1-->>S4: OCO ACCEPTED ❌
        S4->>DB: UPSERT orders(oco legs) ❌
        S4->>RS: XADD spot:oco:armed {...} ❌
    else 一腿失敗/市場不支援 OCO
        S1-->>S4: REJECTED/UNSUPPORTED ❌
        S4->>S1: MARKET BUY (或 SELL) ❌
        S1-->>S4: FILLED ❌
        S4->>DB: UPSERT orders, INSERT fills ❌
        note over S4: fallback 1：分別掛 TP 與 SL（若支援）
        S4->>S1: PLACE TP / PLACE SL ❌
        S1-->>S4: ACK or ERR ❌
        alt 若仍不支援條件單
            note over S4,S6: fallback 2：啟用「守護停損」（本地監控WS mid-price觸發） 
            S4->>RS: XADD guard:spot:arm {symbol,sl_px} ❌
            S6->>S4: 觸發時 POST /orders (MARKET reduce-only 模擬平倉) ❌
        end
    end

    S4-->>S3: OrderResult{FILLED/ACCEPTED} ❌
    S3->>DB: UPDATE strategy_events{ACTIVE} ❌
```

### 要點

- ❌ **OCO 優先**。若一腿失敗或不支援，回退為：先入場 → 掛單 TP/SL；再不支援 → 守護停損（本地）**[S4未實作]**
- ❌ **守護停損由 S4/或 S6 監控 WS 價格觸發**，落地為 市價反向單；每一步都寫 DB 與 Streams **[S4/S6未實作]**

## 3) 對帳處置（孤兒訂單/倉位、狀態機修復、保守回收）❌ **[未實作]**

```mermaid
sequenceDiagram
    autonumber
    title 對帳處置（孤兒單/倉位；保守回收；狀態機修復）

    participant S12 as S12 WebUI/GW ❌
    participant S5 as S5 Reconciler ❌
    participant S1 as S1 ExchangeConn ❌
    participant EX as Binance (FUT/Spot) ❌
    participant S4 as S4 OrderRouter ❌
    participant DB as ArangoDB ❌
    participant RS as Redis Streams ❌

    S12->>S5: POST /reconcile {mode=ALL} ❌
    par 拉取真相
        S5->>S1: GET openOrders, positions (FUT/Spot) ❌
        S1->>EX: REST 調用 ❌
        EX-->>S1: 現況 ❌
        S1-->>S5: openOrders/positions ❌
    and 讀取本地
        S5->>DB: 查 orders/fills/positions_snapshots (近N天) ❌
    end
    S5->>S5: 差異比對（order對單、倉位聚合） ❌

    alt API 有單 / DB 無單（孤兒）
        note over S5: 判別是否「PENDING_ENTRY 崩潰遺留」可接管
        alt 可接管（可還原）
            S5->>DB: 補寫 orders/position 與 strategy_events{ACTIVE} ❌
        else 不可接管（未知來源）
            S5->>S4: POST /cancel / 或 反向平倉（保守回收） ❌
            S4->>S1: 取消/平倉 ❌
            S1->>EX: CANCEL/ORDER ❌
            EX-->>S1: 回執 ❌
            S4->>DB: 記錄處置結果 ❌
            S5->>DB: strategy_events{ROLLBACK or ORPHAN_CLOSED} ❌
            S5->>RS: XADD alerts{severity=ERROR, msg="orphan closed"} ❌
        end
    else DB 有單 / API 無單（應清理）
        S5->>DB: 清理殘留狀態（標記CLOSED/RECONCILED） ❌
        S5->>RS: XADD strategy:reconciled {...} ❌
    end

    S5-->>S12: ReconcileResponse{summary, fixed, adopted, closed} ❌
```

### 要點

- ❌ **對帳分兩側「交易所真相」vs「DB 記錄」**；孤兒先判定能否「安全接管」，不可接管 → 保守回收（取消/平倉）**[S5未實作]**
- ❌ **全程寫 strategy_events 與 alerts**，回傳摘要供 UI 呈現 **[S5未實作]**

## 附：統一約束（在三張圖都適用）

### 冪等性
- ❌ **下單/劃轉請務必帶 intent_id 或 Idempotency-Key**；重送同鍵由 S4/S1 回同結果 **[S4未實作]**

### 事件流
- ❌ **關鍵狀態變更需推送至對應 Streams**（如 orders:executed, spot:oco:armed, risk:sl_arm 等），以便其他服務（S6/S11/S12）即時消費 **[S1-S3未實作]**

### 狀態機
- ❌ **PENDING_ENTRY → ACTIVE → (PENDING_CLOSING) → CLOSED**，任何異常在對帳重放時能恢復正確狀態 **[S3未實作]**

### 保守回收原則
- ❌ **遇到不可識別或無法接管的殘留/孤兒，優先降低風險**（取消/平倉），並寫審計 **[S5未實作]**

---

## 📊 實作進度總結

### ❌ 全部未實作 (0%)
- **S1 Exchange Connectors**：WebSocket連接、REST API調用、交易所通信
- **S2 Feature Generator**：特徵計算、事件推送
- **S3 Strategy Engine**：決策邏輯、狀態機、事件記錄
- **S4 Order Router**：訂單執行、Maker→Taker回退、TWAP、OCO處理
- **S5 Reconciler**：對帳邏輯、孤兒處置、狀態修復
- **S6 Position Manager**：倉位管理、止損掛單
- **S12 Web UI**：API Gateway、對帳觸發
- **基礎設施**：ArangoDB、Redis Streams

### 🎯 建議優先順序
1. **基礎設施** - ArangoDB、Redis Streams
2. **S1 Exchange Connectors** - 交易所通信基礎
3. **S2 Feature Generator** - 特徵計算
4. **S3 Strategy Engine** - 決策邏輯核心
5. **S4 Order Router** - 訂單執行核心
6. **S5 Reconciler** - 數據一致性保證
7. **S6 Position Manager** - 倉位管理
8. **S12 Web UI** - 用戶界面和API代理

### 🔄 關鍵流程狀態
- **FUT入場流程**：全部未實作
- **SPOT入場流程**：全部未實作  
- **對帳處置流程**：全部未實作