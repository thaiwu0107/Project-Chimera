# 服務與資料流

## 0. 總覽（服務與資料流）

- ❌ **S1 Exchange Connectors**：行情/深度/資金費/帳戶（FUT+SPOT）**[未實作]**
- ❌ **S2 Feature Generator**：特徵計算（ATR/RV/相關性/Depth/Spread…）**[未實作]**
- ❌ **S3 Strategy Engine**：守門 → 規則 DSL → 置信度模型 → 下單意圖 **[未實作]**
- ❌ **S4 Order Router**：FUT/SPOT 下單；Maker→Taker；TWAP；SPOT OCO **[未實作]**
- ❌ **S5 Reconciler**：對帳＋事務狀態機；孤兒倉處置 **[未實作]**
- ❌ **S6 Position Manager**：移動停損、分批止盈、加倉、風控 **[未實作]**
- ❌ **S7 Label Backfill**：12/24/36h 標籤與淨利回寫 **[未實作]**
- ❌ **S8 Autopsy**：交易復盤（TL;DR、TCA、Peer 對比、反事實）**[未實作]**
- ❌ **S9 Hypothesis Orchestrator**：假設→回測/實驗（WF、Purged K-Fold）**[未實作]**
- ❌ **S10 Config Service**：因子/規則/標的版本；模擬器＋敏感度；Promote **[未實作]**
- ❌ **S11 Metrics & Health**：策略/執行/穩定性指標匯總 **[未實作]**
- ❌ **S12 Web UI / API GW**：前端與 API 代理、RBAC、審批 **[未實作]**

**實作進度：0/12 服務已完成 (0%)**

**資料面**：ArangoDB collections（v3 已定義）＋ Redis Cluster keys/Streams（v3 已定義）。
若此文未重複定義 schema，請以你現有 v3 白皮書為準。

## 1. 功能矩陣（Feature → Service → 數學規格）

### 1.1 行情與交易規則快取（Exchange/Rule Cache）❌ **[未實作]**

**服務**：S1

**輸入**：Binance FUT/USDT、SPOT/USDT WS+REST

**輸出**：Redis Streams（`mkt:tick:{symbol}`, `mkt:depth:{symbol}`），ArangoDB instrument_registry

**數學/邏輯**

- ❌ 中間價：`mid_t = (bestBid_t + bestAsk_t)/2`
- ❌ 價差 (bps)：`spread_bps_t = (bestAsk_t - bestBid_t) / mid_t * 1e4`
- ❌ Top1 深度(USDT)：`depth_top1_usdt = min(bidTop1Qty, askTop1Qty) * mid_t`

**定時任務**

- ❌ 每日 exchangeInfo 刷新（合約規則/tickSize/stepSize/leverageBracket）
- ❌ 每 8h 拉取全量 funding rate 歷史快照補缺

### 1.2 特徵工程（ATR / RV / 相關性 / 深度）❌ **[未實作]**

**服務**：S2

**輸入**：K線、深度、資金費、匯流（皆由 S1）

**輸出**：signals.features（ArangoDB）、Redis feat:last:{symbol}

**數學/邏輯**

- ❌ True Range：`TR_t = max(H_t - L_t, |H_t - C_{t-1}|, |L_t - C_{t-1}|)`
- ❌ ATR(n)（Wilder）：`ATR_t = ATR_{t-1} + (TR_t - ATR_{t-1})/n`
- ❌ log return：`r_t = ln(P_t / P_{t-1})`
- ❌ 實現波動率（期間 m）：`rv_m = sqrt(252) * std(r_{t-m+1..t})`
- ❌ rv 分位：`rv_pctile_30d = pctile(rv_1d, lookback=365d)`
- ❌ USDT/TWD×BTC 相關性（k 日）：`rho_usdttwd_k = corr(r_btc, r_fx, window=k)`
- ❌ 深度因子：`liq_score = min(depth_top1_usdt / threshold, 1.0)`

**定時任務**

- ❌ 每 1m/5m/1h/4h/1d 滾動計算；掉線補算任務（補 K 線缺口）

### 1.3 入場守門（L0 Gate）❌ **[未實作]**

**服務**：S3

**輸入**：signals.features、instrument_registry、risk.budget.*（S10 flags）

**邏輯**

- ❌ 資金費上限：`|funding_next| <= max_funding_abs`
- ❌ 流動性下限：`spread_bps <= spread_bp_limit` 且 `depth_top1_usdt >= min`
- ❌ 風險預算：`Σ spot_notional <= risk.budget.spot_quote_usdt_max`、`Σ fut_margin <= risk.budget.fut_margin_usdt_max`、`concurrent_entries_per_market` 不超
- ❌ 不過門 → `decision.action = "skip"`

**排程**：即時計算（S12 /decide 或 S3 事件驅動）

### 1.4 規則 DSL（L1 Rules）❌ **[未實作]**

**服務**：S3（規則解譯），S10（規則治理/Lint/Promote）

**邏輯**（白名單已定）

- ❌ 命中多條 → `size_mult/tp_mult/sl_mult` 相乘後 clamp 至白名單
- ❌ `skip_entry=true` → 短路

**排程**：S3 實時計算；S10 變更事件廣播（RCU 熱載）

### 1.5 置信度模型（L2 ML Score）❌ **[未實作]**

**服務**：S3（線上推論），S9（離線訓練/驗證）

**數學**

- ❌ 監督式（Logistic/XGBoost）：輸入特徵 X，輸出 `p = P(win | X)`
- ❌ 倉位倍率：`size_mult_ml = piecewise(p)`（>0.85 → ×1.2；0.6–0.85 → ×1.0；0.4–0.6 → ×0.5；<0.4 → skip）
- ❌ 最終 `size_mult = size_mult_rules × size_mult_ml`（clamp）

**排程**：S9 每月重新訓練；S3 熱載模型（版本標記）

### 1.6 FUT 下單意圖與倉位 sizing ❌ **[未實作]**

**服務**：S3（產生 intent），S4（執行）

**數學**

- ❌ 保證金：`margin_base = 20 USDT`；`margin = margin_base × size_mult`
- ❌ 名義倉位：`notional = margin × leverage`
- ❌ 數量（合約）：`qty = round_to_step( notional / price, stepSize )`
- ❌ 停損距離：`d_atr = ATR_mult × ATR`；`d_losscap = (max_loss_usdt) / qty`；`d = min(d_atr, d_losscap)`
- ❌ SL 價：多單 `SL = entry - d`；空單 `SL = entry + d`
- ❌ TP（淨利≥10%）：`target_pnl = 0.10 × (Σ margins)` ⇒ 對應 target_price 反解

**排程**：下單即時計算；加倉後重算

### 1.7 SPOT 入場 + OCO（TP/SL）❌ **[未實作]**

**服務**：S3（intent with exec_policy=OCO）、S4（OCO 兩腿/守護停損備援）

**數學**

- ❌ 數量：`qty = floor_to_step( quote_budget / price, stepSize )`
- ❌ TP/SL：相對平均成本 avg_cost 設置 `tp_price > avg_cost`、`sl_price < avg_cost`（BUY，SELL 反向）
- ❌ OCO 邏輯：一腿成交即自動取消另一腿；交易所不支援則由 S4 客戶端守護

**排程**：即時

### 1.8 智能執行（Maker→Taker、TWAP、流動性探測）❌ **[未實作]**

**服務**：S4

**數學/流程**

- ❌ Maker 等待：`wait_ms = f(notional)`（路由策略表）；若 `fill_ratio < θ` → 撤單改 Taker
- ❌ TWAP：N 片，間隔 Δt，每片 `qty_i = qty_total/N`；可加入抖動 `U(-ε, ε)`
- ❌ 滑價估計：`slip_bps = (VWAP - mid_at_send)/mid_at_send * 1e4`
- ❌ 流動性探測：下單前讀 depth、spread_bps；若 `spread_bps > 2×1h_mean` → 延時 5s 或拆單

**定時任務**：路由策略表每日滾動更新（基於 TCA 統計）

### 1.9 倉位管理（移動停損、分批止盈、加倉）❌ **[未實作]**

**服務**：S6

**數學**

- ❌ ROE：`roe = unRealizedProfit / isolatedWallet`
- ❌ 加倉規則：`add_on_count < 2` 且 `roe ≥ {5%,10%}` 分階；加倉後重算 avg_entry
- ❌ 移動停損：達 10% → `SL=breakeven`；達 20% → `SL=price_for_net(10%)`
- ❌ 分批止盈：`roe ≥ 12%` → 平掉 `entry_quantities[0]`

**排程**：輪巡 5–10s；事件驅動（行情觸發）優先

### 1.10 對帳與事務狀態機 ❌ **[未實作]**

**服務**：S5

**狀態**：`PENDING_ENTRY → ACTIVE → PENDING_CLOSING → CLOSED`

**演算法**

- ❌ 啟動或定時比對：`positionRisk + openOrders` vs DB
- ❌ 孤兒單：API 有、DB 無 → 依 `orphan_policy`：`RECLAIM_IF_SAFE`（接管）或 `CONSERVATIVE`（平倉退出）

**排程**：啟動必跑；每 5 分鐘；異常（告警）即時觸發

### 1.11 標籤回填（12/24/36h 淨利）❌ **[未實作]**

**服務**：S7

**數學**

- ❌ 實現/未實現 PnL：用 fills（含 fee）與 positions_snapshots
- ❌ Funding（FUT）：累加結算期間的 amount_usdt
- ❌ 淨利：`net_pnl = realized + unrealized - fees - funding`
- ❌ ROI：`net_roi = net_pnl / (Σ margin or Σ spot_cost)`
- ❌ 標籤：pos/neg/neutral by ROI 閾值（例：≥+0.5% / ≤-0.5%）

**排程**：每小時掃描 `t0+{12,24,36}h` 到期樣本

### 1.12 復盤（Autopsy：TCA/Peer/反事實/敘事）❌ **[未實作]**

**服務**：S8

**數學**

- ❌ TCA 滑價：同 1.8；費用佔比 `cost_share = (fees+funding)/gross_pnl`
- ❌ Peer 對比：分組（方向/Regime/size bucket）；計算百分位（winrate/ROI/持倉時間）
- ❌ 反事實：將 tp/sl/size 替換為 ±Δ，重放路徑估計 ΔROI
- ❌ 敘事：由規則命中 + SHAP（若有 ML）轉自然語句

**排程**：交易關閉即觸發；或手動重建

### 1.13 假設與實驗（研究）❌ **[未實作]**

**服務**：S9

**數學**

- ❌ Walk-Forward：滾動窗訓練→前推驗證
- ❌ Purged K-Fold：避免資訊洩漏
- ❌ 統計檢定：p-value、FDR 控制

**排程**：每週/每月批次

### 1.14 配置中心（模擬器＋敏感度＋Promote）❌ **[未實作]**

**服務**：S10

**數學**

- ❌ 差異估計：重放最近 N 天 signals → `Δ(trades, size_mult>1, skip率)`
- ❌ 敏感度：對關鍵特徵施加 ±ε 擾動，量測 flip rate 與 boundary margin
- ❌ 守門：MaxDD、AUC/Brier 滾動健康度 ≥ 閾值

**排程**：手動發起；Promote Canary 期間持續監測

### 1.15 指標彙整與健康（Observability）❌ **[未實作]**

**服務**：S11

**數學**（核心 SLI）

- ❌ 路由 P95 延遲：下單→回執
- ❌ 風險守門誤差：實際 spread/depth 相對門檻超界率
- ❌ Redis Stream Lag：`consumer_lag = last_produced_id - last_ack_id`
- ❌ 策略績效：PF, Sharpe, WinRate, MaxDD

**排程**：每 1m 聚合；每日匯總

### 1.16 Web UI / API 代理 ❌ **[未實作]**

**服務**：S12

**功能**：表單/儀表板；代理其他服務 API；RBAC；OpenAPI 驗證中介層

**排程**：N/A

### 1.17 錢包劃轉（SPOT ↔ FUT）❌ **[未實作]**

**服務**：S4（執行），S6（觸發/需求）、S5（對帳）

**邏輯**

- ❌ 觸發：`insufficient_balance` 或 `risk.budget` 需要
- ❌ 守門：上限/最小留存額
- ❌ 記帳：TransferRequest/Response 事件寫入 strategy_events

**排程**：事件驅動；每日對帳

## 2. 需要的定時任務（Cron / Scheduler）

| 服務 | 任務 | 週期 | 要點 | 狀態 |
|------|------|------|------|------|
| S1 | exchangeInfo 刷新 | 24h | tick/step/leverage bracket 更新 | ❌ 未實作 |
| S1 | funding 歷史補缺 | 8h | 補寫 funding_records | ❌ 未實作 |
| S2 | 特徵補算（缺口） | 5m | 針對缺 K 線段回填 | ❌ 未實作 |
| S3 | 配置保活/熱載驗證 | 1m | config_active.rev 校對、過期回退 | ❌ 未實作 |
| S4 | 路由表再訓練（規則） | 24h | 依 TCA 重新估參 | ❌ 未實作 |
| S5 | 自動對帳 | 5m | orphan/fix 報告與動作 | ❌ 未實作 |
| S6 | 倉位巡檢 | 10s | ROE 門檻、SL/TP 移動 | ❌ 未實作 |
| S7 | 標籤回填 | 1h | 到期樣本計算 ROI | ❌ 未實作 |
| S8 | Autopsy 重建 | 1d | 缺圖/缺段修復 | ❌ 未實作 |
| S9 | 模型重訓 | 30d | AUC/Brier 劣化提前觸發 | ❌ 未實作 |
| S10 | Canary 守門評估 | 10m | MaxDD/AUC guardrails | ❌ 未實作 |
| S11 | SLI/SLO 彙整 | 1m/1d | 即時+日彙總 | ❌ 未實作 |
| S12 | N/A | – | – | – |

## 3. 重要公式與伺服器歸屬（快查）

### ATR(n)：S2 ❌ **[未實作]**
```
TR_t = max(H-L, |H-C_{t-1}|, |L-C_{t-1}|)
ATR_t = ATR_{t-1} + (TR_t - ATR_{t-1})/n
```

### Realized Vol.：S2 ❌ **[未實作]**
```
rv_m = sqrt(252) * std(ln P_t/P_{t-1})
```

### 相關性：S2 ❌ **[未實作]**
```
rho = corr(Δln P_btc, Δln FX, window=k)
```

### FUT sizing：S3 ❌ **[未實作]**
```
notional = margin × leverage；qty = notional/price
```

### SL/TP 價：S3/S6 ❌ **[未實作]**
```
d = min(ATR_mult×ATR, max_loss_usdt/qty)；SL = entry ± d
target_pnl = 0.1 × Σ margins → 反解 target_price
```

### ROE：S6 ❌ **[未實作]**
```
roe = uPnL / isolatedWallet
```

### 滑價：S4/S8 ❌ **[未實作]**
```
slip_bps = (VWAP - mid_at_send)/mid_at_send * 1e4
```

### 標籤 ROI：S7 ❌ **[未實作]**
```
net_roi = (realized + unrealized - fees - funding) / capital_base
```

### 敏感度 Flip 率：S10 ❌ **[未實作]**
```
flip_pct = #(decision changed) / #(evaluated)
```

## 4. 互動面（誰呼叫誰，做什麼）

### 外部呼叫
- ❌ **S12 → S3** `/decide`：前端試算/下單前決策（dry_run 可）**[未實作]**
- ❌ **S12 → S4** `/orders|/cancel`：實際 FUT/SPOT 下單、OCO、撤單 **[未實作]**
- ❌ **S12 → S6** `/positions/manage`：手動觸發 trailing/partial **[未實作]**
- ❌ **S12 → S7** `/labels/backfill`：資料科學重算窗口 **[未實作]**
- ❌ **S12 → S8** `/autopsy/{trade_id}`：復盤生成/重建 **[未實作]**
- ❌ **S12 → S9** `/experiments/run`：研究實驗 **[未實作]**
- ❌ **S12 → S10** `/bundles|/simulate|/promote`：配置治理 **[未實作]**
- ❌ **S12 → S11** `/metrics|/alerts`：監控頁資料 **[未實作]**

### 內部呼叫
- ❌ **S3 → S4**：intent → order(s) **[未實作]**
- ❌ **S4 → S6**：新倉/加倉回報 → 更新倉位管理 **[未實作]**
- ❌ **S5 ↔ S4/S6**：對帳期間補單/撤單/接管 **[未實作]**
- ❌ **S10 → ALL**：config events（RCU 熱載）**[未實作]**

## 5. 失效偵測門檻（S11 產生、S3/S4/S6 使用）❌ **[未實作]**

- ❌ `maker_fill_ratio`（近 1h） < `θ_maker`（例 0.25）→ S4 降級為 Market
- ❌ `insufficient_balance_rate`（近 1d） > `θ_ib`（例 0.1）→ 啟用自動降額或排隊重試
- ❌ AUC/Brier（滾動 100 筆） 低於門檻 → S10 禁止 Promote / 觸發 Canary 回滾
- ❌ 路由延遲 P95 超SLO（例 500ms）→ 降級（禁 TWAP/Maker）

## 6. 路由策略參數表（供 S4 使用，日更）❌ **[未實作]**

以名目金額 bucket 選取策略；工程以 YAML/JSON 配置，S10 管理版本。

| 名目區間（USDT） | Maker 等待 ms | TWAP 切片 | slice 間隔 ms |
|------------------|----------------|-----------|---------------|
| 0 – 200 | 1500 | 1 | – |
| 200 – 500 | 2000 | 2 | 600 |
| 500 – 1000 | 2500 | 3 | 800 |
| 1000+ | 3000 | 4 | 1000 |

## 7. 觀測性（SLI/SLO）與告警（S11）❌ **[未實作]**

**SLI**：路由 P95、守門誤差率、Stream Lag、WS 掉線率、寫入延遲、MaxDD

**SLO**（示例）：路由 P95 ≤ 500ms；Stream Lag ≤ 2s；WS 可用率 ≥ 99.5%

**告警**：SLO 連續 3 個窗口違反；守門越界；Canary guardrail 觸發

## 8. 排程與資料依賴關係圖（文字版）

```
S1→S2（行情/深度）→S3（決策）→S4（下單）→S6（管理）
S4/S6→S7（標籤）→S8（復盤）→S9（研究）→S10（配置優化）
S11 橫向匯總指標；S5 週期對帳維持一致性
```

**實作狀態**：
- ❌ S1→S2→S3：未實作
- ❌ S3→S4→S6：未實作
- ❌ S4/S6→S7→S8→S9→S10：未實作
- ❌ S11 橫向匯總：未實作
- ❌ S5 週期對帳：未實作

## 9. 工程交付要點

- ❌ **各服務必備**：`GET /health`（依賴樹狀回報）**[S1-S3未實作]**
- ❌ **中介層驗證**：S12 對所有 API 做 OpenAPI schema 驗證 **[未實作]**
- ❌ **事件冪等**：下單/撤單/對帳均以 `intent_id/client_order_id` 控制 **[未實作]**
- ❌ **配置熱載**：RCU；進行中決策用舊版完成，下一筆切新版；每筆 `signals.config_rev` 追蹤 **[S3未實作]**

---

## 📊 實作進度總結

### ❌ 全部未實作 (0%)
- **S1-S12**：所有服務均未實作

### ❌ 待實作 (100%)
- **S1-S12**：所有服務均待實作

### 🎯 建議優先順序
1. **S4 Order Router** - 訂單執行
2. **S5 Reconciler** - 數據對帳
3. **S6 Position Manager** - 倉位管理
4. **S12 Web UI** - 用戶界面
5. **S11 Metrics** - 監控系統