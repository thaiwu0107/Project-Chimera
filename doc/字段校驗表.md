# 字段校驗表（Validation Matrix）

**實作進度：0/12 服務已完成 (0%)**

## 1. 共用型別（components）

### A) Intent（下單意圖）❌ **[S3未實作]**

| 欄位 | 型別 | 必填 | 範圍/枚舉 | 預設 | 校驗與關聯 | 實作狀態 |
|------|------|------|-----------|------|-----------|----------|
| `intent_id` | string | Y | UUID/字串長度 1–128 | – | 作為冪等鍵；全局唯一（短期） | ❌ 未實作 |
| `market` | string | Y | FUT \| SPOT | – | 決定可用欄位（如 leverage/isolated 僅 FUT） | ❌ 未實作 |
| `symbol` | string | Y | 正則 `^[A-Z0-9]{3,}$` | – | 必須存在於 instrument_registry 且 ENABLED | ❌ 未實作 |
| `side` | string | Y | BUY \| SELL | – | – | ❌ 未實作 |
| `qty` | number | Y | > 0；步長 = instrument.stepSize | – | 若 FUT → 口數換算；若 SPOT → 金額 ≥ minNotional | ❌ 未實作 |
| `type` | string | N | MARKET \| LIMIT \| STOP_MARKET | – | STOP_* 需搭配 stop_price | ❌ 未實作 |
| `price` | number | N | > 0；tick = instrument.tickSize | – | 僅 LIMIT/TP leg | ❌ 未實作 |
| `stop_price` | number | N | > 0 | – | 僅 STOP_MARKET/SL leg | ❌ 未實作 |
| `working_type` | string | N | MARK_PRICE \| CONTRACT_PRICE | MARK_PRICE | FUT 止損建議 MARK_PRICE | ❌ 未實作 |
| `reduce_only` | boolean | N | – | false | FUT 平倉/SL/TP 務必 true | ❌ 未實作 |
| `leverage` | integer | C(FUT) | 1–125 | 20 | 僅 FUT；需符合交易所限制 | ❌ 未實作 |
| `isolated` | boolean | C(FUT) | – | true | 僅 FUT；逐倉/全倉 | ❌ 未實作 |
| `exec_policy` | string | N | MakerThenTaker \| Market \| OCO \| LimitOnly | MakerThenTaker(FUT)/OCO(SPOT) | 決定 S4 行為 | ❌ 未實作 |
| `post_only_wait_ms` | integer | N | 0–10000 | 3000 | MakerThenTaker 等待視窗 | ❌ 未實作 |
| `twap.enabled` | boolean | N | – | false | – | ❌ 未實作 |
| `twap.slices` | integer | C(twap) | 1–10 | 3 | – | ❌ 未實作 |
| `twap.interval_ms` | integer | C(twap) | 200–5000 | 800 | – | ❌ 未實作 |
| `oco.tp_price` | number | C(exec=OCO) | > 0 | – | SPOT 首選；需與 side 合理（BUY → tp > entry） | ❌ 未實作 |
| `oco.sl_price` | number | C(exec=OCO) | > 0 | – | BUY → sl < entry；SELL 反向 | ❌ 未實作 |
| `oco.leg_time_in_force` | string | N | GTC\|IOC | GTC | – | ❌ 未實作 |
| `client_tags` | string[] | N | 每個長度 ≤ 32；最多 10 | – | 記錄策略上下文 | ❌ 未實作 |

> **C = Conditional（條件必填）**

### B) OrderResult ❌ **[S4未實作]**

| 欄位 | 型別 | 必填 | 範圍/枚舉 | 說明 | 實作狀態 |
|------|------|------|-----------|------|----------|
| `status` | string | Y | NEW\|FILLED\|PARTIALLY_FILLED\|ACCEPTED\|CANCELED\|REJECTED | – | ❌ 未實作 |
| `order_id` | string | N | – | OCO 可能回 group/legs | ❌ 未實作 |
| `avg_price` | number | N | > 0 | FILLED 才有 | ❌ 未實作 |
| `filled_qty` | number | N | >= 0 | – | ❌ 未實作 |
| `fills` | array | N | – | 明細；含 price/qty/fee/slippage_bps | ❌ 未實作 |
| `slippage_bps` | number | N | >= 0 | – | ❌ 未實作 |
| `legs` | array | N | – | OCO 雙腿回傳 | ❌ 未實作 |

### C) CancelRequest ❌ **[S4未實作]**

| 欄位 | 型別 | 必填 | 範圍/枚舉 | 校驗 | 實作狀態 |
|------|------|------|-----------|------|----------|
| `order_id` | string | XOR | – | order_id 與 client_order_id 擇一 | ❌ 未實作 |
| `client_order_id` | string | XOR | – | – | ❌ 未實作 |
| `cascade_oco` | boolean | N | – | 預設 true | ❌ 未實作 |
| `reason` | string | N | 枚舉字串 | 寫入審計 | ❌ 未實作 |

### D) ReconcileRequest ❌ **[S5未實作]**

| 欄位 | 型別 | 必填 | 範圍/枚舉 | 預設 | 實作狀態 |
|------|------|------|-----------|------|----------|
| `mode` | string | Y | ALL\|ORDERS\|POSITIONS | ALL | ❌ 未實作 |
| `dry_run` | boolean | N | – | false | ❌ 未實作 |
| `orphan_policy` | string | N | RECLAIM_IF_SAFE\|CONSERVATIVE | CONSERVATIVE | ❌ 未實作 |
| `time_window_h` | int | N | 1–168 | 72 | ❌ 未實作 |

### E) 其他請求摘要

> （只列與校驗相關的字段；其餘見 OpenAPI）

- ❌ **`/features/recompute`**：`symbols[]`(≥1)、`windows[]`(值域受限：1m/5m/1h/4h/1d)、`force`(bool) **[S2未實作]**
- ❌ **`/decide`**：`symbol`、`config_rev`(CURRENT 或整數)、`dry_run`(bool) **[S3未實作]**
- ❌ **`/positions/manage`**：`symbols[]`、`actions[]`(TRAIL_SL,PARTIAL_TP,ADD_IF_OK) **[S6未實作]**
- ❌ **`/labels/backfill`**：`horizon_h` 枚舉 {12,24,36}；`from_ts`≤`to_ts` **[S7未實作]**
- ❌ **`/autopsy/{trade_id}`**：path 必填；可選 `force_rebuild` **[S8未實作]**
- ❌ **`/experiments/run`**：`hypothesis_id` \| `design`（二擇一必填）；design 裡需指定回測窗、資金曲線指標 **[S9未實作]**
- ❌ **`/bundles`**：`bundle_id`、`rev` 整數遞增、`factors[]`/`rules[]`/`instruments[]` 非空；`status`=DRAFT **[S10未實作]**
- ❌ **`/simulate`**：`bundle_id`、`window`{from,to} RFC3339；`sensitivity.epsilon` ∈ (0,0.2]；`n_eval` ≤ 5000 **[S10未實作]**
- ❌ **`/promote`**：`to_rev`>現行；`mode` in {CANARY,RAMP,FULL,ROLLBACK}；Canary 需 `traffic_pct`∈[1,50]、`duration_h`∈[24,336] **[S10未實作]**
- ❌ **`/metrics`**：`metric` 枚舉；`from_ts`/`to_ts` 範圍 1–90 天 **[S11未實作]**
- ❌ **`/alerts`**：支援 `severity`, `source`, `from_ts`, `limit`<=1000 **[S11未實作]**

## 2. 契約測試清單（Contract Tests）

### 2.1 `/orders`（S12→S4）❌ **[未實作]**

#### Happy Path

- ❌ **FUT MakerThenTaker**：限價 3s 內成交 → `status`=FILLED、`reduce_only`=false、`fills`/`avg_price` 正確
- ❌ **FUT 止損**：STOP_MARKET + `working_type`=MARK_PRICE + `reduce_only`=true → `status`=ACCEPTED
- ❌ **SPOT OCO**：雙腿掛單成功 → `status`=ACCEPTED、`legs` 各有 order_id

#### Edge Cases & Failures

- ❌ **Idempotency**：相同 `intent_id` 重送 → 應返回相同結果
- ❌ **量價校驗**：`qty` < stepSize、或 `price` 非 tickSize 整數倍 → 400
- ❌ **minNotional 未達** → 422 MIN_NOTIONAL
- ❌ **OCO 一腿失敗** → fallback 生效（MARKET 先入場→再掛 TP/SL 或守護停損）；流程事件完整
- ❌ **FUT 止損無 stop_price** → 400
- ❌ **FUT reduce_only=true + 新倉** → 422
- ❌ **市場流動性不足** → Maker 超時回退 Taker；`slippage_bps` 記錄>0

### 2.2 `/cancel`（S12→S4）❌ **[未實作]**

- ❌ **以 order_id 撤 OCO leg**：`cascade_oco`=true 兩腿皆撤
- ❌ **不存在的單** → 404
- ❌ **已成交** → 409
- ❌ **Idempotency**：重複撤單 → 200 + 同結果

### 2.3 `/reconcile`（S12→S5）❌ **[未實作]**

- ❌ **dry_run=true**：僅回報差異，不做修改
- ❌ **孤兒可接管** → `action`=ADOPTED 並補寫 DB
- ❌ **孤兒不可接管** → `action`=CLOSED（取消/反向平倉）並寫 alerts
- ❌ **mode=ORDERS** 僅核對訂單

### 2.4 `/features/recompute`（S12→S2）❌ **[未實作]**

- ❌ **合法 symbol/window** → `accepted`=true
- ❌ **未知 window** → 400
- ❌ **symbols 為空** → 400

### 2.5 `/decide`（S12→S3）❌ **[未實作]**

- ❌ **dry_run=true**：返回 decision + intent，不落單
- ❌ **config_rev=CURRENT** 與顯式 rev 結果一致（當前活躍）
- ❌ **特徵缺失** → 422（需先重算）

### 2.6 `/positions/manage`（S12→S6）❌ **[未實作]**

- ❌ **TRAIL_SL** 在利潤達標時「撤舊掛新」
- ❌ **PARTIAL_TP** 出現 reduce_only 對沖
- ❌ **無倉位** → `managed`=[]

### 2.7 `/labels/backfill`（S12→S7）❌ **[未實作]**

- ❌ **horizon=12/24/36** → 計算 PnL + funding + fee 淨值
- ❌ **signals 覆蓋缺失** → 部分成功，`errors[]` 記錄

### 2.8 `/autopsy/{trade_id}`（S12→S8）❌ **[未實作]**

- ❌ **有完整 fills/funding/metrics** → 生成報告（TL;DR、圖表摘要欄位不為空）
- ❌ **缺必備資料** → 422 + 欠缺原因

### 2.9 `/experiments/run`（S12→S9）❌ **[未實作]**

- ❌ **hypothesis_id 合法** → 排程成功 `status`=QUEUED
- ❌ **design 缺回測窗** → 400
- ❌ **異常參數** → 422（由 S9 驗證）

### 2.10 `/bundles`（S12→S10）❌ **[未實作]**

- ❌ **DRAFT upsert** → `lint.passed`=true
- ❌ **引用未註冊 factor/rule** → 422 + lint errors

### 2.11 `/simulate`（S12→S10）❌ **[未實作]**

- ❌ **正常** → 回 `summary`/`approx_effect`/`sensitivity_analysis`
- ❌ **epsilon 超界** → 400
- ❌ **window 無數據** → 204 或 `summary.trades_ref`=0

### 2.12 `/promote`（S12→S10）❌ **[未實作]**

- ❌ **CANARY**：traffic/duration 合法 → PENDING
- ❌ **Guardrail 事前不達標**（健康度/AUC）→ 422
- ❌ **ROLLBACK** → `status`=ROLLED_BACK 並廣播事件

### 2.13 `/metrics`, `/alerts`（S12→S11）❌ **[未實作]**

- ❌ **指標存在** → 200 + 時序資料
- ❌ **超期/窗口過大** → 400
- ❌ **limit>1000** → 400

### 2.14 `/health` ❌ **[S1-S3未實作]**

- ❌ **正常** → `{status:"UP", deps:{redis:"UP", db:"UP", s4:"UP"...}}`
- ❌ **模擬某上游 5xx** → `status:"DEGRADED"`，並列出故障依賴

## 3. 校驗規則總結

### 3.1 必填字段驗證

- ❌ **Intent 核心字段**：`intent_id`, `market`, `symbol`, `side`, `qty` **[S3未實作]**
- ❌ **條件必填**：FUT 需要 `leverage`, `isolated`；OCO 需要 `oco.tp_price`, `oco.sl_price` **[S3未實作]**
- ❌ **路徑參數**：`trade_id` 在 autopsy 端點必須提供 **[S8未實作]**

### 3.2 數據範圍驗證

- ❌ **數值範圍**：`qty` > 0, `price` > 0, `leverage` 1-125 **[S3未實作]**
- ❌ **枚舉值**：`market` ∈ {FUT, SPOT}, `side` ∈ {BUY, SELL} **[S3未實作]**
- ❌ **時間窗口**：`time_window_h` 1-168, `from_ts` ≤ `to_ts` **[S5未實作]**

### 3.3 業務邏輯驗證

- ❌ **價格關係**：BUY 時 tp > entry > sl；SELL 時反向 **[S3未實作]**
- ❌ **訂單類型**：STOP_MARKET 需要 `stop_price` **[S3未實作]**
- ❌ **冪等性**：相同 `intent_id` 返回相同結果 **[S4未實作]**

### 3.4 錯誤處理

- ❌ **400 Bad Request**：參數格式錯誤、範圍超界 **[S2-S3未實作]**
- ❌ **422 Unprocessable Entity**：業務規則違反、數據不完整 **[S2-S3未實作]**
- ❌ **404 Not Found**：資源不存在 **[S4-S12未實作]**
- ❌ **409 Conflict**：狀態衝突（如已成交訂單）**[S4-S12未實作]**

## 4. 測試建議

### 4.1 單元測試

- ❌ **每個字段的邊界值測試** **[S2-S3未實作]**
- ❌ **枚舉值的有效性測試** **[S2-S3未實作]**
- ❌ **條件必填字段的邏輯測試** **[S2-S3未實作]**

### 4.2 集成測試

- ❌ **完整的 API 流程測試** **[S2-S3未實作]**
- ❌ **錯誤場景的處理測試** **[S2-S3未實作]**
- ❌ **冪等性的一致性測試** **[S4-S12未實作]**

### 4.3 契約測試

- ❌ **服務間接口的兼容性測試** **[S2-S3未實作]**
- ❌ **版本升級的向後兼容性測試** **[S4-S12未實作]**
- ❌ **性能邊界的壓力測試** **[S4-S12未實作]**

---

## 📊 實作進度總結

### ❌ 全部未實作 (0%)
- **S1-S12**：所有服務均未實作

### ❌ 待實作 (100%)
- **S1-S12**：所有服務均待實作

### 🎯 建議優先順序
1. **S4 Order Router** - 訂單執行核心校驗
2. **S5 Reconciler** - 數據一致性校驗
3. **S6 Position Manager** - 倉位管理校驗
4. **S12 Web UI** - API Gateway校驗
5. **S11 Metrics** - 監控系統校驗

這份校驗表提供了完整的字段驗證規範，確保 API 的數據完整性和業務邏輯正確性。